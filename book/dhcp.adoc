= DHCP
:experimental:
:icons: font

* Menu:Configuration guides[IP Addressing > http://www.cisco.com/c/en/us/td/docs/ios-xml/ios/ipaddr_dhcp/configuration/15-mt/dhcp-15-mt-book/dhcp-overview.html[DHCP] ]



== Overview

* Https://tools.ietf.org/html/rfc2131[RFC 2131]

- Dynamic Host Configuration Protocol
- Based on BOOTP
- Client/agent relay/server model
- UDP port 67

.DHCP request for an IP address from a DHCP Server
image::images/dhcp-request.png[DHCP request for an IP address from a DHCP Server]

== Protocol operations

.DHCP message
["packetdiag", target="dhcp-message-format.png"]
----
diagram {
  colwidth = 32
  node_height = 32
  default_node_color = lightyellow
  default_fontsize = 12

  * op [len = 8]
  * htype [len= 8]
  * hlen [len = 8]
  * hops [len = 8]
  * xid [len = 32]
  * secs [len = 16]
  * flags [len = 16]
  * ciaddr [len = 32]
  * yiaddr [len = 32]
  * giaddr [len = 32]
  * chaddr [len = 32]
  * sname (8 octets)  [len = 32]
  * file (16 octets) [len = 32]
  * options (variable) [len = 32, stacked]
}
----

[cols="10,^10,90", options="header"]
|====
| FIELD   | OCTETS | DESCRIPTION
| op      | 1      | Message op code / message type.   1 = BOOTREQUEST, 2 = BOOTREPLY
| htype   | 1      | Hardware address type
| hlen    | 1      | Hardware address length
| hops    | 1      | Client sets to zero, optionally used by relay agents when booting via a relay agent.
| xid     | 4      | Transaction ID, a random number chosen by the client, used by the client and server to associate messages and responses between a client and a server.
| secs    | 2      | Filled in by client, seconds elapsed since client began address acquisition or renewal process.
| flags   | 2      | Flags
| ciaddr  | 4      | Client IP address; only filled in if client is in BOUND, RENEW or REBINDING state and can respond to ARP requests.
| yiaddr  | 4      | 'your' (client) IP address.
| siaddr  | 4      | IP address of next server to use in bootstrap returned in DHCPOFFER, DHCPACK by server.
| giaddr  | 4      | Relay agent IP address, used in booting via a relay agent.
| chaddr  | 16     | Client hardware address.
| sname   | 64     | Optional server host name, null terminated string.
| file    | 128    | Boot file name, null terminated string; "generic" name or null in DHCPDISCOVER, fully qualified directory-path name in DHCPOFFER.
| options | var    | Optional parameters field.
|====

== DHCP Server

- Accepts address assignment requests and renewals from clients
- Assign address, name server, gateways, ...
- Accepts broadcasts from local clients or relay agents
- Database as a tree used for attribute inheritance
** Root: address pool for natural networks 
** Branches: subnetwork address pools
** Leaves: manual bindings

.Task: Clear DHCP server variables
----
clear ip dhcp binding { <address> | * }
clear ip dhcp conflict { <address> | * }
clear ip dhcp server statistics 
----

.Task: Troubleshoot DHCP IP address assignments, lease expirations, and database chnages
----
# debug ip dhcp server events
----

=== Database agent

- Host (ftp, tftp, rcp) or storage that stores the DHCP bindings database.

.Task: Save automatic bindings on a remote host 
----
ip dhcp database <url> [timeout <seconds>] [ write-dely <seconds>]
----

[NOTE]
=====
- *url*: can be ftp,tftp, rcp, flash, disk
- *timeout*: how long the DHCP server wait before aborting database transfer. default: 5 minutes
- *write-delay*: how soon the DHCP server should send database updates. default:  5 minutes, minimum: 60 seconds
=====

.Task: Run DHCP server without database agent 
----
(config)# no ip dhcp conflict logging
----

[NOTE]
====
- Not recommended 
- TODO: add the reason
====

=== Address Pool

- Specify which DHCP options to use for the client
** If the client is not directly connected to the DHCP server (the giaddr field of the DHCPDISCOVER broadcast message is nonzero), the server matches the DHCPDISCOVER with the DHCP pool that has the subnet that contains the IP address in the giaddr field.
** If the client is directly connected to the DHCP server (the giaddr field is zero), the DHCP server matches the DHCPDISCOVER with DHCP pools that contain the subnets configured on the receiving interface. If the interface has secondary IP addresses, subnets associated with the secondary IP addresses are examined for possible allocation only after the subnet associated with the primary IP address (on the interface) is exhausted. 

.Task: Create a pool
----
(config)# ip dhcp pool <name>
----

.Task: Specify the subnet network number and mask of the address pool
----
(dhcp-config)# network <network-number> [mask | prefix-length] 
----

.Task: Specify the secondary subnets
----
(dhcp-config)# network <network-number> [mask | prefix-length] secondary
----

.Task: Exclude IP address
----
(config)# ip dhcp excluded-address <low-address> [<high-address>]
----

.Task: Specify the domain name
----
(dhcp-config)# domain-name <example.com>
----

.Task: Specify the name server per order of preference
----
(dhcp-config)# dns-server <address> [<address2> ... <address8>] 
----

.Task: Specify the default boot image for a client
----
(dhcp-config)# bootfile <filename>
----


.Task: Specify the netbios server
----
(dhcp-config)# netbios-name-server <address> [<address2> ... <address8>] 
(dhcp-config)# netbios-node-type <type>
----

.Task: Specify the gateway
----
(dhcp-config)# default-router  <address> [<address2> ... <address8>] 
----


.Task: Specify  a custom DHCP code 
----
(dhcp-config)# option <code> [instance <number>] {ascii <string> | hex <string> | <ip-address>}
----

.Task: Configure the duration of the lease 
----
(dhcp-config)# lease <days> [<hours> [<minutes>] ]  
----

.Task: Specify the lease for ever
----
(dhcp-config)# lease infinite
----


.Task: Configure the utilization mark of the current address pool size
----
(dhcp-config)# utilization mark high <percentage-number> [log]
(dhcp-config)# utilization mark low <percentage-number> [log]
----


.Task: Configure a DHCP address pool with secondary subnets
----
(dhcp-config)# override default-router ??
(dhcp-config)# override utilization high <percentage>
(dhcp-config)# override utilization low <percentage>
----
TODO: add explanation

.Task: Verify the DHCP address pool configuration
----
# show ip dhcp pool [name]
# show ip dhcp binding [address]
# show ip dhcp conflict [name]
# show ip dhcp database [url]
# show ip dhcp server statistics [type-number]
----

=== Address bindings

- Mapping between the IP address and MAC address of a client

.Task: Display the current mapping
----
# show ip dhcp binding
----

==== automatic bindings

- Dynamically maps hardware address to an IP address from a pool.
- Stored in volatile RAM and periodically copied to database agent

==== manual binding

* MAC address of hosts are found in the DHCP database
* Stored in NVRAM 
* Can be configured 
** Individually and stored in NVRAM
** In batch from text files  

.Task: Specify the IP address and subnet mask of the client
----
(dhcp-config)# host <address> [<mask>| </prefix-length] 
----

.Task: Specify the unique identifier for a DHCP client
----
(dhcp-config)# client-identifier <unique-identifier>
----

- Send with DHCP option 61
- Unique identifier 
** 7-byte: 1byte for the media , 6 byte for the MAC address 
** 27-byte: vendor, MAC address, source interface of the client

.Task: Determine the client identifier  
----
# debug ip dhcp server packet

DHCPD:DHCPDISCOVER received from client 0b07.1134.a029 through relay 10.1.0.253.
DHCPD:assigned IP address 10.1.0.3 to client 0b07.1134.a029.
----

.Task: 
----
(dhcp-config)# hardware-address <hw-address> [<protocol-type> | <hw-number>]
----

- For client who can not send a client identifier in the packet 

.Task: 
----
(dhcp-config)# client-name <name> 
----

- Do not include the domain name 


=== Static mapping

- From customer-created text file that DHCP server reads at boot
* Short configuration: no need for several numerous host pools with manual bindings
* Reduce space required in NVRAM to maintain address pools

- The file format has the following elements: 
** Database version number
** End-of-file designator
** Hardware type
** Hardware address
** IP address
** Lease expiration
** Time the file was created 

.Example
----
*time* Jan 21 2005 03:52 PM
*version* 2
!IP address    Type    Hardware address     Lease expiration
10.0.0.4 /24   1       0090.bff6.081e       Infinite
10.0.0.5 /28   id      00b7.0813.88f1.66    Infinite
10.0.0.2 /21   1       0090.bff6.081d       Infinite
*end*
----

.Task: Configure the DHCP server to read a static mapping text file
----
(dhcp-config)# origin file <url>
----


=== Pings

- DHCP server pings an IP address twice before assigning it to a client.
- If the ping is unanswered after waiting for 2 seconds, the server assumes that the address is not in use.

.Task: Specify the number of packets sent to a pool address before assigning it to a client
----
(config)# ip dhcp ping packets <number>
----

.Task: Specify how long a DHCP server waits for a ping reply from an address pool 
----
(config)# ip dhcp ping timeout <milliseconds>
----


=== BOOTP interoperability

.Task: Configure the DHCP server to not reply to any BOOTP requests.
----
(config)# ip dhcp boot ignore
----

.Task: Forward ignored BOOTP request packets to another DHCP server
----
(config)# ip helper-address <a.b.c.d>
----

=== Central DHCP server

- Updates specific DHCP options for remote DHCP server 


.Task: Import DHCP option parameters from central DHCP server
----
(dhcp-config)# import all
(config)# interface <type> <number>
(config-if)# ip address dhcp
----

.Task: Display the options that are imported from the central DHCP server
----
# sh ip dhcp import
----


=== Option 82

- DHCP option contains information known by the relay agent
- For dynamic IP addresses allocation
- TOBECOMPLETED 
- By default, OS DHCP server uses info provided by option 82

.Task: Enable DHCP address allocation with option 82
----
(config)# ip dhcp use class
----

.Task: Define a DHCP class and relay agent information patterns
----
(config)# ip dhcp class <name>
(dhcp-class)# relay agent information
(dhcp-class-info)# relay-information hex <pattern> [*] [bitmask <mask>]
----

.Task: Display DHCP class matching results
----
# debug ip dhcp server class
----

==== Static route with the next-hop dynamically obtained through DHCP

TODO: explanation/context

.Task: Assign a static route for the default next-hop device when the DHCP server is accessed for an IP address 
----
# ip route <prefix> <mask> {<ip-address> | <interface-number> [<ip-number>]} dhcp [<distance>]
----

[NOTE]
====
- Ensure that the DHCP client and server are defined to supply a DHCP device option 3 of the DHCP packet.
- If the DHCP client is not able to obtain an IP address or the default device IP address, the static route is not installed in the routing table.
- If the lease has expired and the DHCP client cannot renew the address, the DHCP IP address assigned to the client is released and any associated static routes are removed from the routing table. 
====

=== Statistics


.Task: Display server statistics
----
# show ip dhcp server statistics 
----


.Task: Reset all DHCP server counters to 0
----
# clear ip dhcp server statistics 
----

== DHCP Relay Agent

- Forwards requests and replies between clients and servers not on the same physical subnet
- Sets the *giaddr* field and adds option 82
- DHCP server and relay agent are enabled by default


.Task: Specify the packet forwarding address
----
(config-if)# ip helper-address <a.b.c.d>
----

.Task: Reduce the frequency with which DHCP clients change their addresses and forwards client requests to the server that handle the previous request.
----
(config-if)# ip dhcp relay prefer known-good-server
----

[NOTE]
====
- The relay agent deletes the ARP entries for addresses offered to the client 
  on unnumbered interfaces.
====

.Task: Disable the DHCP relay agent service
----
# no service dhcp
----


=== Option 82

image::images/dhcp-relay-agent-option-82.png[]

.Task: Insert the DHCP relay agent information option in BOOTREQUEST messages forwarded to a DHCP server
----
# ip dhcp relay information option
----

[NOTE] 
====
- This function is disabled by default
====

.Task: Check whethers the relay agent information option forwarded BOOTREPLY message is valid
----
# ip dhcp relay information check
----

.Task: Configure the reforwarding policy
----
# ip dhcp relay information policy {drop | keep | replace }
----

.Task: Configure all interfaces as trusted sources of the DHCP relay information option.
----
# ip dhcp relay information trust-all
----

.Task: Configure an interface as trusted sources of the DHCP relay information option.
----
(config-if)# ip dhcp relay information trusted
----

.Task: Display all interfaces that are configure to be a trusted source for the DHCP relay information option.
----
# show ip dhcp relay information trusted-sources
----

.Task: Configure per-interface support for the relay agent information option
----
(config-if)# ip dhcp relay information option-insert [none]
(config-if)# ip dhcp relay information check-reply [none]
(config-if)# ip dhcp relay information policy-action {drop | keep | replace}
----

See more optional tasks 
http://www.cisco.com/c/en/us/td/docs/ios-xml/ios/ipaddr_dhcp/configuration/15-mt/dhcp-15-mt-book/config-dhcp-relay-agent.html#GUID-B4DA9D20-F7A3-44BC-8019-D120136458DC[here]


== DHCP Client

.Task: Acquire an IP address on an interface from DHCP
----
(config-if)# ip address dhcp
----

.Task: Display the DHCP packets sent and received during troubleshooting on the client side
----
# debug dhcp detail
----

.Task: Force a release of a DHCP lease
----
# release dhcp
----

[NOTE] 
====
The *release dhcp* command 

- Starts the process to immediately release a DHCP lease for the specified interface. 
- Does not deconfigure the *ip address dhcp* command specified in the configuration file for the interface. 
====

.Task: Force a renewal of a DHCP lease
----
# renew dhcp
----

[NOTE]
==== 
- The *renew dhcp* command advances the DHCP lease timer to the next stage, 
  at which point one of the following occurs:

    ** If the lease is currently in a BOUND state, the lease is advanced to the RENEW state and a DHCP RENEW request is sent.
    ** If the lease is currently in a RENEW state, the timer is advanced to the REBIND state and a DHCP REBIND request is sent.

- If there is no response to the RENEW request, 
the interface remains in the RENEW state. 
In this case, the lease timer will advance to the REBIND state and subsequently send a REBIND request.

- If a NAK response is sent in response to the RENEW request, the interface is deconfigured. 
====

=== Configurable DHCP client feature

- Allows a client to use a user-specified client identifier, class identifier or suggested lease time when requesting an address from a DHCP server.
- Options available:
** Option 33: configure a list of static routes in the client.
** Option 51: request a lease time for the IP address.
** Option 55: request certain options from the DHCP server
** Option 60: configure the vendor class identifier string to use in the DHCP interaction.
** Option 61: specify their unique identifier

=== FORCERENEW Message Handling

TODO: Explain the feature

.Task: Configure FORCERENEW message handling
----
! Specify the key chain to be used in authenticating a request
(config)# key chain <name>
(config-keychain)# key <id>
(config-keychain-key)# key-string <text>
!
! Specify the type of authentication 
(config)# interface <type number>
(config-if)# ip dhcp client authentication key-chain <name>
(config-if)# ip dhcp client authentication mode <type>
!
# ip dhcp-client forcerenew
----

== Accounting and Security

- Address vulnerability in PWLAN

=== DHCP Accounting

- add AAA and RADIUS support to DHCP configuration
- sends secure START/STOP accounting messages upon lease assignment/termination
- Restrictions:
  ** AAA and RADIUS must be enabled
  ** only for network pools with automatic bindings 
  ** *clear ip dhcp binding* or *no service dhcp* triggers accounting STOP messages

.Task: Enable DHCP accounting if a specifier server group is configured to run RADIUS accounting
----
(dhcp-config)# accounting <method-list-name>
----

.Task: Troubleshoot DHCP accounting
----
debug radius accounting
debug ip dhcp server events
debug aaa accounting
debug aaa id
----

=== DHC secured IP address assignment 

- Secures and synchronizes the MAC address of the client to the DHCP binding,
preventing hackers form spoofing the DHCP server and taking over a DHCP lease of an authorized client

.Task: Secure ARP table entries to DHCP leases in the DHCP database
----
(dhcp-config)# update arp
----

[NOTE] 
====
- Existing active DHCP leases will not be secured until they are renewed.
====

.Task: Configure the renewal policy for unknown clients
----
(dhcp-config)# renew deny unknown
----

[NOTE]
==== 
- In some usage scenarios, such as a wireless hotspot,
  where both DHCP and secure ARP are configured, a
  connected client device might go to sleep or suspend for
  a period of time. If the suspended time period is
  greater than the secure ARP timeout (default of 91
  seconds), but less than the DHCP lease time, the client
  can awake with a valid lease, but the secure ARP timeout
  has caused the lease binding to be removed because the
  client has been inactive. When the client awakes, the
  client still has a lease on the client side but is
  blocked from sending traffic. The client will try to
  renew its IP address but the DHCP server will ignore the
  request because the DHCP server has no lease for the
  client. The client must wait for the lease to expire
  before being able to recover and send traffic again.

- To remedy this situation, use the *renew deny unknown*
  command in DHCP pool configuration mode. This command
  forces the DHCP server to reject renewal requests from
  clients if the requested address is present at the
  server but is not leased. The DHCP server sends a
  DHCPNAK denial message to the client, which forces the
  client back to its initial state. The client can then
  negotiate for a new lease immediately, instead of
  waiting for its old lease to expire. 
====


=== DHCP per interface lease limit and statistics

- Allows an ISP to limit the number of DHCP leases allowed on an interface.

.Task: Configure a DHCP lease limit to control the number of subscribers on an interface
----
(config)#  ip dhcp limit lease log
(config-if)# ip dhcp limit lease <max-users>
----

.Task: Verify the DHCP lease limit configuration
----
# show ip dhcp limit lease
----

.Task: Clear the stored lease violation entries
----
# clear ip dhcp limit lease
----





=== DHCP authorized ARP

.Task: Disable dynamic ARP learning on an interface 
----
(config-if)# arp authorized
----

.Task: Configure how long an entry remains in the ARP cache
----
(config-if)# arp timeoute <seconds>
----


.Task:
----
# show arp
----

=== ARP auto-logoff

- enhances DHCP authorized ARP by providing finer control and probing authorized clients to detect a logoff.

.Task: Configure an interval and number of probe retries for ARP
----
(config-if)# arp probe interval <seconds> count <number>
----


=== DHCP snooping

.TODO
add information about option 82
