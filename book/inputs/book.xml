<?xml version="1.0" encoding="UTF-8"?>
<?asciidoc-toc maxdepth="3"?>
<?asciidoc-numbered?>
<book xmlns="http://docbook.org/ns/docbook" xmlns:xl="http://www.w3.org/1999/xlink" version="5.0" xml:lang="en">
<info>
<title>CCIE Routing and Switching study notes</title>
<date>2015-10-12</date>
<author>
<personname>
<firstname>Christian</firstname>
<surname>Kyony</surname>
</personname>
<email>ckyony@changamuka.com</email>
</author>
<authorinitials>CK</authorinitials>
<revhistory>
<revision>
<revnumber>1.0</revnumber>
<date>2015-10-12</date>
<authorinitials>CK</authorinitials>
</revision>
</revhistory>
</info>
<dedication xml:id="_dedication">
<title>Dedication</title>
<simpara>To Cyril "Matiere" Kalenga</simpara>
</dedication>
<part xml:id="_layer_2_technologies">
<title>Layer 2 Technologies</title>
<chapter xml:id="_switch_administration">
<title>Switch administration</title>
<section xml:id="_switch_administration_2">
<title>Switch administration</title>
<section xml:id="_configuring_interface_characteristics">
<title>Configuring Interface Characteristics</title>
<simpara><link xl:href="http://www.cisco.com/c/en/us/td/docs/switches/lan/catalyst3750x_3560x/software/release/15-0_2_se/configuration/guide/3750x_cg/swint.html">http://www.cisco.com/c/en/us/td/docs/switches/lan/catalyst3750x_3560x/software/release/15-0_2_se/configuration/guide/3750x_cg/swint.html</link></simpara>
</section>
<section xml:id="_managing_mac_address_table">
<title>Managing MAC address table</title>
<simpara><link xl:href="http://www.cisco.com/c/en/us/td/docs/switches/lan/catalyst3750x_3560x/software/release/15-0_2_se/configuration/guide/3750x_cg/swadmin.html">http://www.cisco.com/c/en/us/td/docs/switches/lan/catalyst3750x_3560x/software/release/15-0_2_se/configuration/guide/3750x_cg/swadmin.html</link></simpara>
</section>
<section xml:id="_errdisable_recovery">
<title>errdisable recovery</title>

</section>
<section xml:id="_l2_mtu">
<title>L2 MTU</title>

</section>
</section>
</chapter>
<chapter xml:id="_lan">
<title>LAN</title>
<section xml:id="_ethernet">
<title>Ethernet</title>
<itemizedlist>
<listitem>
<simpara>IEEE 802.3 standards</simpara>
</listitem>
<listitem>
<simpara>CSMA/CD protocol</simpara>
</listitem>
<listitem>
<simpara>Medium: coaxial, twisted-pair, optical fiber</simpara>
</listitem>
<listitem>
<simpara>Data rates: 10/100/1000/10000 Mbps</simpara>
</listitem>
</itemizedlist>
<section xml:id="_frame_formats">
<title>Frame Formats</title>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/ethernet-framing-options.png"/>
</imageobject>
<textobject><phrase>Ethernet framing options</phrase></textobject>
</mediaobject>
</informalfigure>
<variablelist>
<varlistentry>
<term>Preamble (DIX)</term>
<term>Preamble and Start of Frame Delimiter(802.3)</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>62 alternating 1s and 0s, and ends with a pair of 1s.</simpara>
</listitem>
<listitem>
<simpara>For clocking synchronization of the transmitted signal.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Type DIX </term>
<listitem>
<itemizedlist>
<listitem>
<simpara>type of protocol or protocol header that follows the header.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Length(802.3)</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>length in bytes of the data following the Length field, up to the Ethernet trailer.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Destination address(DA)</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Can be an individual or group address</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Source address</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Always individual address</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Destination Service Access Protocol DSAP</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>The size limitations, along with other Point (802.2) uses of the low-order bits, required the later addition of SNAP headers.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Source Service Access Protocol SSAP</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Describes the upper-layer protocol Point (802.2) that created the frame.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Control(802.2)</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>enables both connectionless and connection-oriented operation.</simpara>
</listitem>
<listitem>
<simpara>Generally used only for connectionless operation by modern protocols, with a 1-byte value of 0x03.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Organizationally Unique Identifier(SNAP)</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Generally unused today,</simpara>
</listitem>
<listitem>
<simpara>providing a place for the sender of the frame to code the OUI representing the manufacturer of the Ethernet NIC.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Type(SNAP)</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>using same values as the DIX Type field, overcoming deficiencies with size and use of the DSAP field.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Data: </term>
<listitem>
<itemizedlist>
<listitem>
<simpara>n bytes where 46 &#8656; n &#8656; 1500</simpara>
</listitem>
<listitem>
<simpara>if n &lt; 46, use padding</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>FCS: Frame check sequence</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>contains a 32-bit cyclic redundancy check (CRC) value</simpara>
</listitem>
<listitem>
<simpara>calculated by the sending MAC</simpara>
</listitem>
<listitem>
<simpara>re-calculated by the receiving MAC to check for damaged frames.</simpara>
</listitem>
<listitem>
<simpara>generated from the DA, SA, Length/Type, and Data fields</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
</section>
<section xml:id="_ethernet_mac_addresses">
<title>Ethernet MAC Addresses</title>
<itemizedlist>
<listitem>
<simpara>48 bits in hexadecimal</simpara>
</listitem>
<listitem>
<simpara>Canonical transmission (little endian)= MSO to LSO with LSB to MSB for each octet</simpara>
</listitem>
</itemizedlist>
<screen>Example: AC-10-7b-3a-92-3c

convert to hexa: 10101100 00010000 01101011 00111010 01010010 00111100
transmission: 00110101 00001000 11010110 01011100 01001010 00111100</screen>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/ethernet-mac-address.png" contentdepth="240"/>
</imageobject>
<textobject><phrase>Ethernet mac address</phrase></textobject>
</mediaobject>
</informalfigure>
<itemizedlist>
<listitem>
<simpara>Fields:</simpara>
<itemizedlist mark="horizontal">
<listitem>
<simpara>OUI: first 3 bytes,  Organizational Unique Identifier</simpara>
</listitem>
<listitem>
<simpara>I/G: (0/1) individual or Group address, first bit to be transmitted</simpara>
</listitem>
<listitem>
<simpara>U/L: (0/1) universally  or Locally administrated</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<section xml:id="_types_of_mac_addresses">
<title>Types of MAC addresses</title>
<itemizedlist>
<listitem>
<simpara>Unicast : I/G bit = 0</simpara>
</listitem>
<listitem>
<simpara>Multicast: I/G bit = 1</simpara>
</listitem>
<listitem>
<simpara>Broadcast: all devices in the segment</simpara>
</listitem>
</itemizedlist>
</section>
</section>
<section xml:id="_rj_45_pinouts_and_cat5_wiring">
<title>RJ-45 pinouts and Cat5 wiring</title>
<itemizedlist>
<listitem>
<simpara>Defined by <link xl:href="http://www.eia.org">EIA</link> / <link xl:href="http://www.tiaonline.org">TIA</link></simpara>
</listitem>
</itemizedlist>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/ethernet-pinouts.png" contentdepth="100"/>
</imageobject>
<textobject><phrase>Ehernet and ISO</phrase></textobject>
</mediaobject>
</informalfigure>
<table frame="all" rowsep="1" colsep="1">
<title>Ethernet cabling types</title>
<tgroup cols="3">
<colspec colname="col_1" colwidth="18.1818*"/>
<colspec colname="col_2" colwidth="45.4545*"/>
<colspec colname="col_3" colwidth="36.3637*"/>
<thead>
<row>
<entry align="left" valign="top">Type of cable</entry>
<entry align="left" valign="top">Pinouts</entry>
<entry align="left" valign="top">Key pins connected</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Straight-through</simpara></entry>
<entry align="left" valign="top"><simpara>T568A or T568B both ends</simpara></entry>
<entry align="left" valign="top"><simpara>1-1; 2-2; 3-3; 6-6</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Cross-over</simpara></entry>
<entry align="left" valign="top"><simpara>T568A on one end,  T568B on the other</simpara></entry>
<entry align="left" valign="top"><simpara>1-3; 2-6; 3-1; 6-2</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<itemizedlist>
<listitem>
<simpara>Auto-MDIX (automatic medium-dependent interface crossover)</simpara>
<itemizedlist>
<listitem>
<simpara>detects the wrong cable and causes the switch to swap the pair it uses for transmitting and receiving, which solves the cabling
problem.</simpara>
</listitem>
<listitem>
<simpara>Not supported on all Cisco switch models.</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</section>
<section xml:id="_auto_negotiation_speed_and_duplex">
<title>Auto-negotiation, Speed and Duplex</title>
<simpara>By default, each Cisco switch port uses Ethernet auto-negotiation to determine the speed and
duplex setting.</simpara>
<simpara>Switches can dynamically detect the speed setting on a particular Ethernet segment by using a few
different methods. Cisco switches (and many other devices) can sense the speed using the Fast
Link Pulses (FLP) of the auto-negotiation process. However, if auto-negotiation is disabled on
either end of the cable, the switch detects the speed anyway based on the incoming electrical
signal. You can force a speed mismatch by statically configuring different speeds on either end of
the cable, causing the link to no longer function.</simpara>
<formalpara>
<title>Task: Set speed for the interface</title>
<para>
<screen>(config-if)# speed {10 | 100 | 1000 | auto | nonegotiate}</screen>
</para>
</formalpara>
<simpara>Switches detect duplex settings through auto-negotiation only. If both ends have auto-
negotiation enabled, the duplex is negotiated. However, if either device on the cable disables
auto-negotiation, the devices without a configured duplex setting must assume a default. Cisco
switches use a default duplex setting of half duplex (HDX) (for 10-Mbps and 100-Mbps
interfaces) or full duplex (FDX) (for 1000-Mbps interfaces). To disable auto-negotiation on a
Cisco switch port, you simply need to statically configure the speed and the duplex settings.
Ethernet devices can use FDX only when collisions cannot occur on the attached cable; a
collision-free link can be guaranteed only when a shared hub is not in use. The next few topics
review how Ethernet deals with collisions when they do occur, as well as what is different with
Ethernet logic in cases where collisions cannot occur and FDX is allowed.</simpara>
<formalpara>
<title>Task: Set duplex mode for the interface</title>
<para>
<screen>(config-if)# duplex {auto | full | half}</screen>
</para>
</formalpara>
<formalpara>
<title>Task: show controllers</title>
<para>
<screen>Router# show controllers fastethernet1
!
Interface FastEthernet1   MARVELL 88E6052
Link is DOWN
Port is undergoing Negotiation or Link down
Speed :Not set, Duplex :Not set
!
Switch PHY Registers:
~~~~~~~~~~~~~~~~~~~~~
00 : 3100   01 : 7849   02 : 0141   03 : 0C1F   04 : 01E1
05 : 0000   06 : 0004   07 : 2001   08 : 0000   16 : 0130
17 : 0002   18 : 0000   19 : 0040   20 : 0000   21 : 0000
!
Switch Port Registers:
~~~~~~~~~~~~~~~~~~~~~~
Port Status Register       [00] : 0800
Switch Identifier Register [03] : 0520
Port Control Register      [04] : 007F
Rx Counter Register        [16] : 000A
Tx Counter Register        [17] : 0008</screen>
</para>
</formalpara>
</section>
<section xml:id="_switch_internal_processing">
<title>Switch  internal processing</title>
<simpara>Switches forward frames when necessary, and do not forward when there is no need to do so, thus
reducing overhead.</simpara>
<simpara>To accomplish this, switches perform three actions:</simpara>
<itemizedlist>
<listitem>
<simpara>Learn MAC addresses by examining the source MAC address of each received frame</simpara>
</listitem>
<listitem>
<simpara>Decide when to forward a frame or when to filter (not forward) a frame, based on the destination MAC address</simpara>
</listitem>
<listitem>
<simpara>Create a loop-free environment with other bridges by using the Spanning Tree Protocol</simpara>
<variablelist>
<varlistentry>
<term>Store-and-forward</term>
<listitem>
<simpara>The switch fully receives all bits in the frame (store) before forwarding
the frame (forward). This allows the switch to check the FCS before
forwarding the frame, thus ensuring that errored frames are not forwarded.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Cut-through</term>
<listitem>
<simpara>The switch performs the address table lookup as soon as the Destination
Address field in the header is received. The first bits in the frame can be sent out
the outbound port before the final bits in the incoming frame are received. This
does not allow the switch to discard frames that fail the FCS check, but the
forwarding action is faster, resulting in lower latency.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Fragment-free</term>
<listitem>
<simpara>This performs like cut-through switching, but the switch waits for 64 bytes to be
received before forwarding the first bytes of the outgoing frame. According to
Ethernet specifications, collisions should be detected during the first 64 bytes of
the frame, so frames that are in error because of a collision will not be forwarded.</simpara>
</listitem>
</varlistentry>
</variablelist>
</listitem>
</itemizedlist>
</section>
<section xml:id="_switching_and_bridging_logic">
<title>Switching and bridging logic</title>
<informaltable frame="all" rowsep="1" colsep="1">
<tgroup cols="2">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="75*"/>
<thead>
<row>
<entry align="left" valign="top">Type of Address</entry>
<entry align="left" valign="top">Switch Action</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Known unicast</simpara></entry>
<entry align="left" valign="top"><simpara>Forwards frame out the single interface associated with the destination address</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Unknown unicast</simpara></entry>
<entry align="left" valign="top"><simpara>Floods frame out all interfaces, except the interface on which the frame was received</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Broadcast</simpara></entry>
<entry align="left" valign="top"><simpara>Floods frame identically to unknown unicasts</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Multicast</simpara></entry>
<entry align="left" valign="top"><simpara>Floods frame identically to unknown unicasts, unless multicast optimizations are configured</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<formalpara>
<title>Task: Show MAC address table</title>
<para>
<screen>Switch1# show mac-address-table dynamic
  Mac Address Table
  ------------------
  Vlan Mac Address Type Ports
  ---- ----------- ---- -----
  1 000f.2343.87cd DYNAMIC Fa0/13
  1 0200.3333.3333 DYNAMIC Fa0/3
  1 0200.4444.4444 DYNAMIC Fa0/13</screen>
</para>
</formalpara>
</section>
<section xml:id="_standards">
<title>Standards</title>
<informaltable frame="all" rowsep="0" colsep="0">
<tgroup cols="2">
<colspec colname="col_1" colwidth="10*"/>
<colspec colname="col_2" colwidth="90*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>802.1Q</simpara></entry>
<entry align="left" valign="top"><simpara>dot1q trunking</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>802.1d</simpara></entry>
<entry align="left" valign="top"><simpara>STP</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>802.1s</simpara></entry>
<entry align="left" valign="top"><simpara>MST</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>802.1w</simpara></entry>
<entry align="left" valign="top"><simpara>Rapid STP</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>802.1ax</simpara></entry>
<entry align="left" valign="top"><simpara>LACP (formerly 802.3ad)</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>802.2</simpara></entry>
<entry align="left" valign="top"><simpara>Logical Link Control</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>802.3u</simpara></entry>
<entry align="left" valign="top"><simpara>Fast ethernet over copper and optical cable</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>802.3z</simpara></entry>
<entry align="left" valign="top"><simpara>Gigabit ethernet over optical cable</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>802.3ab</simpara></entry>
<entry align="left" valign="top"><simpara>Gigabit ethernet over copper cable</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
<section xml:id="_troubleshooting">
<title>Troubleshooting</title>
<itemizedlist>
<listitem>
<simpara>Add something about excessive collisions, late collisions, runts, re: duplex mismatches</simpara>
</listitem>
</itemizedlist>
</section>
</section>
<section xml:id="_cdp">
<title>CDP</title>
<simpara><menuchoice><guimenu>Catalyst3560-XConfigurationGuides</guimenu> <guimenuitem> <link xl:href="http://www.cisco.com/c/en/us/td/docs/switches/lan/catalyst3750x_3560x/software/release/15-0_2_se/configuration/guide/3750x_cg/swcdp.html">CDP</link> </guimenuitem></menuchoice></simpara>
<section xml:id="_overview">
<title>Overview</title>
<itemizedlist>
<listitem>
<simpara>Layer 2 discovery protocol  running on Cisco devices</simpara>
</listitem>
<listitem>
<simpara>Retrieves device type and SNMP agent address of neighboring devices</simpara>
</listitem>
</itemizedlist>
<section xml:id="_packet_format">
<title>Packet format</title>
<itemizedlist>
<listitem>
<simpara>Header followed by a set of TLV value</simpara>
</listitem>
</itemizedlist>
<figure>
<title>CDP frame format</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/cdp-frame-format.png"/>
</imageobject>
<textobject><phrase>CDP frame format</phrase></textobject>
</mediaobject>
</figure>
</section>
</section>
<section xml:id="_cdp_operations">
<title>CDP operations</title>
<itemizedlist>
<listitem>
<simpara>Enable by default</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Display global information about CDP characteristics</title>
<para>
<screen># show cdp

Capability Codes: R - Router, T - Trans Bridge, B - Source Route Bridge
                 S - Switch, H - Host, I - IGMP, r - Repeater

Device ID        Local Intrfce     Holdtme    Capability  Platform  Port ID
Router3             Ser 1          120           R        2500      Ser 0
Router1             Eth 1          180           R        2500      Eth 0
Switch1             Eth 0          240           S        1900      2</screen>
</para>
</formalpara>
<screen>show cdp entry &lt;entry-name&gt; [protocol | version]</screen>
<formalpara>
<title>Task: Disable CDP</title>
<para>
<screen>(config)# no cdp run</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Enable CDP on an interface</title>
<para>
<screen>(config-if)# cdp enable</screen>
</para>
</formalpara>
<section xml:id="_cdp_updates">
<title>CDP updates</title>
<formalpara>
<title>Task: Set the transmission frequency of CDP updates in seconds</title>
<para>
<screen>(config)# cdp timer &lt;seconds&gt;</screen>
</para>
</formalpara>
<note>
<simpara>Default: 60 seconds range: 5-254 seconds</simpara>
</note>
<formalpara>
<title>Task: Specify the amount of time a receiving device should hold the information sent by your device</title>
<para>
<screen>(config)# cdp holdtime &lt;seconds&gt;</screen>
</para>
</formalpara>
<note>
<simpara>default: 180 seconds, range: 10 to 255 seconds</simpara>
</note>
</section>
<section xml:id="_version">
<title>Version</title>
<formalpara>
<title>Task: Send Version-2 advertisements</title>
<para>
<screen>(config)# cdp advertise-v2</screen>
</para>
</formalpara>
</section>
</section>
<section xml:id="_monitoring_and_maintenance">
<title>Monitoring and maintenance</title>
<formalpara>
<title>Task: Reset the traffic counters to zero</title>
<para>
<screen>clear cdp counters</screen>
</para>
</formalpara>
<section xml:id="_neighbors">
<title>Neighbors</title>
<formalpara>
<title>Task: Delete the CDP table of information about neighbors</title>
<para>
<screen>clear cdp table</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display information about interfaces where CDP enabled</title>
<para>
<screen>sh cdp interface [&lt;interface-id&gt;]</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display information about neighbors</title>
<para>
<screen>sh cdp neighbors [&lt;interface-id&gt;] [detail]</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display CDP counters, including the number of packets sent and received and checksum errors</title>
<para>
<screen># show cdp traffic

Total packets output: 543, Input: 333
 Hdr syntax: 0, Chksum error: 0, Encaps failed: 0
 No memory: 0, Invalid: 0, Fragmented: 0
 CDP version 1 advertisements output: 191, Input: 187
 CDP version 2 advertisements output: 352, Input: 146</screen>
</para>
</formalpara>
</section>
</section>
</section>
<section xml:id="_lldp">
<title>LLDP</title>
<simpara> <menuchoice> <guimenu>Catalyst Configuration Guides</guimenu> <guimenuitem> <link xl:href="http://www.cisco.com/c/en/us/td/docs/switches/lan/catalyst3750x_3560x/software/release/15-0_2_se/configuration/guide/3750x_cg/swlldp.html">LLDP </link>
    </guimenuitem>
      </menuchoice> 
  </simpara>
<section xml:id="_overview_2">
<title>Overview</title>
<itemizedlist>
<listitem>
</listitem>
<listitem>
<simpara>neighbor discovery protocol</simpara>
</listitem>
<listitem>
<simpara>advertises TLV(type, length, value) for each attribute</simpara>
<itemizedlist>
<listitem>
<simpara>basic mandatory</simpara>
<itemizedlist>
<listitem>
<simpara>port description</simpara>
</listitem>
<listitem>
<simpara>system name</simpara>
</listitem>
<listitem>
<simpara>system description</simpara>
</listitem>
<listitem>
<simpara>system capabilities</simpara>
</listitem>
<listitem>
<simpara>management address</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>optional</simpara>
<itemizedlist>
<listitem>
<simpara>port vlan ID for ieee 802.1</simpara>
</listitem>
<listitem>
<simpara>MAC/PHY configuration/status for ieee 802.3</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</section>
<section xml:id="_lldp_global_state">
<title>LLDP global state</title>
<itemizedlist>
<listitem>
<simpara>Disabled by default</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Enable LLDP globally on the switch</title>
<para>
<screen>(config)# lldp run</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display global information, such as frequency of transmissions, the holdtime for packets being sent, and the delay time before LLDP initializes on an interface.</title>
<para>
<screen>show lldp</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display LLDP counters, including the number of packets sent and received, number of packets discarded, and number of unrecognized TLVs.</title>
<para>
<screen>show lldp traffic</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Reset the traffic counters to zero.</title>
<para>
<screen>clear lldp counters</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Delete the LLDP neighbor information table.</title>
<para>
<screen>clear lldp table</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Clear the NMSP statistic counters.</title>
<para>
<screen>clear nmsp statistics</screen>
</para>
</formalpara>
</section>
<section xml:id="_lldp_interfaces">
<title>LLDP interfaces</title>
<itemizedlist>
<listitem>
<simpara>Disabled by default</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Enable an interface to send LLDP packets</title>
<para>
<screen>(config-if)# lldp transmit</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Enable an interface to receive LLDP packets</title>
<para>
<screen>(config-if)# lldp receive</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display information about interfaces with LLDP enabled.</title>
<para>
<screen>show lldp interface [&lt;interface-id&gt;]</screen>
</para>
</formalpara>
</section>
<section xml:id="_neighbors_2">
<title>Neighbors</title>
<formalpara>
<title>Task: Display information about a specific neighbor.</title>
<para>
<screen>show lldp entry &lt;entry-name&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display information about all neighbors.</title>
<para>
<screen>show lldp entry *</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display information about neighbors, including device type, interface type and number, holdtime settings, capabilities, and port ID.</title>
<para>
<screen>show lldp neighbors [&lt;interface-id&gt;] [detail]</screen>
</para>
</formalpara>
</section>
<section xml:id="_timers">
<title>Timers</title>
<itemizedlist>
<title>Task: Specify the amount of time a receiving device should hold the information from your device</title>
<listitem>
<simpara>default: 120 s, range: 0 - 65535</simpara>
</listitem>
</itemizedlist>
<screen>(config)# lldp holdtime &lt;seconds&gt;</screen>
<formalpara>
<title>Task: Specify the delay time in seconds for LLDP to initialize on an interface.</title>
<para>The range is 2 to 5 seconds; the default is 2 seconds.</para>
</formalpara>
<screen>(config)# lldp reinit delay</screen>
<formalpara>
<title>Task: Set the sending frequency of LLDP updates in seconds.</title>
<para>The range is 5 to 65534 seconds; the default is 30 seconds.</para>
</formalpara>
<screen>(config)# lldp timer rate</screen>
</section>
<section xml:id="_tlv">
<title>TLV</title>
<formalpara>
<title>Task: Specify the LLDP TLVs to send or receive.</title>
<para>
<screen>(config)# lldp tlv-select</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Specify the LLDP-MED TLVs to send or receive.</title>
<para>
<screen>(config)# lldp med-tlv-select</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Specify the LLDP-MED TLV to send</title>
<para>
<screen>(config-if)# lldp med-tlv-select {inventory-management | location | network-policy | power-management }</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure network policy TLV</title>
<para>
<screen>(config)# network-policy profile &lt;profile-number&gt;
(config)#  {voice | voice-signaling} vlan [&lt;id&gt;  {cos &lt;cvalue&gt; | dscp &lt;dvalue&gt;}]
            | [[dot1p {cos &lt;cvalue&gt; | dscp &lt;dvalue&gt;}] | none | untagged]
(config-if)# network-policy &lt;profile-number&gt;
(config-if)# lldp med-tlv select network-policy</screen>
</para>
</formalpara>
<tip>
<itemizedlist>
<listitem>
<simpara>if the interface is configured as a tunnel port, LLDP is automatically disabled.</simpara>
</listitem>
<listitem>
<simpara>If you first configure a network-policy profile on an interface, you cannot apply the switchport voice vlan command on the interface. If the switchport voice vlan vlan-id is already configured on an interface, you can apply a network-policy profile on the interface. This way the interface has the voice or voice-signaling VLAN network-policy profile applied on the interface.</simpara>
</listitem>
<listitem>
<simpara>You cannot configure static secure MAC addresses on an interface that has a network-policy profile.</simpara>
</listitem>
<listitem>
<simpara>You cannot configure a network-policy profile on a private-VLAN port.</simpara>
</listitem>
<listitem>
<simpara>For wired location to function, you must first enter the ip device tracking global configuration command.</simpara>
</listitem>
</itemizedlist>
</tip>
<formalpara>
<title>Task: Display the location information for an endpoint.</title>
<para>
<screen>show location</screen>
</para>
</formalpara>
</section>
<section xml:id="_network_policy_profiles">
<title>Network-policy profiles</title>
<formalpara>
<title>Task: Display the configured network-policy profiles.</title>
<para>
<screen>show network-policy profile</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display the NMSP information.</title>
<para>
<screen>show nmsp</screen>
</para>
</formalpara>
</section>
<section xml:id="_lldp_med">
<title>LLDP-MED</title>
<itemizedlist>
<listitem>
<simpara>LLDP for Media Endpoint Devices</simpara>
</listitem>
<listitem>
<simpara>operates between endpoint devices (ip phones) and network devices (switches)</simpara>
</listitem>
<listitem>
<simpara>supports VoIP applications</simpara>
</listitem>
<listitem>
<simpara>TLVs enabled by default:</simpara>
<itemizedlist>
<listitem>
<simpara>LLDP-MED capabilities TLV</simpara>
</listitem>
<listitem>
<simpara>network policy TLV</simpara>
</listitem>
<listitem>
<simpara>Power management TLV</simpara>
</listitem>
<listitem>
<simpara>Inventory management TLV</simpara>
</listitem>
<listitem>
<simpara>Location TLV</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</section>
<section xml:id="_wired_location_service">
<title>Wired location service</title>
<itemizedlist>
<listitem>
<simpara>The switch uses the wired location service feature to send location and
attachment tracking information for its connected devices to a Cisco Mobility
Services Engine (MSE). The tracked device can be a wireless endpoint, a wired
endpoint, or a wired switch or controller. The switch notifies the MSE of
Protocol (NMSP) location and attachment notifications.</simpara>
</listitem>
</itemizedlist>
<simpara>The MSE starts the NMSP connection to the switch, which opens a server port.
When the MSE connects to the switch there are a set of message exchanges to
establish version compatibility and service exchange information followed by
location information synchronization. After connection, the switch periodically
down events detected during an interval are aggregated and sent at the end of
the interval.</simpara>
address, IP address, and username. If the client is LLDP-MED- or CDP-capable,
the switch obtains the serial number and UDI through the LLDP-MED location TLV
or CDP.</simpara>
<itemizedlist>
<listitem>
<simpara>Slot and port specified in port connection</simpara>
</listitem>
<listitem>
<simpara>MAC address specified in the client MAC address</simpara>
</listitem>
<listitem>
<simpara>IP address specified in port connection</simpara>
</listitem>
<listitem>
<simpara>802.1X username if applicable</simpara>
</listitem>
<listitem>
<simpara>Device category is specified as a wired station</simpara>
</listitem>
<listitem>
<simpara>State is specified as new</simpara>
</listitem>
<listitem>
<simpara>Serial number, UDI</simpara>
</listitem>
<listitem>
<simpara>Model number</simpara>
</listitem>
<listitem>
<simpara>Time in seconds since the switch detected the association</simpara>
</listitem>
</itemizedlist>
<itemizedlist>
<listitem>
<simpara>Slot and port that was disconnected</simpara>
</listitem>
<listitem>
<simpara>MAC address</simpara>
</listitem>
<listitem>
<simpara>IP address</simpara>
</listitem>
<listitem>
<simpara>802.1X username if applicable</simpara>
</listitem>
<listitem>
<simpara>Device category is specified as a wired station</simpara>
</listitem>
<listitem>
<simpara>State is specified as delete</simpara>
</listitem>
<listitem>
<simpara>Serial number, UDI</simpara>
</listitem>
<listitem>
<simpara>Time in seconds since the switch detected the disassociation</simpara>
</listitem>
</itemizedlist>
<simpara>When the switch shuts down, it sends an attachment notification with the state
delete and the IP address before closing the NMSP connection to the MSE. The
MSE interprets this notification as disassociation for all the wired clients
associated with the switch.</simpara>
<simpara>If you change a location address on the switch, the switch sends an NMSP
location notification message that identifies the affected ports and the
changed address information.</simpara>
</section>
</section>
<section xml:id="_udld">
<title>UDLD</title>
<section xml:id="_overview_3">
<title>Overview</title>
<itemizedlist>
<listitem>
<simpara>Problem:  unidirectional links</simpara>
<itemizedlist>
<listitem>
<simpara>one of the 2 transmission paths has failed but not both</simpara>
</listitem>
<listitem>
<simpara>due to miscabling, cutting on fiber cable, unplugging one fiber, GBIC problems, &#8230;&#8203;</simpara>
</listitem>
<listitem>
<simpara>can cause a loop as the previously blocking port will move to a forwarding state</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/stp-unidirectional-links.png" contentdepth="150"/>
</imageobject>
<textobject><phrase>stp unidirectional links</phrase></textobject>
</mediaobject>
</informalfigure>
<itemizedlist>
<listitem>
<simpara>solutions:</simpara>
<variablelist>
<varlistentry>
<term>UDLD <emphasis role="strong">u</emphasis>ni<emphasis role="strong">d</emphasis>irectional <emphasis role="strong">l</emphasis>ink <emphasis role="strong">d</emphasis>etection</term>
<listitem>
<simpara>Uses Layer 2 messaging to decide when a switch can no longer receive frames from
a neighbor. The switch whose transmit interface did not fail is placed into an err-disabled
state.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>UDLD aggressive mode</term>
<listitem>
<simpara>Attempts to reconnect with the other switch (eight times)
after realizing no messages have been received.
If the other switch does not reply to the repeated additional messages,
both sides become err-disabled.</simpara>
</listitem>
</varlistentry>
</variablelist>
</listitem>
</itemizedlist>
<section xml:id="_modes_of_operations">
<title>Modes of operations</title>
<section xml:id="_normal">
<title>Normal</title>
<itemizedlist>
<listitem>
<simpara>default</simpara>
</listitem>
<listitem>
<simpara>detects unidirectional links due to misconnected ports on fiber-optic connection</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_aggresive_mode">
<title>Aggresive mode</title>

</section>
</section>
</section>
<section xml:id="_tasks">
<title>Tasks</title>
<section xml:id="_default_configuration">
<title>Default configuration</title>
<informaltable frame="all" rowsep="1" colsep="1">
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Feature</simpara></entry>
<entry align="left" valign="top"><simpara>Default Setting</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>UDLD global enable state</simpara></entry>
<entry align="left" valign="top"><simpara>Globally disabled</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>UDLD per-port enable state for fiber-optic media</simpara></entry>
<entry align="left" valign="top"><simpara>Disabled on all Ethernet fiber-optic ports</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>UDLD per-port enable state for UTP copper media</simpara></entry>
<entry align="left" valign="top"><simpara>Disabled on all Ethernet 10/100/1000BASE-TX ports</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>UDLD aggressive mode</simpara></entry>
<entry align="left" valign="top"><simpara>Disabled</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<formalpara>
<title>Task: Enable UDLD globally</title>
<para>
<screen>(config)# udld {aggressive | enable | message time &lt;seconds&gt;}</screen>
</para>
</formalpara>
<variablelist>
<varlistentry>
<term>message time &lt;seconds&gt;</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>configure the period of time between UDLD probe messages on ports
that are in the advertisement phase and are detected to be bidirectional.</simpara>
</listitem>
<listitem>
<simpara>range: 1 to 90 seconds</simpara>
</listitem>
<listitem>
<simpara>default: 15 seconds</simpara>
</listitem>
<listitem>
<simpara>This command affects fiber-optic ports only. Use <emphasis role="strong">(config-if)# udld</emphasis>
to enable UDLD on other port types.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<formalpara>
<title>Task: Reset an interface disabled by UDLD</title>
<para>
<screen>udld reset</screen>
</para>
</formalpara>
<simpara>You can also  restart the disabled port</simpara>
<itemizedlist>
<listitem>
<simpara><emphasis role="strong">shutdown</emphasis> followed by <emphasis role="strong">no shutdown</emphasis></simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">no udld {aggressive | enable}</emphasis> followed by <emphasis role="strong">udld {aggressive | enable}</emphasis></simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">no udld port</emphasis> followed by <emphasis role="strong">udld port [aggressive]</emphasis></simpara>
</listitem>
</itemizedlist>
</section>
</section>
<section xml:id="_udld_error_disabled_state">
<title>UDLD error-disabled state</title>
<formalpara>
<title>Task: Recover from the UDLD error-disabled state</title>
<para>
<screen>! Enable UDLD to automatically recover
(config)# errdisable recovery cause udld

! Specify the time to recover from the UDLD error-disabled state
(config-if)# errdisable recovery interval &lt;seconds&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display UDLD status</title>
<para>
<screen>show udld [interface-id]</screen>
</para>
</formalpara>
</section>
</section>
</chapter>
<chapter xml:id="_vlan">
<title>VLAN</title>
<section xml:id="_vlan_2">
<title>VLAN</title>
<section xml:id="_concepts">
<title>concepts</title>
<itemizedlist>
<listitem>
<simpara>administratively defined subset of switch ports that are in the same broadcast domain</simpara>
</listitem>
<listitem>
<simpara>best practice: one VLAN, one IP subnet</simpara>
</listitem>
<listitem>
<simpara>traffic inside same VLAN is layer 2 switched</simpara>
</listitem>
<listitem>
<simpara>traffic between VLANs is layer 3 routed</simpara>
</listitem>
<listitem>
<simpara>can span multiple physical switches over "trunks"</simpara>
</listitem>
</itemizedlist>
<section xml:id="_private_vlans">
<title>Private VLANs</title>
<itemizedlist>
<listitem>
<simpara>separate ports as if they are on different VLAN while consuming only one subset.</simpara>
</listitem>
<listitem>
<simpara>typically use by service provider in a multi-tenant offerings: one router, one switch, multiple customers</simpara>
</listitem>
<listitem>
<simpara>pVLAN = one primary VLAN ( promiscuous ports) + multiple secondary VLANs ( community and isolated ports)</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_vlan_numbering">
<title>VLAN numbering</title>
<itemizedlist>
<listitem>
<simpara>VLAN ID = 12 bits</simpara>
<variablelist>
<varlistentry>
<term>Reserved [0, 4095] </term>
<listitem>
<itemizedlist>
<listitem>
<simpara>not available for use</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Normal-range [1-1005]</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>advertised and pruned by VTP v1 and v2 except vlan 1, 1002-1005</simpara>
</listitem>
<listitem>
<simpara>configured in both vlan database mode and configuration mode</simpara>
</listitem>
<listitem>
<simpara>stored in VLAN.DAT file in Flash</simpara>
</listitem>
<listitem>
<simpara>Special vlans:</simpara>
<itemizedlist>
<listitem>
<simpara>Vlan 1 is the default Ethernet VLAN for all access ports; cannot be deleted or changed.</simpara>
</listitem>
<listitem>
<simpara>Vlan 1002-1004 : default for FDDI</simpara>
</listitem>
<listitem>
<simpara>Vlan 1002-1005 : default for Token Ring translational bridge.</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Extended-range [1006-4094] </term>
<listitem>
<itemizedlist>
<listitem>
<simpara>cannot be advertised or pruned by VTP v1 and v2</simpara>
</listitem>
<listitem>
<simpara>configured only in VTP transparent mode</simpara>
</listitem>
<listitem>
<simpara>stored only in the running configuration</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
</listitem>
</itemizedlist>
</section>
<section xml:id="_vlan_trunks">
<title>VLAN Trunks</title>
<itemizedlist>
<listitem>
<simpara>trunk: point-to-point links for multiple VLANs between devices</simpara>
</listitem>
<listitem>
<simpara>trunking add ISL or 802.1q headers to include VLAN id.</simpara>
<itemizedlist>
<listitem>
<simpara>ISL : Cisco proprietary, 30-bytes (26-byte header + 4-byte trailer), does not modify original frame</simpara>
</listitem>
<listitem>
<simpara>802.1q: IEEE standard, 4-byte tag except for native VLAN, modifies original frame</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</section>
</section>
<section xml:id="_configuration_tasks">
<title>Configuration tasks</title>
<section xml:id="_basic_configuration">
<title>Basic configuration</title>
<simpara>Configuring VLANs requires few steps:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Create the VLAN itself</simpara>
</listitem>
<listitem>
<simpara>Associate the correct ports with VLAN</simpara>
</listitem>
</orderedlist>
<simpara>VLAN creation can be done either in VLAN database mode configuration (after <emphasis role="strong">vlan database</emphasis> ) or normal configuration mode</simpara>
<table frame="all" rowsep="1" colsep="1">
<title>Catalyst 3550 VLAN database vs configuration mode</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>VLAN Database</simpara></entry>
<entry align="left" valign="top"><simpara>Configuration</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>vtp {domain domain-name | password password | pruning | v2-mode | {server | client | transparent}}</simpara></entry>
<entry align="left" valign="top"><simpara>vtp {domain domain-name | file filename | interface name | mode {client | server | transparent} | password password | pruning | version number}</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>vlan vlan-id [backupcrf {enable | disable}] [mtu mtu-size] [name vlan-name] [parent parent-vlan-id] [state {suspend | active}]</simpara></entry>
<entry align="left" valign="top"><simpara>vlan vlan-id 1</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>show {current | proposed | difference}</simpara></entry>
<entry align="left" valign="top"><simpara>No equivalent</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>apply | abort | reset</simpara></entry>
<entry align="left" valign="top"><simpara>No equivalent</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
</section>
</section>
<section xml:id="_troubleshoot">
<title>Troubleshoot</title>
<simpara>Check "Creating ethernet vlans on catalyst switches: troubleshoot tips"</simpara>
<itemizedlist>
<listitem>
<simpara>SVI will be in "up/down" state after being deleted</simpara>
</listitem>
<listitem>
<simpara>SVI will be in "up/up" if</simpara>
<itemizedlist>
<listitem>
<simpara>the VLAN associated with the SVI exists in the VLAN database</simpara>
</listitem>
<listitem>
<simpara>at least one trunk or access port in the "up/up" state has been assigned to the VLAN</simpara>
</listitem>
<listitem>
<simpara>those ports in the "up/up" state are not blocked by STP</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</section>
</section>
<section xml:id="_voice_vlan">
<title>Voice VLAN</title>
</section>
<section xml:id="_private_vlans_2">
<title>Private VLANs</title>
</section>
</chapter>
<chapter xml:id="_trunking">
<title>Trunking</title>
<section xml:id="_vtp">
<title>VTP</title>
<section xml:id="_overview_4">
<title>Overview</title>
<itemizedlist>
<listitem>
<simpara>VTP vlan trunk protocol</simpara>
</listitem>
<listitem>
<simpara>Cisco-proprietary that distributes VLAN information among Catalyst switches</simpara>
</listitem>
<listitem>
<simpara>Advertises the VLAN Id, Name and Type but not which ports should be in each VLAN</simpara>
</listitem>
<listitem>
<simpara>Eases administrative burden for addition, deletion and renaming of VLANs</simpara>
</listitem>
<listitem>
<simpara>Supports 1005 VLANs (IP base or IP services feature set) or 255 VLANs (LAN base feature set)</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_vtp_message_format">
<title>VTP message format</title>
<itemizedlist>
<listitem>
<simpara>Encapsulated in ISL or 802.1q frames</simpara>
</listitem>
<listitem>
<simpara>Multicasted to  MAC address: 0100-0CCC-CCCC, LLC code: SNAP (AAAA), Type 2003 in the SNAP Header</simpara>
</listitem>
<listitem>
<simpara>Carried through trunk ports and VLAN 1</simpara>
</listitem>
</itemizedlist>
<figure>
<title>Example: VTP packet encapsulated in ISL frame</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/vtp-in-isl.png" contentdepth="80"/>
</imageobject>
<textobject><phrase>vtp in isl</phrase></textobject>
</mediaobject>
</figure>
<itemizedlist>
<listitem>
<simpara>The VTP header contains these fields:</simpara>
<itemizedlist>
<listitem>
<simpara>VTP protocol version: 1,2,3</simpara>
</listitem>
<listitem>
<simpara>VTP message types: summary advertisements, subset advertisements, advertisement requests, VTP join messages</simpara>
</listitem>
<listitem>
<simpara>management domain length</simpara>
</listitem>
<listitem>
<simpara>management domain name</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<section xml:id="_summary_advertisements">
<title>Summary advertisements</title>
<itemizedlist>
<listitem>
<simpara>Informs adjacent Catalysts of the current VTP domain name and the configuration revision number.</simpara>
</listitem>
<listitem>
<simpara>5 minutes intervals</simpara>
</listitem>
<listitem>
<simpara>When the switch receives a summary advertisement packet,</simpara>
<itemizedlist>
<listitem>
<simpara>the switch compares the VTP domain name to its own VTP domain name.</simpara>
</listitem>
<listitem>
<simpara>If the name is different, the switch simply ignores the packet.</simpara>
</listitem>
<listitem>
<simpara>If the name is the same, the switch then compares the configuration revision to its own revision.</simpara>
</listitem>
<listitem>
<simpara>If its own configuration revision is higher or equal, the packet is ignored.</simpara>
</listitem>
<listitem>
<simpara>If it is lower, an advertisement request is sent.</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<figure>
<title>VTP Summary Advert</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/vtp-summary-advert-packet-format.png.png"/>
</imageobject>
<textobject><phrase>VTP Summary Advert</phrase></textobject>
</mediaobject>
</figure>
<informaltable frame="all" rowsep="1" colsep="1">
<tgroup cols="2">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="75*"/>
<thead>
<row>
<entry align="left" valign="top">Field</entry>
<entry align="left" valign="top">Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Followers</simpara></entry>
<entry align="left" valign="top"><simpara>Indicates that this packet is followed by a Subset Advertisement packet.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Updater Identity</simpara></entry>
<entry align="left" valign="top"><simpara>IP address of the switch that is the last to have incremented the configuration revision.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Update Timestamp</simpara></entry>
<entry align="left" valign="top"><simpara>Date and time of the last increment of the configuration revision.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>MD5 Digest</simpara></entry>
<entry align="left" valign="top"><simpara>If MD5 is configured and used to authenticate the validation of a VTP update.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
<section xml:id="_subset_advertisements">
<title>Subset advertisements</title>
<itemizedlist>
<listitem>
<simpara>Follows the summary advertisement after addition, deletion or modification of a VLAN.</simpara>
</listitem>
<listitem>
<simpara>Contains a list of VLAN information.</simpara>
</listitem>
</itemizedlist>
<figure>
<title>VTP Subset advertisements</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/vtp-subset-advert-packet-format.png.png"/>
</imageobject>
<textobject><phrase>VTP Subset advertisements</phrase></textobject>
</mediaobject>
</figure>
<variablelist>
<varlistentry>
<term>Code</term>
<listitem>
<simpara>value: 0x02 for subset advertisement.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Sequence number</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Identify the packet in the stream of packets that follow a summary advertisement</simpara>
</listitem>
<listitem>
<simpara>Starts with value 1</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
</section>
<section xml:id="_advertisement_request">
<title>Advertisement request</title>
<simpara>A switch needs a VTP advertisement request in these situations:</simpara>
<itemizedlist>
<listitem>
<simpara>The switch has been reset.</simpara>
</listitem>
<listitem>
<simpara>The VTP domain name has been changed.</simpara>
</listitem>
<listitem>
<simpara>The switch has received a VTP summary advertisement with a higher configuration revision than its own.</simpara>
</listitem>
</itemizedlist>
<simpara>Upon receipt of an advertisement request, a VTP device sends a summary advertisement.
One or more subset advertisements follow the summary advertisement. This is an example:</simpara>
<figure>
<title>VTP advertisement request</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/vtp-request-advert-packet-format.png.png"/>
</imageobject>
<textobject><phrase>VTP advertisement request</phrase></textobject>
</mediaobject>
</figure>
<variablelist>
<varlistentry>
<term>Start-Value</term>
<listitem>
<simpara>This is used in cases in which there are several subset advertisements.
If the first (n) subset advertisement has been received
and the subsequent one (n+1) has not been received,
the Catalyst only requests advertisements from the (n+1)th one.</simpara>
</listitem>
</varlistentry>
</variablelist>
</section>
</section>
<section xml:id="_vtp_domains">
<title>VTP domains</title>
<itemizedlist>
<listitem>
<simpara>Controls which devices can exchange VTP advertisements</simpara>
</listitem>
<listitem>
<simpara>Defaults to null value</simpara>
</listitem>
<listitem>
<simpara>Switch inherits VTP domain name of first received advertisement over trunk links</simpara>
</listitem>
<listitem>
<simpara>A switch can only be part of one domain at a time</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Set the VTP domain name</title>
<para>
<screen>(config)# vtp domain &lt;name&gt;</screen>
</para>
</formalpara>
</section>
<section xml:id="_configuration_revision_number">
<title>Configuration revision number</title>
<itemizedlist>
<listitem>
<simpara>32-bit</simpara>
</listitem>
<listitem>
<simpara>Incremented by one for each configuration change</simpara>
</listitem>
<listitem>
<simpara>Higher revision indicates newer database</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_allowed_active_and_pruned_vlans">
<title>Allowed, active and pruned VLANs</title>
<simpara>Although a trunk can support VLANs 14094, several mechanisms reduce the actual number of
VLANs whose traffic flows over the trunk. First, VLANs can be administratively forbidden from
existing over the trunk using the <emphasis role="strong">switchport trunk allowed</emphasis> interface subcommand. Also, any
allowed VLANs must be configured on the switch before they are considered active on the trunk.
Finally, VTP can prune VLANs from the trunk, with the switch simply ceasing to forward frames
from that VLAN over the trunk.</simpara>
<simpara>The <emphasis role="strong">show interface trunk</emphasis> command lists the VLANs that fall into each category:</simpara>
<variablelist>
<varlistentry>
<term>Allowed VLANs </term>
<listitem>
<simpara>Each trunk allows all VLANs by default. However, VLANs can be
removed or added to the list of allowed VLANs by using the switchport trunk allowed
command.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Allowed and active </term>
<listitem>
<simpara>To be active, a VLAN must be in the allowed list for the trunk (based on trunk configuration),
and the VLAN must exist in the VLAN configuration on the switch.
With PVST+, an STP instance is actively running on this trunk for the VLANs in this list.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Active and not pruned </term>
<listitem>
<simpara>This list is a subset of the allowed and active list, with any VTP-pruned VLANs removed.</simpara>
</listitem>
</varlistentry>
</variablelist>
</section>
<section xml:id="_vtp_modes">
<title>VTP modes</title>
<simpara>You can configure a switch to operate in any one of these VTP modes:</simpara>
<variablelist>
<varlistentry>
<term>Server</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Default mode</simpara>
</listitem>
<listitem>
<simpara>Allows addition, deletion and modification of VLAN information</simpara>
</listitem>
<listitem>
<simpara>Changes on server overwrite the rest of the domain</simpara>
</listitem>
<listitem>
<simpara>Configuration saved in NVRAM</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<formalpara>
<title>Task: Configure the switch as a VTP server</title>
<para>
<screen>vtp mode server</screen>
</para>
</formalpara>
<variablelist>
<varlistentry>
<term>Client</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Cannot add, remove or modify VLAN information</simpara>
</listitem>
<listitem>
<simpara>Listens for advertisements originated by server, install them and passes them on</simpara>
</listitem>
<listitem>
<simpara>Configuration saved in NVRAM only for VTPv3</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<formalpara>
<title>Task: Configure the switch as a VTP client</title>
<para>
<screen>vtp mode client</screen>
</para>
</formalpara>
<variablelist>
<varlistentry>
<term>Transparent</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Keeps a separate VTP database from the rest of the domain</simpara>
</listitem>
<listitem>
<simpara>Does not originate advertisements</simpara>
</listitem>
<listitem>
<simpara>"transparently" passes received advertisements through without installing them</simpara>
</listitem>
<listitem>
<simpara>Can still create, remove or renamed VLANs which are not advertised to neighboring switches.</simpara>
</listitem>
<listitem>
<simpara>Need for some applications like Private VLANs</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<formalpara>
<title>Task: Setup VTP transparent mode</title>
<para>
<screen>vtp mode transparent</screen>
</para>
</formalpara>
<variablelist>
<varlistentry>
<term>Off (configurable only in CatOS switches)</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Like VTP transparent mode with the exception that VTP advertisements are not forwarded</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<table frame="all" rowsep="1" colsep="1">
<title>VTP Modes and Features</title>
<tgroup cols="4">
<colspec colname="col_1" colwidth="70*"/>
<colspec colname="col_2" colwidth="10*"/>
<colspec colname="col_3" colwidth="10*"/>
<colspec colname="col_4" colwidth="10*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Function</simpara></entry>
<entry align="left" valign="top"><simpara>Server Mode</simpara></entry>
<entry align="left" valign="top"><simpara>Client Mode</simpara></entry>
<entry align="left" valign="top"><simpara>Transparent Mode</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Originates VTP advertisements</simpara></entry>
<entry align="left" valign="top"><simpara>Yes</simpara></entry>
<entry align="left" valign="top"><simpara>Yes</simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Processes received advertisements to update its VLAN configuration</simpara></entry>
<entry align="left" valign="top"><simpara>Yes</simpara></entry>
<entry align="left" valign="top"><simpara>Yes</simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Forwards received VTP advertisements</simpara></entry>
<entry align="left" valign="top"><simpara>Yes</simpara></entry>
<entry align="left" valign="top"><simpara>Yes</simpara></entry>
<entry align="left" valign="top"><simpara>Yes</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Saves VLAN configuration in NVRAM or vlan.dat</simpara></entry>
<entry align="left" valign="top"><simpara>Yes</simpara></entry>
<entry align="left" valign="top"><simpara>Yes</simpara></entry>
<entry align="left" valign="top"><simpara>Yes</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Can create, modify, or delete VLANs using  configuration commands</simpara></entry>
<entry align="left" valign="top"><simpara>Yes</simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
<entry align="left" valign="top"><simpara>Yes</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
</section>
<section xml:id="_vtp_security">
<title>VTP security</title>
<itemizedlist>
<listitem>
<simpara>MD5 authentication prevents against certain attack</simpara>
<itemizedlist>
<listitem>
<simpara>does not prevent against misconfiguration</simpara>
</listitem>
<listitem>
<simpara>password must be setup manually because switches only exchanges MD5 digest of the password.</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Configure VTP authentication</title>
<para>
<screen>(config)# vtp password &lt;string&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Show the VTP password</title>
<para>
<screen>(config)# sh vtp password</screen>
</para>
</formalpara>
</section>
<section xml:id="_vtp_pruning">
<title>VTP pruning</title>
<itemizedlist>
<listitem>
<simpara>Problem:</simpara>
<itemizedlist>
<listitem>
<simpara>Broadcasts and unknown unicast/multicast frame are flooded everywhere in the broadcast domain
included through trunks links</simpara>
</listitem>
<listitem>
<simpara>Manual editing allowed list is a huge administrative overhead</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/flooding-traffic-without-vtp-pruning.png"/>
</imageobject>
<textobject><phrase>Flooding traffic without VTP pruning</phrase></textobject>
</mediaobject>
</informalfigure>
<itemizedlist>
<listitem>
<simpara>Solution: VTP pruning</simpara>
<itemizedlist>
<listitem>
<simpara>Switches advertise what they need</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
</listitem>
</itemizedlist>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/flooding-traffic-with-vtp-pruning.png"/>
</imageobject>
<textobject><phrase>Optimized flooded traffic with VTP pruning</phrase></textobject>
</mediaobject>
</informalfigure>
<itemizedlist>
<listitem>
<simpara>Restriction:</simpara>
<itemizedlist>
<listitem>
<simpara>Pruning does not work in transparent mode. Why?</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<section xml:id="_pruning_eligibility">
<title>Pruning eligibility</title>
<itemizedlist>
<listitem>
<simpara>When VTP pruning is enabled on a VTP server,
pruning is enabled for the entire management domain
except for pruning-ineligible VLANS ( Vlan 1, 1002-1005, 1006-4094)</simpara>
</listitem>
<listitem>
<simpara>Making VLANs pruning-eligible or pruning-ineligible affects pruning eligibility for those VLANs on that trunk only
(not on all switches in the VTP domain).</simpara>
</listitem>
<listitem>
<simpara>VTP pruning takes effect several seconds after you enable it.</simpara>
</listitem>
</itemizedlist>
</section>
</section>
<section xml:id="_version_2">
<title>Version</title>
<simpara>TODO: Add task for this section</simpara>
<itemizedlist>
<listitem>
<simpara>Default: version 1</simpara>
</listitem>
</itemizedlist>
<section xml:id="_version_2_2">
<title>Version 2</title>
<simpara>-</simpara>
</section>
<section xml:id="_version_3">
<title>Version 3</title>
<itemizedlist>
<listitem>
<simpara>Supports the whole IEEE 802.1q vlan range up to 4095 ( v1 and v2 support only normal range VLANs 1-1005)</simpara>
</listitem>
<listitem>
<simpara>Can send private LAN information in addition to normal VLAN information.</simpara>
</listitem>
<listitem>
<simpara>Backward compatible with VTP 2</simpara>
</listitem>
<listitem>
<simpara>Add support for databases other than VLAN databases such as MST databases.</simpara>
</listitem>
<listitem>
<simpara>Clear text or hidden password protection</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Verify VTP configuration</title>
<para>
<screen># show vtp status

VTP Version: 3 (capable)
Configuration Revision: 1
Maximum VLANs supported locally: 1005
Number of existing VLANs: 37
VTP Operating Mode: Server
VTP Domain Name: [smartports]
VTP Pruning Mode: Disabled
VTP V2 Mode: Enabled
VTP Traps Generation: Disabled
MD5 digest : 0x26 0xEE 0x0D 0x84 0x73 0x0E 0x1B 0x69
Configuration last modified by 172.20.52.19 at 7-25-08 14:33:43
Local updater ID is 172.20.52.19 on interface Gi5/2 (first layer3 interface fou)
VTP version running: 2</screen>
</para>
</formalpara>
</section>
</section>
<section xml:id="_troubleshooting_2">
<title>Troubleshooting</title>
</section>
</section>
<section xml:id="_dtp">
<title>DTP</title>
<section xml:id="_dynamic_trunk_protocol">
<title>Dynamic trunk protocol</title>
<itemizedlist>
<listitem>
<simpara>negotiate trunk status</simpara>
</listitem>
<listitem>
<simpara>default to <emphasis role="strong">dynamic auto</emphasis></simpara>
</listitem>
</itemizedlist>
<table frame="all" rowsep="1" colsep="0">
<title>Trunking configuration options that lead to a working trunk</title>
<tgroup cols="4">
<colspec colname="col_1" colwidth="22.2222*"/>
<colspec colname="col_2" colwidth="11.1111*"/>
<colspec colname="col_3" colwidth="44.4444*"/>
<colspec colname="col_4" colwidth="22.2223*"/>
<thead>
<row>
<entry align="left" valign="top">Configuration Command</entry>
<entry align="left" valign="top">Short name</entry>
<entry align="left" valign="top">Meaning</entry>
<entry align="left" valign="top">To trunk other side must be</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>switchport mode trunk</simpara></entry>
<entry align="left" valign="top"><simpara>Trunk</simpara></entry>
<entry align="left" valign="top"><simpara>Always trunks on this end; sends DTP to help other side choose to trunk</simpara></entry>
<entry align="left" valign="top"><simpara>On, desirable, auto</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>switchport mode trunk ; switchport nonegotiate</simpara></entry>
<entry align="left" valign="top"><simpara>Nonegotiate</simpara></entry>
<entry align="left" valign="top"><simpara>Always trunks on this end; does not send DTP messages (good when other switch is a non-Cisco switch)</simpara></entry>
<entry align="left" valign="top"><simpara>On</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>switchport mode dynamic desirable</simpara></entry>
<entry align="left" valign="top"><simpara>Desirable</simpara></entry>
<entry align="left" valign="top"><simpara>Sends DTP messages, and trunks if negotiation succeeds</simpara></entry>
<entry align="left" valign="top"><simpara>On, desirable, auto</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>switchport mode dynamic auto</simpara></entry>
<entry align="left" valign="top"><simpara>Auto</simpara></entry>
<entry align="left" valign="top"><simpara>Replies to DTP messages, and trunks if negotiation succeeds</simpara></entry>
<entry align="left" valign="top"><simpara>On, desirable</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>switchport mode access</simpara></entry>
<entry align="left" valign="top"><simpara>Access</simpara></entry>
<entry align="left" valign="top"><simpara>Never trunks; sends DTP to help other side reach same conclusion</simpara></entry>
<entry align="left" valign="top"><simpara>Never trunks</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>switchport mode access; switchport nonegotiate</simpara></entry>
<entry align="left" valign="top"><simpara>Access (with nonegotiate)</simpara></entry>
<entry align="left" valign="top"><simpara>Never trunks; does not send DTP messages</simpara></entry>
<entry align="left" valign="top"><simpara>(Never trunks)</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<formalpara>
<title>Task: Configure an inter-switch links to be in dynamic desirable state</title>
<para>
<screen>(config-if)# switchport mode dynamic desirable</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Disable DTP for a port administratively configured as a trunk</title>
<para>
<screen>(config-if)# switchport mode trunk
(config-if)# switchport nonegotiate</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Put the interface into permanent nontrunking mode</title>
<para>
<screen>(config-if)# switchport mode access</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display a summary of trunk-related information</title>
<para>
<screen>show interface trunk: Summary of trunk-related information</screen>
</para>
</formalpara>
<formalpara>
<title>Task: List trunking details for a specified interface</title>
<para>
<screen>show interface &lt;type number&gt; trunk</screen>
</para>
</formalpara>
<formalpara>
<title>Task: List nontrunking details for a particular interface</title>
<para>
<screen>show interface &lt;type number&gt; switchport</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display DTP information for the switch</title>
<para>
<screen># show dtp</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display DTP information for a specific interface</title>
<para>
<screen># show dtp interface &lt;type slot/number&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Enable trunking but disable DTP for routers</title>
<para>
<screen>! SW1
conf t
int e0/0
  switchport trunk enc dot1q
  switchport mode trunk
  switchport nonegotiate

! R1
conf t
int e0/0.1
  enc dot1q 123</screen>
</para>
</formalpara>
</section>
<section xml:id="_verify">
<title>Verify</title>
<simpara>What is TOS/TAT in</simpara>
<screen>sh dtp interface fa 0/19</screen>
</section>
</section>
<section xml:id="_isl">
<title>ISL</title>
<section xml:id="_overview_5">
<title>Overview</title>
<itemizedlist>
<listitem>
</listitem>
<listitem>
<simpara>Cisco proprietary</simpara>
</listitem>
<listitem>
<simpara>Provides VLAN trunking</simpara>
</listitem>
<listitem>
<simpara>Supports up to 1000 VLANs  (check ???)</simpara>
</listitem>
<listitem>
<simpara>Encapsulates the original header with 26-byte header</simpara>
</listitem>
<listitem>
<simpara>Removes the header at the receiving end</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_frame">
<title>Frame</title>
<simpara>The ISL frame consists of three fields: the ISL header( 26 bytes), the original frame and the FCS (4 bytes)</simpara>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/isl-frame.png" contentdepth="100"/>
</imageobject>
<textobject><phrase>isl frame</phrase></textobject>
</mediaobject>
</informalfigure>
<section xml:id="_field_descriptions">
<title>Field descriptions</title>
<variablelist>
<varlistentry>
<term>DADestination Address</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>40-bit</simpara>
</listitem>
<listitem>
<simpara>Multicast address: "0100-0C00-00" or "0300-0C00-00".</simpara>
</listitem>
<listitem>
<simpara>The first 40 bits of the DA field signal the receiver that the packet is in ISL format. ???</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>TYPEFrame Type</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>4 bits</simpara>
</listitem>
<listitem>
<simpara>Indicates the type of the original frame</simpara>
<itemizedlist>
<listitem>
<simpara>0000: 	Ethernet</simpara>
</listitem>
<listitem>
<simpara>0001: 	Token Ring</simpara>
</listitem>
<listitem>
<simpara>0010: 	FDDI</simpara>
</listitem>
<listitem>
<simpara>0011: 	ATM</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>USERUser Defined Bits (TYPE Extension)</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>4 bits</simpara>
</listitem>
<listitem>
<simpara>Extends the meaning of the TYPE field</simpara>
</listitem>
<listitem>
<simpara>Default value: "0000"</simpara>
</listitem>
<listitem>
<simpara>For Ethernet frames, the USER field bits "0" and "1" indicate the priority of the packet as
it passes through the switch. Whenever traffic can be handled in a manner that
allows it to be forwarded more quickly, the packets with this bit set should
take advantage of the quick path. It is not required that such paths be
provided.</simpara>
<itemizedlist>
<listitem>
<simpara>XX00 	Normal Priority</simpara>
</listitem>
<listitem>
<simpara>XX01 	Priority 1</simpara>
</listitem>
<listitem>
<simpara>XX10 	Priority 2</simpara>
</listitem>
<listitem>
<simpara>XX11 	Highest Priority</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>SASource Address</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>48 bits set to set MAC address of the switch port that transmits the frame.</simpara>
</listitem>
<listitem>
<simpara>May be ignored by the receiving device</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>LENLength</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>16 bits set to the length of the packet in bytes
with the exclusion of the DA, TYPE, USER, SA, LEN, and FCS fields.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<listitem>
<itemizedlist>
<listitem>
<simpara>24 bits set to "0xAAAA03".</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>HSAHigh Bits of Source Address</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>24 bits set to 0x00-00-0C (Cisco OUI) of the SA field.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>VLANDestination Virtual LAN ID</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>15 bits set to the VLAN ID of the frame</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>BPDUBPDU and CDP Indicator</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>1 bit set when STP or CDP encapsulates an ISL packet</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>INDXIndex</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>16 bits set to the port index of the source of the packet as it exits the switch</simpara>
</listitem>
<listitem>
<simpara>Used for diagnostic purposes only</simpara>
</listitem>
<listitem>
<simpara>May be ignored by the receiving bridge</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>RESReserved for Token Ring and FDDI</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>16 bits used when Token Ring or FDDI packets are encapsulated with an ISL frame</simpara>
<itemizedlist>
<listitem>
<simpara>In the case of Token Ring frames, the Access Control (AC) and Frame Control (FC) fields are placed here.</simpara>
</listitem>
<listitem>
<simpara>In the case of FDDI, the FC field is placed in the Least Significant Byte (LSB) of this field.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>For Ethernet packets, the RES field should be set to all zeros.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>ENCAP FRAMEEncapsulated Frame</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Encapsulated data packet with its own CRC value completely unmodified</simpara>
</listitem>
<listitem>
<simpara>Length from 1 to 24575 bytes</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>FCSFrame Check Sequence</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>4 bytes set by the sending MAC and recalculated by the receiving bridge</simpara>
</listitem>
<listitem>
<simpara>New FCS calculated over the entire ISL packet</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
</section>
</section>
</section>
<section xml:id="_ieee_802_1q">
<title>IEEE 802.1Q</title>
<section xml:id="_definition">
<title>Definition</title>
<itemizedlist>
<listitem>
<simpara>Tags frames on a trunk</simpara>
<itemizedlist>
<listitem>
<simpara>Inserts a 4-byte tag into the original frame between the Source Address and the Type/Length field</simpara>
</listitem>
<listitem>
</listitem>
<listitem>
<simpara>Removes the tag at the receiving end</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Does not tag frames on the native VLAN.</simpara>
<itemizedlist>
<listitem>
<simpara>Must use the same native VLAN on both sides of the trunk</simpara>
</listitem>
<listitem>
<simpara>Default to VLAN 1</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Supports up to 4096 VLANs</simpara>
<itemizedlist>
<listitem>
<simpara>Defines a single instance of spanning tree that runs on the native VLAN for all the VLANs in the network.</simpara>
</listitem>
<listitem>
<simpara>lacks the flexibility and load balancing capability of PVST that is available with ISL.</simpara>
</listitem>
<listitem>
<simpara>PVST+ offers the capability to retain multiple spanning tree topologies with 802.1Q trunking.</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</section>
<section xml:id="_frame_format">
<title>Frame Format</title>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/802-1q-frame.png"/>
</imageobject>
<textobject><phrase>802.1Q frame</phrase></textobject>
</mediaobject>
</informalfigure>
<section xml:id="_field_descriptions_2">
<title>Field descriptions</title>
<variablelist>
<varlistentry>
<term>TPIDTag Protocol Identifier</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>16 bits</simpara>
</listitem>
<listitem>
<simpara>Value: 08100</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Priority</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>3 bits</simpara>
</listitem>
<listitem>
<simpara>Called also user priority or IEEE 802.p</simpara>
</listitem>
<listitem>
<simpara>Indicates the frame priority level</simpara>
</listitem>
<listitem>
<simpara>Can be used to prioritize the traffic</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>CFICanonical Format Indicator</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>1 bit</simpara>
</listitem>
<listitem>
<simpara>Value: 0 if MAC address is in canonical format otherwise 1</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>VIDVLAN Identifier</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>12 bits</simpara>
</listitem>
<listitem>
<simpara>Identifies the VLAN to which the frame belongs</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
</section>
<section xml:id="_ethernet_frame_size_with_802_1q_tagging">
<title>Ethernet Frame Size with 802.1Q tagging</title>
<itemizedlist>
<listitem>
<simpara>Maximum size: 1522 bytes</simpara>
</listitem>
<listitem>
<simpara>Minimum size: 68 bytes</simpara>
</listitem>
</itemizedlist>
</section>
</section>
<section xml:id="_native_vlan">
<title>Native VLAN</title>
<formalpara>
<para>
<screen>(config-if)# switchport trunk native vlan &lt;id&gt;</screen>
</para>
</formalpara>
</section>
</section>
</chapter>
<chapter xml:id="_spanning_tree">
<title>Spanning tree</title>
<section xml:id="_stp">
<title>STP</title>
<itemizedlist>
<listitem>
<simpara>Creates loop-free layer 2 topology</simpara>
</listitem>
<listitem>
<simpara>prevents broadcast storms</simpara>
</listitem>
<listitem>
<simpara>STP variations:</simpara>
<itemizedlist>
<listitem>
<simpara>802.1d : Common Spanning Tree</simpara>
</listitem>
<listitem>
<simpara>PVST/PVST+: Cisco per-VLAN Spanning Tree</simpara>
</listitem>
<listitem>
<simpara>802.1w: Rapid Spanning Tree Protocol</simpara>
</listitem>
<listitem>
<simpara>802.1s: Multiple STP</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<section xml:id="_802_1d">
<title>802.1d</title>
<itemizedlist>
<listitem>
<simpara>Uses bpdu</simpara>
</listitem>
<listitem>
<simpara>Elect one root switch and one designated switch for each segment</simpara>
</listitem>
<listitem>
<simpara>One root port per non-root switch, one designated port for each segment</simpara>
</listitem>
<listitem>
<simpara>Other ports on blocking state</simpara>
</listitem>
<listitem>
<simpara>Steps</simpara>
<itemizedlist>
<listitem>
<simpara>elect the root switch with the lowest bridge id ( 2-byte priority + 6-byte MAC)</simpara>
</listitem>
<listitem>
<simpara>determine each switch&#8217;s root port: with the least cost path to the root</simpara>
</listitem>
<listitem>
<simpara>determine the designated port for each segment:
the switch that forwards the least cost hello on the segment</simpara>
</listitem>
<listitem>
<simpara>if there is a tie, select the lowest port ID</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Original ieee 802.1d bridge Id</simpara>
<itemizedlist>
<listitem>
<simpara>2-byte priority</simpara>
</listitem>
<listitem>
<simpara>6-byte MAC adress</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Revised ieee 802.1d brigde id Priority for MAC address reduction</simpara>
<itemizedlist>
<listitem>
<simpara>4 bits : priority multiple of 4096</simpara>
</listitem>
<listitem>
<simpara>12 bits : system id extension (vlan id ) to support pvst+ and ieee 802.1s</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<section xml:id="_root_port_election">
<title>Root port election</title>
<itemizedlist>
<listitem>
<simpara>RP is upstream facing towards Root bridge</simpara>
</listitem>
<listitem>
<simpara>lowest root path cost ( cumulative cost of all links to get to the root)</simpara>
</listitem>
<listitem>
<simpara>cost based on inverse bandwith</simpara>
</listitem>
</itemizedlist>
<table frame="all" rowsep="1" colsep="1">
<title>default port costs</title>
<tgroup cols="3">
<colspec colname="col_1" colwidth="33.3333*"/>
<colspec colname="col_2" colwidth="33.3333*"/>
<colspec colname="col_3" colwidth="33.3334*"/>
<thead>
<row>
<entry align="left" valign="top">Speed</entry>
<entry align="left" valign="top">original</entry>
<entry align="left" valign="top">revised</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>10 Mbps</simpara></entry>
<entry align="left" valign="top"><simpara>100</simpara></entry>
<entry align="left" valign="top"><simpara>100</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>100 Mbps</simpara></entry>
<entry align="left" valign="top"><simpara>10</simpara></entry>
<entry align="left" valign="top"><simpara>19</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>1 Gbps</simpara></entry>
<entry align="left" valign="top"><simpara>1</simpara></entry>
<entry align="left" valign="top"><simpara>4</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>10 Gbps</simpara></entry>
<entry align="left" valign="top"><simpara>1</simpara></entry>
<entry align="left" valign="top"><simpara>2</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<simpara>Tie breaker when a switch receives multiple Hellos with equal cost</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>lowest bridge id</simpara>
</listitem>
<listitem>
<simpara>lowest port priority</simpara>
</listitem>
<listitem>
<simpara>lowest port number</simpara>
</listitem>
</orderedlist>
<formalpara>
<title>Task: Force election of a root bridge</title>
<para>
<screen># spanning-tree vlan &lt;id&gt; root</screen>
</para>
</formalpara>
</section>
<section xml:id="_determining_the_designated_port">
<title>determining the designated port</title>
<itemizedlist>
<listitem>
<simpara>Designated switch: send the hello with the lowest advertised cost for the segment</simpara>
</listitem>
<listitem>
<simpara>DP: port that forward frames onto that segment</simpara>
</listitem>
<listitem>
<simpara>DP are downstream facing away from root bridge</simpara>
</listitem>
<listitem>
<simpara>elected based on lowest root path cost, BID, port ID</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_blocking_all_non_rp_and_non_dp_ports">
<title>blocking all non-RP and non-DP ports</title>
<itemizedlist>
<listitem>
<simpara>Receive BPDUs</simpara>
</listitem>
<listitem>
<simpara>discard all other traffic</simpara>
</listitem>
<listitem>
<simpara>cannot send traffic</simpara>
</listitem>
<listitem>
<simpara>do not send Hellos</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_convergence">
<title>Convergence</title>
<itemizedlist>
<listitem>
<simpara>Steady operations: one Root bridge, one RP on each non-root bridge, one DP on each segment, blocking state</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>root switch generates a Hello every 2 seconds</simpara>
</listitem>
<listitem>
<simpara>each RP on non root switch receives a copy of the root&#8217;s hello</simpara>
</listitem>
<listitem>
<simpara>each DP updates and forwards the hello out</simpara>
</listitem>
<listitem>
<simpara>each blocking port receives a copy of the hello from the DP without forwarding it</simpara>
</listitem>
</orderedlist>
</listitem>
</itemizedlist>
</section>
<section xml:id="_topology_change_notification">
<title>Topology change notification</title>
<simpara>more at
<orderedlist numeration="arabic">
<listitem>
<simpara>A switch experiencing the STP port state change sends a TCN BPDU out its Root Port; it
repeats this message every Hello time until it is acknowledged.</simpara>
</listitem>
<listitem>
<simpara>The next switch receiving that TCN BPDU sends back an acknowledgment via its next
forwarded Hello BPDU by marking the Topology Change Acknowledgment (TCA) bit in
the Hello.</simpara>
</listitem>
<listitem>
<simpara>The switch that was the DP on the segment in the first two steps repeats the first two steps,
sending a TCN BPDU out its Root Port, and awaiting acknowledgment from the DP on that
segment.</simpara>
</listitem>
</orderedlist>
<simpara>By each successive switch repeating Steps 1 and 2, eventually the root receives a TCN BPDU.
Once received, the root sets the TC flag on the next several Hellos, which are forwarded to all
switches in the network, notifying them that a change has occurred. A switch receiving a Hello
BPDU with the TC flag set uses the short (Forward Delay time) timer to time out entries in
the CAM.</simpara>
<simpara>Transitioning from blocking to forwarding</simpara>
<informaltable frame="all" rowsep="1" colsep="1">
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>state</simpara></entry>
<entry align="left" valign="top"><simpara>forward data frames</simpara></entry>
<entry align="left" valign="top"><simpara>learn source MAC</simpara></entry>
<entry align="left" valign="top"><simpara>stable?</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>blocking</simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>yes</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>listening</simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>learning</simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>forwarding</simpara></entry>
<entry align="left" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>yes</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>disabled</simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>stable</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
<section xml:id="_timers_2">
<title>Timers</title>
<variablelist>
<varlistentry>
<term>Hello timer</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>2 seconds</simpara>
</listitem>
<listitem>
<simpara>Interval at which the root sends Hellos</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>- Forward delay</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>15 seconds</simpara>
</listitem>
<listitem>
<simpara>Time that switch leaves a port in listening state and learning state</simpara>
</listitem>
<listitem>
<simpara>also used sd the short CAM timeout timer</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>- Maxage</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>20 seconds</simpara>
</listitem>
<listitem>
<simpara>Time without hearing a Hello before believing that the root has failed</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
</section>
<section xml:id="_pvst">
<title>PVST+</title>
<itemizedlist>
<listitem>
<simpara>Per-VLAN STP : for better load balancing</simpara>
<itemizedlist>
<listitem>
<simpara>one instance of legacy STP per VLAN</simpara>
</listitem>
<listitem>
<simpara>Cisco ISL support</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>PVST+</simpara>
<itemizedlist>
<listitem>
<simpara>one instance of legacy STP per VLAN</simpara>
</listitem>
<listitem>
<simpara>Cisco ISL and 802.1q support</simpara>
</listitem>
<listitem>
<simpara>interoperability between CST and PVST</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>default mode on most Catalyst platforms</simpara>
</listitem>
<listitem>
<simpara>allows root bridge/port placement per VLAN</simpara>
</listitem>
<listitem>
<simpara>Non-cisco + 802.1q &#8658; one Common Spanning Tree over vlan  1</simpara>
</listitem>
<listitem>
<simpara>When mixing cisco and non cisco switches with 802.1q trunking,</simpara>
<itemizedlist>
<listitem>
<simpara>send bpdu to multicast destination MAC of 0100.0CCC.CCCD</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</section>
<section xml:id="_configuration">
<title>configuration</title>
<simpara>show spanning-tree root
show spanning-tree vlan 1 root detail</simpara>
</section>
<section xml:id="_optimizing_improving_spanning_tree">
<title>optimizing, improving spanning tree</title>
<section xml:id="_portfast">
<title>PortFast</title>
<itemizedlist>
<listitem>
<simpara>Used on access ports connected to end users devices not other switches</simpara>
</listitem>
<listitem>
<simpara>Puts the port into forwarding state immediately</simpara>
</listitem>
<listitem>
<simpara>Prevent them to generate TCNs</simpara>
</listitem>
<listitem>
<simpara>Can generate loops if another switch is connected. so must be used with bpdu guard and root guard features</simpara>
</listitem>
</itemizedlist>
<screen>(cfg-if) spanning-tree portfast
(cfg) spanning-tree portfast default</screen>
</section>
<section xml:id="_uplinkfast">
<title>UplinkFast</title>
<itemizedlist>
<listitem>
<simpara>Used on access layer switches that have multiple uplinks to distribution/core switches</simpara>
</listitem>
<listitem>
<simpara>Immediately replaces a lost RP with an alternate RP</simpara>
</listitem>
<listitem>
<simpara>Increases the root and all port priority so the switch does not become root or transit switch</simpara>
</listitem>
<listitem>
<simpara>Time-out the correct entries in their CAMs but doesnt use the TCN process. Instead, finds all the MAC
addresses of local devices and sends one multicast frame with each local addresses as the source MAC
causing all the other switches to update their CAMs. The access switch also clears out the rest of the
entries in its own CAM.</simpara>
</listitem>
</itemizedlist>
<screen>(config)#  spanning-tree uplinkfast [max-update-rate rate]</screen>
</section>
<section xml:id="_backbonefast">
<title>BackboneFast</title>
<itemizedlist>
<listitem>
</listitem>
<listitem>
</listitem>
<listitem>
The RLQ asks the neighboring switch if that neighboring switch is still receiving Hellos from the root.
</listitem>
<listitem>
<simpara>All switches must have backbone fast configured</simpara>
</listitem>
</itemizedlist>
<screen>(config)#  spanning-tree backbonefast</screen>
</section>
</section>
<section xml:id="_bpdu_filter">
<title>bpdu filter</title>
<itemizedlist>
<listitem>
<simpara>Filter BPDUs in and out</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_bpdu_guard">
<title>bpdu guard</title>
<itemizedlist>
<listitem>
<simpara>Puts a (portfast enabled ???) port into the errdisable state when a BPDU is received and shuts down the port</simpara>
</listitem>
<listitem>
<simpara>The port must be manually re-enabled or it can be recovered automatically through the errdiable timeout function.</simpara>
</listitem>
<listitem>
<simpara>A port configured with bpdu guard will not be put into the root-inconsistent state.</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_loop_guard">
<title>loop guard</title>
<itemizedlist>
<listitem>
<simpara>Prevents non-designated ports from inadvertently forming layer 2 switching loops
if the flow of bpdus is interrupted.</simpara>
</listitem>
<listitem>
<simpara>Puts the port into the loop-inconsistent state when the steady flow of BPDUs is interrupted</simpara>
</listitem>
<listitem>
<simpara>Only used on point-to-point links</simpara>
</listitem>
<listitem>
<simpara>Can be used with <emphasis role="strong">UDLD aggressive mode</emphasis> to get extra protection.</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_root_guard">
<title>root guard</title>
<itemizedlist>
<listitem>
<simpara>Prevent a port from becoming a root port when receiving a superior bpdu (e.g. inferior priority + mac)</simpara>
</listitem>
<listitem>
<simpara>it is enabled on ports other than the root  port and on switches other than the root.</simpara>
</listitem>
<listitem>
<simpara>Puts the port in <emphasis role="strong">root-inconsistent</emphasis> state (no data flow) until it stops receiving superior BPDUs.
No traffic is forwarded.</simpara>
</listitem>
<listitem>
<simpara>enforce the root bridge placement by ensuring the the port on which root guard is enabled is the designated port.</simpara>
</listitem>
</itemizedlist>
<itemizedlist>
<listitem>
<simpara>Enforce the root bridge placement</simpara>
</listitem>
<listitem>
<simpara>Ensures that the port on which root guard is enabled is the designated port.</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_udld_2">
<title>UDLD</title>
<itemizedlist>
<listitem>
<simpara>unidirectional links:</simpara>
<itemizedlist>
<listitem>
<simpara>one of the 2 transmission path has failed but not both</simpara>
</listitem>
<listitem>
<simpara>due to miscabling, cutting on fiber cable, unplugging one fiber, GBIC problems, &#8230;&#8203;</simpara>
</listitem>
<listitem>
<simpara>can cause a loop as the previously blocking port will move to a forwarding state</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/stp-unidirectional-links.png" contentdepth="150"/>
</imageobject>
<textobject><phrase>stp unidirectional links</phrase></textobject>
</mediaobject>
</informalfigure>
<itemizedlist>
<listitem>
<simpara>solutions:</simpara>
<variablelist>
<varlistentry>
<term>UDLD <emphasis role="strong">u</emphasis>ni<emphasis role="strong">d</emphasis>irectional <emphasis role="strong">l</emphasis>ink <emphasis role="strong">d</emphasis>etection</term>
<listitem>
<simpara>Uses Layer 2 messaging to decide when a switch can no longer receive frames from
a neighbor. The switch whose transmit interface did not fail is placed into an err-disabled
state.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>UDLD aggressive mode</term>
<listitem>
<simpara>Attempts to reconnect with the other switch (eight times)
after realizing no messages have been received.
If the other switch does not reply to the repeated additional messages,
both sides become err-disabled.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Loop Guard</term>
<listitem>
<simpara>When normal BPDUs are no longer received,
the port does not go through normal STP convergence, but rather falls into an STP loop-inconsistent state.</simpara>
</listitem>
</varlistentry>
</variablelist>
</listitem>
</itemizedlist>
<simpara>In all cases, the formerly blocking port that would now cause a loop is prevented from migrating
to a forwarding state. With both types of UDLD, the switch can be configured to automatically
transition out of err-disabled state. With Loop Guard, the switch automatically puts the port back
into its former STP state when the original Hellos are received again.</simpara>
</section>
</section>
<section xml:id="_802_1w">
<title>802.1w</title>
<itemizedlist>
<listitem>
<simpara>Improves convergence by</simpara>
<itemizedlist>
<listitem>
<simpara>waiting for only 3 missed Hellos on an RP before flushing the CAM instead of 10 with 802.1d</simpara>
</listitem>
<listitem>
<simpara>bypass listening state</simpara>
</listitem>
<listitem>
<simpara>includes natively Cisco PortFast, UplinkFast, BackboneFast</simpara>
</listitem>
<listitem>
<simpara>add backup DP when multiple ports connected to the same segment</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>backward compatible with 802.1d although</simpara>
</listitem>
<listitem>
<simpara>All bridges generate BPDUs every Hello interval</simpara>
</listitem>
</itemizedlist>
<section xml:id="_rstp_link_types">
<itemizedlist>
<listitem>
<simpara><emphasis role="strong">Point-to-point</emphasis>: switch to switch</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">Shared</emphasis> : switch to hub</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">Edge</emphasis>: switch to single end-user device</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_rstp_port_states">
<title>RSTP port states</title>
<informaltable frame="all" rowsep="1" colsep="1">
<tgroup cols="3">
<colspec colname="col_1" colwidth="33.3333*"/>
<colspec colname="col_2" colwidth="33.3333*"/>
<colspec colname="col_3" colwidth="33.3334*"/>
<thead>
<row>
<entry align="left" valign="top">administrative state</entry>
<entry align="left" valign="top">802.1d</entry>
<entry align="left" valign="top">802.1w</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>disabled</simpara></entry>
<entry align="left" valign="top"><simpara>disabled</simpara></entry>
<entry align="left" valign="top"><simpara>discarding</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>enabled</simpara></entry>
<entry align="left" valign="top"><simpara>blocking</simpara></entry>
<entry align="left" valign="top"><simpara>discarding</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>enabled</simpara></entry>
<entry align="left" valign="top"><simpara>listening</simpara></entry>
<entry align="left" valign="top"><simpara>discarding</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>enabled</simpara></entry>
<entry align="left" valign="top"><simpara>learning</simpara></entry>
<entry align="left" valign="top"><simpara>learning</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>enabled</simpara></entry>
<entry align="left" valign="top"><simpara>forwarding</simpara></entry>
<entry align="left" valign="top"><simpara>forwarding</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
<section xml:id="_rstp_role_ports">
<title>RSTP role ports</title>
<variablelist>
<varlistentry>
<term>Root Port</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Same role as 802.1d RP</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Designated Port</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Same role as 802.1d DP</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Alternate Port</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>an alternate root port</simpara>
</listitem>
<listitem>
<simpara>same concept as Cisco UplinkFast feature</simpara>
</listitem>
<listitem>
<simpara>protects against the loss of a switch&#8217;s RP by keeping track of the AP with a path to the root</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Backup Port</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>no equivalent Cisco features</simpara>
</listitem>
<listitem>
<simpara>protects against losing the DP attached to a shared liknk
when the switch has another physical port attached to the same shared segment</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<note>
<simpara>root bridge ports are all designated port
unless 2 or more ports of the root bridge are connected together.</simpara>
</note>
<note>
<simpara>a port needs to receive BPDUs to stay blocked.</simpara>
</note>
</section>
<section xml:id="_configuration_2">
<title>configuration</title>
<formalpara>
<title>Task: Configure Rapid PVST</title>
<para>
<screen>(config)#  spanning-tree mode rapid-pvst</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>Rapid PVST+ immediately deletes dynamically learned MAC address entries
when it receives a topology change instead of a timer used by PVST+ or MST</simpara>
</listitem>
</itemizedlist>
</note>
</section>
</section>
<section xml:id="_802_1s">
<title>802.1s</title>
<itemizedlist>
<listitem>
<simpara>Multiple VLANs mapped to the same STP instance.</simpara>
</listitem>
<listitem>
<simpara>enable load balancing</simpara>
</listitem>
<listitem>
<simpara>improves fault tolerance of the network
because a failure in one instance or forwarding path does not affect other instances.</simpara>
</listitem>
<listitem>
<simpara>Uses 802.1w for rapid convergence</simpara>
</listitem>
<listitem>
<simpara>Highly scalable</simpara>
<itemizedlist>
<listitem>
<simpara>switches with same instance, configuration revision number and name form a <emphasis role="strong">region</emphasis></simpara>
</listitem>
<listitem>
<simpara>different regions see each other as virtual bridges</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>each switch have three attributes:</simpara>
<itemizedlist>
<listitem>
<simpara>alphanumeric configuration name (32 bytes)</simpara>
</listitem>
<listitem>
<simpara>configuration number (2 bytes)</simpara>
</listitem>
<listitem>
<simpara>4096-element table that associates each of the potential 4096 VLANs to a map ???</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<section xml:id="_storm_control">
<title>storm control</title>

</section>
<section xml:id="_unicast_flooding">
<title>unicast flooding</title>

</section>
</section>
<section xml:id="_troubleshooting_3">
<title>Troubleshooting</title>
<section xml:id="_flapping_port_that_is_generating_bpdus_with_the_tcn_bit_set">
<title>flapping port that is generating BPDUs with the TCN bit set</title>

</section>
</section>
<section xml:id="_questions">
<title>Questions</title>

</section>
</section>
<section xml:id="_mst">
<title>MST</title>
<section xml:id="_operations">
<title>operations</title>
<simpara>cst &#8594; 1 stp for all vlan
pvst &#8594; 1 stp for each vlan
mst &#8594; 1 stp per instance</simpara>
</section>
<section xml:id="_readings">
<title>readings</title>
</section>
</section>
</chapter>
<chapter xml:id="_etherchannel">
<title>EtherChannel</title>
<section xml:id="_etherchannel_2">
<title>EtherChannel</title>
<section xml:id="_overview_6">
<title>Overview</title>
<itemizedlist>
<listitem>
<simpara>EtherChannel aggregates bandwidth of up to 8 physical links</simpara>
</listitem>
<listitem>
<simpara>Consists of two parts:</simpara>
<itemizedlist>
<listitem>
<simpara>Port-channel interface: logical interface representing the bundle</simpara>
</listitem>
<listitem>
<simpara>Member interfaces: physical links part of the bundle</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Channel can be any type of interface:</simpara>
<itemizedlist>
<listitem>
<simpara>Layer 2 access, trunk, tunnel or layer 3 routed</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Configured as either Layer 2 or Layer 3 interfaces.</simpara>
</listitem>
<listitem>
<simpara>To be part of a PortChannel, both sides must agree on:</simpara>
<itemizedlist>
<listitem>
<simpara>Same speed and duplex settings</simpara>
</listitem>
<listitem>
<simpara>If not trunking, same access VLAN</simpara>
</listitem>
<listitem>
<simpara>If trunking, same trunk type, allowed VLANs, and native VLAN</simpara>
</listitem>
<listitem>
<simpara>On a single switch, each port in a PortChannel must have the same STP cost per VLAN on all links in the PortChannel</simpara>
</listitem>
<listitem>
<simpara>No ports with SPAN configured</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>When several EtherChannel bundles exist between two switches,
STP blocks one of the bundles to prevent redundant links.
When spanning tree blocks one of the redundant links, it blocks one EtherChannel,
</listitem>
<listitem>
</listitem>
<listitem>
</listitem>
<listitem>
<simpara>Each EtherChannel has a logical port-channel interface numbered from 1 to 64.
The channel groups are also numbered from 1 to 64.</simpara>
</listitem>
<listitem>
<simpara>When a port joins an EtherChannel, the physical interface for that port is shut down.</simpara>
</listitem>
<listitem>
<simpara>When the port leaves the port-channel, its physical interface is brought up,
and it has the same configuration as it had before joining the EtherChannel.</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_link_aggregation_protocol">
<itemizedlist>
<listitem>
<simpara>PAgP</simpara>
<itemizedlist>
<listitem>
<simpara>Maximum 8 ports</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>LACP</simpara>
<itemizedlist>
<listitem>
<simpara>Maximum 16 ports</simpara>
</listitem>
<listitem>
<simpara>Maximum 8 active ports and 8 standby ports</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Verify which negotiation protocol has been used for the EtherChannel</title>
<para>
<screen># show etherchannel protocol</screen>
</para>
</formalpara>
<formalpara>
<para>
<screen>(config-if)# channel-protocol {pagp | lacp}</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>The <emphasis role="strong">channel-group</emphasis> interface configuration command can also set the mode for the EtherChannel</simpara>
</listitem>
<listitem>
<simpara>If you set the protocol by using <emphasis role="strong">channel-protocol</emphasis>,
the setting is not overriden by the <emphasis role="strong">channel-group</emphasis> interface configuration command.</simpara>
</listitem>
</itemizedlist>
</note>
</section>
<section xml:id="_layer_2_etherchannels">
<title>Layer 2 EtherChannels</title>
<itemizedlist>
<listitem>
<simpara>Logical interfaces are dynamically created when using <emphasis role="strong">channel-group</emphasis> command.</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Configure layer 2 EtherChannels</title>
<para>
<screen>conf t
interface &lt;type slot/number&gt;
  switchport mode {access | trunk}
  channel-group n mode {active | passive | on | {auto [non-silent] | desirable [non-silent]  }</screen>
</para>
</formalpara>
</section>
<section xml:id="_layer_3_etherchannels">
<title>Layer 3 EtherChannels</title>
<formalpara>
<title>Task: Create the port channel logical interface</title>
<para>
<screen>conf t
interface port-channel &lt;number&gt;
  no switchport
  ip address &lt;a.b.c.d&gt; &lt;mask&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Assign the physical interfaces to the layer 3 port channel</title>
<para>
<screen>conf t
interface &lt;type id&gt;
  no switchport
  no ip address
  channel-group n mode {active | passive | on | {auto [non-silent] | desirable [non-silent]  }</screen>
</para>
</formalpara>
<tip>
<itemizedlist>
<listitem>
<simpara>Always issue the <emphasis role="strong">no switchport</emphasis> command before the <emphasis role="strong">channel-group</emphasis> command</simpara>
</listitem>
<listitem>
<simpara>If L3 port-channel configured properly, the <emphasis role="strong">show etherchannel summary</emphasis> command should show <emphasis role="strong">RU</emphasis> for routed and in use</simpara>
</listitem>
</itemizedlist>
</tip>
<figure>
<title>Relationship of Physical Ports, Logical Port Channels, and Channel Groups</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/etherchannel-relationships.png" contentdepth="150"/>
</imageobject>
<textobject><phrase>etherchannel relationships</phrase></textobject>
</mediaobject>
</figure>
</section>
<section xml:id="_etherchannel_modes">
<title>EtherChannel modes</title>
<table frame="all" rowsep="1" colsep="1">
<title>EtherChannel modes</title>
<tgroup cols="3">
<colspec colname="col_1" colwidth="15*"/>
<colspec colname="col_2" colwidth="15*"/>
<colspec colname="col_3" colwidth="70*"/>
<thead>
<row>
<entry align="left" valign="top">Cisco PAgP</entry>
<entry align="left" valign="top">802.1AD LACP</entry>
<entry align="left" valign="top">Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>on</simpara></entry>
<entry align="left" valign="top"><simpara>on</simpara></entry>
<entry align="left" valign="top"><simpara>disable negotiation and forces the port into the portChannel</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>off</simpara></entry>
<entry align="left" valign="top"><simpara>off</simpara></entry>
<entry align="left" valign="top"><simpara>disable negotiation and prevents the ports to be part of the portChannel</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>desirable</simpara></entry>
<entry align="left" valign="top"><simpara>active</simpara></entry>
<entry align="left" valign="top"><simpara>initiates the negotiation</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>auto</simpara></entry>
<entry align="left" valign="top"><simpara>passive</simpara></entry>
<entry align="left" valign="top"><simpara>waits on other side to start negotiation</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<formalpara>
<title>Task: Display EtherChannel status</title>
<para>
<screen># show etherchannel [group-number]</screen>
</para>
</formalpara>
<section xml:id="_pagp_and_lacp_interaction_with_other_features">
<title>PAgP and LACP Interaction with Other Features</title>
<itemizedlist>
<listitem>
<simpara>DTP and CDP send and receive packets over the physical interfaces in the EtherChannel.</simpara>
</listitem>
<listitem>
<simpara>PAgP and LACP transmit PDUs on the lowest numbered VLAN on the interfaces enable for (desirable,auto or active,passive)</simpara>
</listitem>
<listitem>
<simpara>STP sends packets over the first interface in the Etherchannel</simpara>
</listitem>
<listitem>
<simpara>The MAC address of a Layer 3 EtherChannel is the MAC address of the first interface in the port-channel.</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_load_balancing_and_forwarding_modes">
<title>Load balancing and forwarding modes</title>
<itemizedlist>
<listitem>
<simpara>Load balancing between member interface based on a combination of</simpara>
<itemizedlist>
<listitem>
<simpara>Source MAC address</simpara>
</listitem>
<listitem>
<simpara>Destination MAC address</simpara>
</listitem>
<listitem>
<simpara>Source IP address</simpara>
</listitem>
<listitem>
<simpara>Destination IP address</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Uses only source MAC address by default</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Configure the EtherChannel load-balancing method</title>
<para>
<screen>(config)# port-channel load-balance { dst-ip | dst-mac | src-dst-ip | src-dst-mac | src-ip | src-mac}</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display the EtherChannel load-balancing method</title>
<para>
<screen># show etherchannel load-balance

EtherChannel Load-Balancing Configuration:
src-mac

EtherChannel Load-Balancing Addresses Used Per-Protocol:
Non-IP: Source MAC address
IPv4: Source MAC address
IPv6: Source MAC address</screen>
</para>
</formalpara>
</section>
</section>
<section xml:id="_misconfiguration_guard">
<title>Misconfiguration guard</title>
<simpara>TODO</simpara>
</section>
</section>
<section xml:id="_lacp">
<title>LACP</title>
<section xml:id="_overview_7">
<title>Overview</title>
<itemizedlist>
<listitem>
<simpara>IEEE 802.3ad</simpara>
</listitem>
<listitem>
<simpara>Automatic creation of port channels</simpara>
</listitem>
<listitem>
<simpara>Multicast address IEEE 802.3 Slow Protocols: 0180-C200-0002</simpara>
</listitem>
<listitem>
<simpara>EtherType value: 0x8809</simpara>
</listitem>
<listitem>
<simpara>Timers: hellos every second during hand shake</simpara>
</listitem>
<listitem>
<simpara>Maximum: 16 ports with max 8 active</simpara>
</listitem>
</itemizedlist>
<section xml:id="_restrictions">
<title>Restrictions</title>

</section>
<section xml:id="_modes">
<title>Modes</title>
<variablelist>
<varlistentry>
<term>Passive</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Does not initiate LACP negotiation but responds to LACP packets</simpara>
</listitem>
<listitem>
<simpara>Default mode</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Active</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Initiate LACP negotiation by sending LACP packets</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>On</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Forces the interface to the channel without PAgP or LACP</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<simpara>Working Etherchannel for On-On, Passive-Active, Active-Active</simpara>
</section>
</section>
<section xml:id="_lacp_hot_standby_ports">
<title>LACP hot-standby ports</title>
<itemizedlist>
<listitem>
<simpara>Only 8 LACP links can be active at one time</simpara>
</listitem>
<listitem>
<simpara>Any additional links are in hot-standby mode</simpara>
</listitem>
<listitem>
<simpara>If one of the active links becomes inactive,
</listitem>
<listitem>
<itemizedlist>
<listitem>
<simpara>LACP system priority (1..65535, default: 32768)</simpara>
</listitem>
<listitem>
<simpara>System ID ( the switch MAC address)</simpara>
</listitem>
<listitem>
<simpara>LACP port priority</simpara>
</listitem>
<listitem>
<simpara>Port number</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>In priority comparisons, lower values have higher priority.</simpara>
</listitem>
<listitem>
<simpara>To determine which ports are active and which ports are hot standby,</simpara>
<itemizedlist>
<listitem>
<simpara>Select the master switch with a low system priority and system-id</simpara>
</listitem>
<listitem>
<simpara>Select the master ports with the low port priority and number.
The port-priority and port-number of the slave switch are not used.</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Check which ports are in the hot-standby mode</title>
<para>
<screen># show etherchannel summary</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure the LACP system priority</title>
<para>
<screen>(config)# lacp system-priority &lt;priority&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Show the LACP system priority</title>
<para>
<screen># show lacp sys-id</screen>
</para>
</formalpara>
<formalpara>
<title>Task: LACP port priority</title>
<para>
<screen>(config-if)# lacp port-prioriy</screen>
</para>
</formalpara>
</section>
<section xml:id="_lacp_port_channel_maxbundle_feature">
<title>LACP Port-channel MaxBundle feature</title>
<itemizedlist>
<listitem>
<simpara>Control the number of ports allowed to be bundled into the etherchannel</simpara>
</listitem>
<listitem>
<simpara>Allows hot-standby ports with fewer bundled ports</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Configure the maximum number of bundled ports allowed in a LACP port channel</title>
<para>
<screen>(config-if)# lacp max-bundle</screen>
</para>
</formalpara>
</section>
<section xml:id="_lacp_port_channel_min_links_feature">
<title>LACP Port-Channel Min-links feature</title>
<itemizedlist>
<listitem>
<simpara>Only for LACP Etherchannel</simpara>
</listitem>
<listitem>
<simpara>Prevents low-bandwidth interface from becoming active</simpara>
</listitem>
<listitem>
<simpara>Causes LACP etherChannels to become inactive if they have too feww active members ports to supply the required minimum bandwith</simpara>
</listitem>
</itemizedlist>
<formalpara>
<para>
</para>
</formalpara>
</section>
</section>
<section xml:id="_pagp">
<title>PAgP</title>
<section xml:id="_overview_8">
<title>Overview</title>
<itemizedlist>
<listitem>
<simpara><emphasis role="strong">P</emphasis>ort <emphasis role="strong">Ag</emphasis>gregation <emphasis role="strong">P</emphasis>rotocol</simpara>
</listitem>
<listitem>
<simpara>Cisco proprietary</simpara>
</listitem>
<listitem>
<simpara>Automatic creation of a EtherChannel.</simpara>
</listitem>
<listitem>
<simpara>Sends PagP packets every 30 seconds to multicast 0100-0CCC-CCCC</simpara>
</listitem>
<listitem>
<simpara>Same destination address than CDP, UDLD, VTP, and DTP.</simpara>
</listitem>
<listitem>
</listitem>
<listitem>
<simpara>Protocol value: 0x104</simpara>
</listitem>
<listitem>
<simpara>Cannot be enabled on cross-stack EtherChannel</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Display PAgP status</title>
<para>
<screen># show pagp [channel-group-number]</screen>
</para>
</formalpara>
</section>
<section xml:id="_modes_2">
<title>Modes</title>
<variablelist>
<varlistentry>
<term>Auto </term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Never initiates PAgP communications but instead listen passively for any received PAgP packets
before creating an EtherChannel with the neighboring switch.</simpara>
</listitem>
<listitem>
<simpara>Default mode</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Desirable </term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Initiates negotiations with other interfaces by sending PAgP packets.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>On </term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Forces the interface to channel without PAgP.</simpara>
</listitem>
<listitem>
<simpara>Do not exchange PAgP packets.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<simpara>Etherchannel formed for on-on, desirable-auto, desirable-desirable combinations.</simpara>
</section>
<section xml:id="_physical_vs_aggregate_learners">
<title>Physical vs Aggregate learners</title>
<simpara>Switches running PAgP are classified as:</simpara>
<variablelist>
<varlistentry>
<term>PAgP physical learners</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>learn MAC addresses using the physical ports within the EtherChannel instead
</listitem>
<listitem>
<simpara>forward traffic to addresses based on the physical port via which the address
was learned.  The switch will send packets to the neighboring switch using
the same port in the EtherChannel from which it learned the source address.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Aggregate learners</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>learns addresses based on the aggregate or logical EtherChannel port.</simpara>
</listitem>
<listitem>
<simpara>transmit packets to the source by using any of the interfaces in the EtherChannel.</simpara>
</listitem>
<listitem>
<simpara>Aggregate learning is the default.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<simpara>By default, PAgP is not able to detect whether a neighboring switch is a
physical learner. Therefore, when configuring PAgP EtherChannels on switches
that support only physical learning, the learning method must be manually set
to physical learning. It is important when running in this mode, to set the
load-distribution method to source-based distribution so that any given source
MAC address is always sent on the same physical port.</simpara>
<formalpara>
<title>Task: Configure the PAgP learning method</title>
<para>
<screen>(config-if)# pagp learn-method {physical-port | aggregation-port&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Verify the PAgP learning method</title>
<para>
<screen># show pagp [channel-group-number] internal</screen>
</para>
</formalpara>
</section>
<section xml:id="_priority">
<title>Priority</title>
<itemizedlist>
<listitem>
<simpara>Range: 0..255</simpara>
</listitem>
<listitem>
<simpara>Default: 128</simpara>
</listitem>
<listitem>
<simpara>The higher the priority, the more likely that the port will be used for PAgP transmission</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Assign a priority so that the selected port is chosen for packet transmission.</title>
<para>
<screen>(config-if)# pagp port-priority &lt;priority&gt;</screen>
</para>
</formalpara>
</section>
<section xml:id="_restrictions_2">
<title>Restrictions</title>
<simpara>While PAgP allows for all links within the EtherChannel to be used to forward
and receive user traffic, there are some restrictions:</simpara>
<itemizedlist>
<listitem>
<simpara>DTP and CDP send and receive packets over all the physical interfaces in the EtherChannel,
while PAgP sends and receives PAgP PDU only from interfaces that are
up and have PAgP enabled for auto or desirable modes.</simpara>
</listitem>
<listitem>
<simpara>When an EtherChannel bundle is configured as a trunk port,
the trunk sends and receives PAgP frames on the lowest numbered VLAN.
STP always chooses the first operational port in an EtherChannel bundle.</simpara>
</listitem>
<listitem>
<simpara>When configuring additional STP features such as Loop Guard on an EtherChannel,
remember that if Loop Guard blocks the first port,
no BPDUs will be sent over the channel,
even if other ports in the channel bundle are operational.
This is because PAgP will enforce uniform Loop Guard configuration on all of the ports that are part of the EtherChannel group.</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_configuration_3">
<title>Configuration</title>
<section xml:id="_validate_the_port_that_will_be_used_by_stp_to_send_packets_and_receive_packets">
<title>Validate the port that will be used by STP to send packets and receive packets</title>
<screen>Switch#show pagp neighbor
Flags:  S  Device is sending Slow hello.  C  Device is in Consistent state.
A  Device is in Auto mode.        P  Device learns on physical port.

Channel group 4 neighbors
Partner     Partner             Partner         Partner   Group
Port        Name                Device ID       Port       Age  Flags   Cap.
Gi1/1/3     Switch.1            00c5.a003.0080   Gi0/1     4s   SC      10001
Gi1/1/4     Switch.1            00c5.a003.0080   Gi0/2     3s   SC      10001</screen>
<simpara>STP will send packets only out of port Gi1/1/3
because it is the first operational interface.
If that port fails,
STP will send packets out of Gi1/1/4.</simpara>
</section>
</section>
<section xml:id="_silent_mode">
<title>Silent mode</title>
<formalpara>
<title>Task: Configure a switch port for nonsilent operation</title>
<para>
<screen></screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure a switch port for nonsilent operation</title>
<para>
<screen></screen>
</para>
</formalpara>
<simpara>TODO
You can also configure a single interface within the group for all
transmissions and use other interfaces for hot standby. The unused interfaces
in the group can be swapped into operation in just a few seconds if the
selected single interface loses hardware-signal detection.</simpara>
</section>
</section>
</chapter>
<chapter xml:id="_monitoring">
<title>Monitoring</title>
<section xml:id="_span">
<title>SPAN</title>

</section>
</chapter>
<chapter xml:id="_multicast">
<title>Multicast</title>
<section xml:id="_igmp">
<title>IGMP</title>
<simpara>Check also
<section xml:id="_concepts_2">
<title>Concepts</title>
<itemizedlist>
<listitem>
<simpara>Group membership protocol used by hosts to inform routers and multilayer switches of the
existence of members on their directly connected networks and to allow them to send and receive multicast datagrams.</simpara>
</listitem>
<listitem>
<simpara>IP protocol number: 2</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_messages">
<title>Messages</title>
<itemizedlist>
<listitem>
<simpara>membership queries:</simpara>
<itemizedlist>
<listitem>
<simpara>general:  sent to 224.0.0.1 (all systems on a subnet)</simpara>
</listitem>
<listitem>
<simpara>group-specific: sent to the group</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>membership reports</simpara>
<itemizedlist>
<listitem>
<simpara>sollicited: sent to the group in v2, sent to 224.0.0.22 in v3</simpara>
</listitem>
<listitem>
<simpara>unsollicited</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Leave Group messages</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_default_igmp_configuration">
<title>Default IGMP configuration</title>
<informaltable frame="all" rowsep="1" colsep="1">
<tgroup cols="2">
<colspec colname="col_1" colwidth="54.5454*"/>
<colspec colname="col_2" colwidth="45.4546*"/>
<thead>
<row>
<entry align="left" valign="top">Feature</entry>
<entry align="left" valign="top">Default Setting</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>IGMP version</simpara></entry>
<entry align="left" valign="top"><simpara>Version 2 on all interfaces.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>IGMP query timeout</simpara></entry>
<entry align="left" valign="top"><simpara>60 seconds on all interfaces.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>IGMP maximum query response time</simpara></entry>
<entry align="left" valign="top"><simpara>10 seconds on all interfaces.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Multilayer switch as a member of a multicast group</simpara></entry>
<entry align="left" valign="top"><simpara>No group memberships are defined.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Access to multicast groups</simpara></entry>
<entry align="left" valign="top"><simpara>All groups are allowed on an interface.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>IGMP host-query message interval</simpara></entry>
<entry align="left" valign="top"><simpara>60 seconds on all interfaces.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Multilayer switch as a statically connected member</simpara></entry>
<entry align="left" valign="top"><simpara>Disabled.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<formalpara>
<title>Task: Display multicast-related information about an interface.</title>
<para>
<screen># show ip igmp interface [interface-id]</screen>
</para>
</formalpara>
<section xml:id="_igmp_version">
<title>IGMP version</title>
<variablelist>
<varlistentry>
<term>v1</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>general membership queries</simpara>
</listitem>
<listitem>
<simpara>join</simpara>
</listitem>
<listitem>
<simpara>implicit leave</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>v2</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>group-specific queries</simpara>
</listitem>
<listitem>
<simpara>explicit leave group process</simpara>
</listitem>
<listitem>
<simpara>explicit max response time field</simpara>
</listitem>
<listitem>
<simpara>querier election'</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>v3</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>source filtering</simpara>
</listitem>
<listitem>
<simpara>uses 224.0.0.22 for membership reports</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<formalpara>
<title>Task: Specify the IGMP version</title>
<para>
<screen>(config-if)# ip igmp version {1 | 2 | 3}</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Return to the default version</title>
<para>
<screen>(config-if)# no ip igmp version</screen>
</para>
</formalpara>
<note>
<simpara>If you change to version 1, you cannot configure the <emphasis role="strong">ip igmp query-interval</emphasis> or the <emphasis role="strong">ip igmp query-max-response-time</emphasis> interface configuration
commands.</simpara>
</note>
</section>
<section xml:id="_querier_election">
<title>Querier election</title>
<itemizedlist>
<listitem>
<simpara>Each IGMPv2 router sends general query message to 224.0.0.1 with its interface source address.</simpara>
</listitem>
<listitem>
<simpara>The router stops upon receiption of query messages with lowest IP address
&#8594; The router with the lowest IP address wins</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_igmpv2_query_timeout">
<title>IGMPv2 query timeout</title>
<itemizedlist>
<listitem>
<simpara>period of time before the multilayer switch takes over as the querier for the interface.</simpara>
</listitem>
<listitem>
<simpara>By default, the switch waits twice the query interval. After that time, if the switch has received no queries, it becomes the querier.</simpara>
</listitem>
</itemizedlist>
<screen>(config-if)# ip igmp querier-timeout &lt;60-300-seconds&gt;</screen>
</section>
<section xml:id="_maximum_response_time_field">
<title>Maximum response time field</title>
<itemizedlist>
<listitem>
<simpara>v1, fixed at 10 seconds</simpara>
</listitem>
<listitem>
<simpara>v2, can be changed to control the burstiness of the response process especially with large number of active routers.
  Note that increasing the maximum response timer value also increases the leave
latency; the query router must now wait longer to make sure there are no more
hosts for the group on the subnet.</simpara>
</listitem>
<listitem>
<simpara>Default:10 seconds, range: 1..25.</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task:Change the maximum response time field</title>
<para>
<screen>(config-if)# ip igmp query-max-response-time &lt;seconds&gt;</screen>
</para>
</formalpara>
</section>
</section>
<section xml:id="_join_the_club">
<title>Join the club</title>
<formalpara>
<title>Task: Join a specified group</title>
<para>
<screen>(config-if)# ip igmp join-group &lt;address&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Join a specified (S,G) channel</title>
<para>
<screen>(config-if)# ip igmp join-group &lt;address&gt; source &lt;a.b.c.d&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display the multicast groups that are directly connected to the multilayer switch and that were learned through IGMP.</title>
<para>
<screen># sh ip igmp groups [group-name | group-address | type number]</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Forward multicast packet without accepting them</title>
<para>
<screen>(config-if)# ip igmp static-group</screen>
</para>
</formalpara>
<note>
<simpara>This method allows fast switching.
The outgoing interface appears in the IGMP cache,
but the switch itself is not a member,
as evidenced by lack of an L (local) flag in the multicast route entry.</simpara>
</note>
<screen>(config-if)# ip igmp static-group</screen>
</section>
<section xml:id="_leave_process">
<title>Leave process</title>
<itemizedlist>
<listitem>
<simpara>in v1, implicit exit</simpara>
</listitem>
<listitem>
<simpara>in v2,</simpara>
<itemizedlist>
<listitem>
<simpara>host send leave group message to group address,</simpara>
</listitem>
<listitem>
<simpara>querier send <emphasis role="strong">igmp-last-member-query-count</emphasis> group-specific queries at <emphasis role="strong">igmp-last-member-interval</emphasis> milliseconds</simpara>
</listitem>
<listitem>
<simpara>querier stops forwarding for the group if no reply within timeout period</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Specify the last member query interval</title>
<para>
<screen>(config-if)# ip igmp last-member-query-interval &lt;milliseconds&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Specify the last member query count</title>
<para>
<screen>(config-if)# ip igmp last-member-query-count &lt;1-7&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Minimize the leave latency when only one IGMPv2 receiver is connected to the interface</title>
<para>
<screen>(config-if)# ip igmp immediate-leave group-list &lt;acl&gt;</screen>
</para>
</formalpara>
<note>
<simpara>Can also be in global mode but not combined with the interface mode</simpara>
</note>
</section>
<section xml:id="_igmp_message_restriction">
<title>IGMP message restriction</title>
<formalpara>
<title>Task: Restrict receivers on a subnet to join only certain multicast groups</title>
<para>
<screen>(config-if)# ip igmp access-group &lt;standard-acl&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Restrict receivers on a subnet to join  multicast groups from specific sources</title>
<para>
<screen>(config-if)# ip igmp access-group &lt;extended-acl&gt;</screen>
</para>
</formalpara>
</section>
<section xml:id="_igmp_proxy">
<title>IGMP proxy</title>
<simpara>TODO</simpara>
</section>
<section xml:id="_igmp_snooping">
<title>IGMP snooping</title>
<itemizedlist>
<listitem>
<simpara>Problem: L2 switch forwards multicast packets to all interfaces &#8594; wasted traffic</simpara>
</listitem>
<listitem>
<simpara>Solution: Tracks IGMP messages (Join/Leave) to only forward invites to interested parties.</simpara>
<itemizedlist>
<listitem>
<simpara>Add ports when receiving Join message</simpara>
</listitem>
<listitem>
<simpara>Delete ports when Leave messages or no membership reports from clients</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<table frame="all" rowsep="1" colsep="1">
<title>Default IGMP snooping configuration</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="54.5454*"/>
<colspec colname="col_2" colwidth="45.4546*"/>
<thead>
<row>
<entry align="left" valign="top">Feature</entry>
<entry align="left" valign="top">Default Setting</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>IGMP snooping</simpara></entry>
<entry align="left" valign="top"><simpara>Enabled globally and per VLAN</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Multicast routers</simpara></entry>
<entry align="left" valign="top"><simpara>None configured</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Multicast router learning method</simpara></entry>
<entry align="left" valign="top"><simpara>PIM-DVMRP</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>IGMP snooping Immediate Leave</simpara></entry>
<entry align="left" valign="top"><simpara>Disabled</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Static groups</simpara></entry>
<entry align="left" valign="top"><simpara>None configured</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>TCN flood query count</simpara></entry>
<entry align="left" valign="top"><simpara>2</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>TCN query solicitation</simpara></entry>
<entry align="left" valign="top"><simpara>Disabled</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>IGMP snooping querier</simpara></entry>
<entry align="left" valign="top"><simpara>Disabled</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>IGMP report suppression</simpara></entry>
<entry align="left" valign="top"><simpara>Enabled</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<formalpara>
<title>Task: Display IGMP snooping information</title>
<para>
<screen># sh ip igmp snooping</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Disable IGMP snooping globally</title>
<para>
<screen>(config)# no ip igmp snooping</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Enable VLAN snooping</title>
<para>
<screen>(config)# ip igmp snooping vlan &lt;1-1001,1006-4094&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Change the snooping method</title>
<para>
<screen>(config)# ip igmp snooping vlan &lt;vlan-id&gt; mrouter learn {cgmp | pim-dvmrp}</screen>
</para>
</formalpara>
<section xml:id="_multicast_router_port">
<title>Multicast router port</title>
<formalpara>
<title>Task: Add a multicast router port</title>
<para>
<screen>(config)# ip igmp snooping vlan &lt;id&gt; mrouter interface &lt;type-number&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Verify that IGMP snooping is enabled on the VLAN interface</title>
<para>
<screen>(config)# sh ip igmp snooping mrouter vlan &lt;id&gt;</screen>
</para>
</formalpara>
</section>
<section xml:id="_statically_join_a_group">
<title>Statically join a group</title>
<formalpara>
<title>Task: Add a L2 port to join a group</title>
<para>
<screen>ip igmp snooping vlan &lt;vlan-id&gt; static &lt;ip-address&gt; interface &lt;type number&gt;</screen>
</para>
</formalpara>
<note>
<simpara>Hosts or L2 ports normally join multicast groups dynamically</simpara>
</note>
<formalpara>
<title>Task: Verify the member port and the IP address</title>
<para>
<screen># sh ip igmp snooping groups</screen>
</para>
</formalpara>
</section>
<section xml:id="_igmp_immediate_leave">
<title>IGMP immediate leave</title>
<formalpara>
<title>Task: Remove a port immediately when it detects an IGMPv2 leave message</title>
<para>
<screen>(config)# ip igmp snooping vlan &lt;id&gt; immediate-leave</screen>
</para>
</formalpara>
<section xml:id="_igmp_leave_timer">
<title>IGMP leave Timer</title>
<formalpara>
<title>Task: configure the IGMP leave timer globally</title>
<para>
<screen>ip igmp snooping last-member-query-interval &lt;milliseconds&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: configure the IGMP leave timer on the VLAN interface</title>
<para>
<screen>ip igmp snooping vlan &lt;id&gt; last-member-query-interval &lt;milliseconds&gt;</screen>
</para>
</formalpara>
</section>
</section>
<section xml:id="_tcn_events">
<title>TCN Events</title>
<itemizedlist>
<listitem>
<simpara>when the client changed its loaction and the receiver is on smae port that was blocked but is now forwarding,</simpara>
</listitem>
<listitem>
<simpara>when a port went down without sending a leave message.</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Control the multicast flooding time after a TCN event</title>
<para>
<screen>(config)# ip igmp snooping tcn flood query count &lt;1-2-10&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Speed the process of recovering from the flood mode caused by a TCN event.</title>
<para>
<screen>(config)# ip igmp snooping tcn query solicit</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>When a topology change occurs, the spanning-tree root sends a IGMP global leave with group 0.0.0.0.</simpara>
</listitem>
<listitem>
<simpara>however, after <emphasis role="strong">ip igmp snooping tcn query solicit</emphasis> command,
the switch sneds the global leave message whether or not it is the spanning-tree root.</simpara>
</listitem>
<listitem>
<simpara>When the router receives this special leave, it immediately sends general queries,
which expedite the process of recovering from the flood mode during the TCN event.</simpara>
</listitem>
</itemizedlist>
</note>
<formalpara>
<title>Task: Disable the flooding of multicast traffic during a TCN event</title>
<para>
<screen>(config-if)# no ip igmp snooping tcn flood</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>When the swith receives a TCN, multicast traffic is flooded to all the ports until 2 general queries are received.</simpara>
</listitem>
<listitem>
<simpara>If the switch has many ports with attached hosts subscribed to many groups,
</listitem>
</itemizedlist>
</note>
</section>
<section xml:id="_igmp_snooping_querier">
<title>IGMP snooping querier</title>
<formalpara>
<title>Task: Enable IGMP snooping querier</title>
<para>
<screen>(config)# ip igmp snooping querier
(config)# ip igmp snooping querier address &lt;ip.ad.re.ss&gt;
(config)# ip igmp snooping querier query-interval &lt;seconds&gt;
(config)# ip igmp snooping querier tcn query [count &lt;n&gt; | interval &lt;seconds&gt;]
(config)# ip igmp snooping querier timer expiry &lt;seconds&gt;
(config)# ip igmp snooping querier version {1 | 2}</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display information about the IP address and receiving port for the most-recently received IGMP query in the VLAN</title>
<para>
<screen># sh ip igmp snooping querier [vlan &lt;id&gt;] [detail]</screen>
</para>
</formalpara>
</section>
<section xml:id="_igmp_report_suppression">
<title>IGMP report suppression</title>
<formalpara>
<title>Task: Disable IGMP report suppression</title>
<para>
<screen>(config)# no ip igmp snooping report-suppression</screen>
</para>
</formalpara>
</section>
</section>
<section xml:id="_mvr">
<title>MVR</title>
<itemizedlist>
<listitem>
<simpara>Multicast VLAN Registration</simpara>
</listitem>
<listitem>
<simpara>Problem: How to scale multicast traffic accross an Ethernet ring-based SP network</simpara>
</listitem>
<listitem>
<simpara>Solution : one multicast VLAN shared with subscribers in seperate VLANs</simpara>
</listitem>
<listitem>
<simpara>Use case: broadcast of multiple TV channels over a service-provider network</simpara>
</listitem>
<listitem>
<simpara>works with or without IGMP snooping</simpara>
<itemizedlist>
<listitem>
<simpara>If both enabled, MVR reacts only to join and leave messages from MVR groups.</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<table frame="all" rowsep="1" colsep="1">
<title>Default MVR configuration</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="66.6666*"/>
<colspec colname="col_2" colwidth="33.3334*"/>
<thead>
<row>
<entry align="left" valign="top">Feature</entry>
<entry align="left" valign="top">Default Setting</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>MVR</simpara></entry>
<entry align="left" valign="top"><simpara>Disabled globally and per interface</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Multicast addresses</simpara></entry>
<entry align="left" valign="top"><simpara>None configured</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Query response time</simpara></entry>
<entry align="left" valign="top"><simpara>0.5 second</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Multicast VLAN</simpara></entry>
<entry align="left" valign="top"><simpara>VLAN 1</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Mode</simpara></entry>
<entry align="left" valign="top"><simpara>Compatible</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Interface (per port) default</simpara></entry>
<entry align="left" valign="top"><simpara>Neither a receiver nor a source port</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Immediate Leave</simpara></entry>
<entry align="left" valign="top"><simpara>Disabled on all ports</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<section xml:id="_mvr_global_parameters">
<title>MVR global parameters</title>
<formalpara>
<title>Task: Enable MVR on the switch</title>
<para>
<screen>(config)# mvr</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure a range of IP multicast address on the switch</title>
<para>
<screen>(config)# mvr group &lt;ip-address&gt; [count]</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>The <emphasis role="strong">count</emphasis> parameter configure a contiguous series of MVR group addresses. Default= 1 in 1..256</simpara>
</listitem>
<listitem>
<simpara>Any multicast data sent to the ip address  corresponding to one TV channel
is sent to all source ports on the switch and all interested receiver ports.</simpara>
</listitem>
</itemizedlist>
</note>
<formalpara>
<title>Task: Define the maximum time to wait for IGMP report memberships on a receiver port</title>
<para>
<screen>(config)# mvr querytime &lt;tenths-of-seconds&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Specify the VLAN in which multicast data is received</title>
<para>
<screen>(config)# mvr vlan &lt;vlan-id&gt;</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>All source ports must belong to this VLAN</simpara>
</listitem>
</itemizedlist>
</note>
<formalpara>
<title>Task: Specify the MVR mode of operation</title>
<para>
<screen>(config)# mvr mode { dynamic | compatible }</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara><emphasis role="strong">dynamic</emphasis>: allows dynamic MVR memberships on source ports.</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">compatible</emphasis> is the default and does not support ICMP dynamic joins on source ports.</simpara>
</listitem>
</itemizedlist>
</note>
<formalpara>
<title>Task: Verify the MVR global configuration</title>
<para>
<screen>(config)# sh mvr
(config)# sh mvr members</screen>
</para>
</formalpara>
</section>
<section xml:id="_mvr_interfaces">
<title>MVR interfaces</title>
<formalpara>
<title>Task: configure an MVR port as source</title>
<para>
<screen>(config-if)# mvr type source</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>Configure uplinks ports that receive and send multicast data as source ports</simpara>
</listitem>
<listitem>
<simpara>Subscribers cannot be directly connected to source ports</simpara>
</listitem>
<listitem>
<simpara>All source ports on a switc belong to the single multicast VLAN.</simpara>
</listitem>
</itemizedlist>
</note>
<formalpara>
<title>Task: configure an MVR port as receiver</title>
<para>
<screen>(config-if)# mvr type receiver</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>Configure a port as a receiver port if it is a subscriber port and should only recieve multicast data.</simpara>
</listitem>
<listitem>
<simpara>Receiver ports do not receive data unless it becomes a member of the multicast group.</simpara>
</listitem>
<listitem>
<simpara>Receiver ports cannot belongs to the multicast VLAN.</simpara>
</listitem>
</itemizedlist>
</note>
<formalpara>
<title>Task: Statically configure a port to receive multicast traffic</title>
<para>
<screen>(config)# mvr vlan &lt;id&gt; group &lt;ip-address&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Enable the Immediate-Leave feature of MVR on the receiver port</title>
<para>
<screen>(config)# mvr immediate</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Verify the MVR interface configuration</title>
<para>
<screen># sh mvr interface</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display all receiver and source ports that are members of a multicast group</title>
<para>
<screen># sh mvr members [group-ip-address]</screen>
</para>
</formalpara>
</section>
</section>
<section xml:id="_igmp_filtering_and_throttling">
<title>IGMP filtering and throttling</title>
<table frame="all" rowsep="1" colsep="1">
<title>Default IGMP filtering configuration</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="66.6666*"/>
<colspec colname="col_2" colwidth="33.3334*"/>
<thead>
<row>
<entry align="left" valign="top">Feature</entry>
<entry align="left" valign="top">Default Setting</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Filters</simpara></entry>
<entry align="left" valign="top"><simpara>none applied</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>profiles</simpara></entry>
<entry align="left" valign="top"><simpara>none defined</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>profile action</simpara></entry>
<entry align="left" valign="top"><simpara>deny the range addresses</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<section xml:id="_igmp_profiles">
<title>IGMP profiles</title>
<formalpara>
<title>Task: Configure an IGMP profile</title>
<para>
<screen>(config)# ip igmp profile &lt;number&gt;
(config-igmp-profile)# permit | deny
(config-igmp-profile)# range &lt;low-ip-address&gt; [&lt;high-ip-address&gt;]</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Apply IGMP profile to an interface</title>
<para>
<screen>(config)# ip igmp filter &lt;profile-number&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Verify the profile configuration</title>
<para>
<screen># sh ip igmp profile &lt;number&gt;</screen>
</para>
</formalpara>
</section>
<section xml:id="_igmp_throttling">
<title>IGMP throttling</title>
<formalpara>
<title>Task: Set the maximum number of IGMP groups that the interface can join</title>
<para>
<screen>(config-if)# ip igmp max-groups &lt;count&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Specify the action that the interface takes when it reaches the maximum number of entries and receives a new IGMP report</title>
<para>
<screen>(config-if)# ip igmp max-groups action {deny | replace }</screen>
</para>
</formalpara>
</section>
</section>
</section>
<section xml:id="_pim">
<title>PIM</title>
<section xml:id="_understanding">
<title>Understanding</title>
<itemizedlist>
<listitem>
<simpara>protocol-independent</simpara>
<itemizedlist>
<listitem>
<simpara>relies on unicast routing table to perform RPF check</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<section xml:id="_versions">
<title>Versions</title>
<section xml:id="_pimv1">
<title>PIMv1</title>
<itemizedlist>
<listitem>
<simpara>Introduced in IOS 11.1(6)</simpara>
</listitem>
<listitem>
<simpara>Support Auto-RP : eliminates the need to manually configure the rendezvous point in every router.</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_pimv2">
<title>PIMv2</title>
<itemizedlist>
<listitem>
<simpara>Default version since IOS 11.3</simpara>
</listitem>
<listitem>
<simpara>Support BSR (boot strap router) capability.</simpara>
</listitem>
<listitem>
<simpara>A single, active RP exists per multicast group, with multiple backup RPs. This single RP compares to multiple active RPs for the same group in PIMv1.</simpara>
</listitem>
<listitem>
<simpara>A BSR provides a fault-tolerant, automated RP discovery and distribution mechanism that enables routers and multilayer switches to dynamically learn the group-to-RP mappings.</simpara>
</listitem>
<listitem>
<simpara>Sparse mode and dense mode are properties of a group, as opposed to an interface. We strongly recommend sparse-dense mode, as opposed to either sparse mode or dense mode only.</simpara>
</listitem>
<listitem>
<simpara>PIM join and prune messages have more flexible encoding for multiple address families.</simpara>
</listitem>
<listitem>
<simpara>A more flexible hello packet format replaces the query packet to encode current and future capability options.</simpara>
</listitem>
<listitem>
<simpara>Register messages to an RP specify whether they are sent by a border router or a designated router.</simpara>
</listitem>
<listitem>
<simpara>PIM packets are no longer inside IGMP packets; they are standalone packets.</simpara>
</listitem>
</itemizedlist>
</section>
</section>
<section xml:id="_modes_3">
<title>Modes</title>
<simpara>PIM can operate in dense mode (DM), sparse mode (SM), or in sparse-dense mode
(PIM DM-SM), which handles both sparse groups and dense groups at the same
time.</simpara>
<section xml:id="_pim_dm">
<title>PIM DM</title>
<simpara>In dense mode, a PIM DM router  assumes that all other
routers es forward multicast packets for a group. If a PIM
DM device receives a multicast packet and has no directly connected members or
PIM neighbors present, a prune message is sent back to the source. Subsequent
multicast packets are not flooded to this router or switch on this pruned
branch. PIM DM builds source-based multicast distribution trees.</simpara>
<simpara>The simplest form of a multicast distribution tree is a source tree whose root
is the source of the multicast traffic and whose branches form a spanning tree
through the network to the receivers. Because this tree uses the shortest path
through the network, it is also referred to as a shortest-path tree (SPT). A
separate SPT exists for every individual source sending to each group. The
special notation of (S,G) (pronounced S comma G) identifies an SPT where S is
the IP address of the source and G is the multicast group address.</simpara>
<simpara><xref linkend="x1"/> shows an example of SPT for group 224.1.1.1 rooted at the source,
Host A, and connecting two receivers, Hosts B and C. The SPT notation for this
group would be (194.1.1.1, 224.1.1.1).</simpara>
<figure xml:id="x1">
<title>Host A Shortest-Path Tree</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/pim-shortest-path-tree.png"/>
</imageobject>
<textobject><phrase>pim shortest path tree</phrase></textobject>
</mediaobject>
</figure>
<simpara>If Host B is also sending traffic to group 224.1.1.1 and Hosts A and C are
receivers, then a separate (S,G) SPT would exist with the notation of
(194.2.2.2, 224.1.1.1).</simpara>
<simpara>PIM DM employs only SPTs to deliver (S,G) multicast traffic by using a flood
and prune method. It assumes that every subnet in the network has at least one
receiver of the (S,G) multicast traffic, and therefore the traffic is flooded
to all points in the network.</simpara>
<simpara>To avoid unnecessary consumption of network resources, PIM DM devices send
prune messages up the source distribution tree to stop unwanted multicast
traffic. Branches without receivers are pruned from the distribution tree,
leaving only branches that contain receivers. Prunes have a timeout value
associated with them, after which the PIM DM device puts the interface into the
forwarding state and floods multicast traffic out the interface. When a new
receiver on a previously pruned branch of the tree joins a multicast group, the
PIM DM device detects the new receiver and immediately sends a graft message up
the distribution tree toward the source. When the upstream PIM DM device
receives the graft message, it immediately puts the interface on which the
graft was received into the forwarding state so that the multicast traffic
begins flowing to the receiver.</simpara>
</section>
<section xml:id="_pim_sm">
<title>PIM SM</title>
<simpara>PIM SM uses shared trees and SPTs to distribute multicast traffic to multicast receivers in the network.</simpara>
<simpara>In PIM SM, a router  assumes that other routers or switches
do not forward multicast packets for a group, unless there is an explicit
request for the traffic (join message). When a host joins a multicast group
using IGMP, its directly connected PIM SM device sends PIM join messages toward
the root, also known as the RP. This join message travels router-by-router
toward the root, constructing a branch of the shared tree as it goes. The RP
keeps track of multicast receivers; it also registers sources through register
messages received from the source&#8217;s first-hop router (designated router [DR])
to complete the shared tree path from the source to the receiver. The branches
of the shared tree are maintained by periodic join refresh messages that the
PIM SM devices send along the branch.</simpara>
<simpara>When using a shared tree, sources must send their traffic to the RP so that the
traffic reaches all receivers. The special notation *,G, (pronounced star comma
G) is used to represent the tree, where * means all sources and G represents
the multicast group. Figure <xref linkend="pim-shared-distribution-tree"/> shows a shared tree for group 224.2.2.2 with
the RP located at Router 3. Multicast group traffic from source Hosts A and D
travels to the RP (Router 3) and then down the shared tree to two receivers,
Hosts B and C. Because all sources in the multicast group use a common shared
tree, the special notation (*, 224.2.2.2) describes this shared tree.</simpara>
<figure xml:id="pim-shared-distribution-tree">
<title>Shared Distribution Tree</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/pim-shared-distribution-tree.png"/>
</imageobject>
<textobject><phrase>pim shared distribution tree</phrase></textobject>
</mediaobject>
</figure>
<note>
<simpara>In addition to using the shared distribution tree, PIM SM can also use
SPTs. By joining an SPT, multicast traffic is routed directly to the receivers
without having to go through the RP, thereby reducing network latency and
possible congestion at the RP. The disadvantage is that PIM SM devices must
create and maintain (S,G) state entries in their routing tables along with the
(S,G) SPT. This action consumes router resources.</simpara>
</note>
<simpara>Prune messages are sent up the distribution tree to prune multicast group
traffic. This action permits branches of the shared tree or SPT that were
created with explicit join messages to be torn down when they are no longer
needed. For example, if a leaf router (a router without any downstream
connections) detects that it no longer has any directly connected hosts (or
downstream multicast routers) for a particular multicast group, it sends a
prune message up the distribution tree to stop the flow of unwanted multicast
traffic.</simpara>
</section>
</section>
<section xml:id="_shared_tree_vs_source_tree">
<title>Shared tree vs Source tree</title>
<simpara>By default, members of a group receive data from senders to the group across a
single data-distribution tree rooted at the RP. Figure <xref linkend="pim_tree"/> shows this type of
shared-distribution tree. Data from senders is delivered to the RP for
distribution to group members joined to the shared tree.</simpara>
<figure xml:id="pim_tree">
<title>PIM trees</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/pim-trees.png"/>
</imageobject>
<textobject><phrase>pim trees</phrase></textobject>
</mediaobject>
</figure>
<simpara>If the data rate warrants, leaf routers (routers without any downstream
connections) on the shared tree can use the data distribution tree rooted at
the source. This type of distribution tree is called a shortest-path tree or
source tree. By default, the IOS software switches to a source tree upon
receiving the first data packet from a source.</simpara>
<simpara>This process describes the move from a shared tree to a source tree:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>A receiver joins a group; leaf Router C sends a join message toward the RP.</simpara>
</listitem>
<listitem>
</listitem>
<listitem>
<simpara>A source sends data; Router A encapsulates the data in a register message
and sends it to the RP.</simpara>
</listitem>
<listitem>
<simpara>The RP forwards the data down the shared tree to Router C and sends a join
message toward the source. At this point, data might arrive twice at Router C,
once encapsulated and once natively.</simpara>
</listitem>
<listitem>
<simpara>When data arrives natively (unencapsulated) at the RP, it sends a
register-stop message to Router A.</simpara>
</listitem>
<listitem>
<simpara>By default, reception of the first data packet prompts Router C to send a
join message toward the source.</simpara>
</listitem>
<listitem>
<simpara>When Router C receives data on (S,G), it sends a prune message for the
source up the shared tree.</simpara>
</listitem>
<listitem>
The RP triggers a prune message toward the source.</simpara>
</listitem>
</orderedlist>
<simpara>Join and prune messages are sent for sources and RPs. They are sent hop-by-hop
and are processed by each PIM device along the path to the source or RP.
Register and register-stop messages are not sent hop-by-hop. They are sent by
the designated router that is directly connected to a source and are received
by the RP for the group.</simpara>
<simpara>Multiple sources sending to groups use the shared tree.</simpara>
<simpara>You can configure the PIM device to stay on the shared tree.</simpara>
</section>
<section xml:id="_auto_rp">
<title>Auto-RP</title>
<simpara>This proprietary feature eliminates the need to manually configure the
rendezvous point (RP) information in every router and multilayer switch in the
network.  Auto-RP uses IP multicast to automate the distribution of group-to-RP mappings
to all Cisco routers and multilayer switches in a PIM network.</simpara>
<simpara>It has these benefits:</simpara>
<itemizedlist>
<listitem>
<simpara>It is easy to use multiple RPs within a network to serve different group
ranges.</simpara>
</listitem>
<listitem>
<simpara>It allows load splitting among different RPs and arrangement of RPs according
to the location of group participants.</simpara>
</listitem>
<listitem>
<simpara>It avoids inconsistent, manual RP configurations on every router and
multilayer switch in a PIM network, which can cause connectivity problems.</simpara>
</listitem>
</itemizedlist>
<simpara>For Auto-RP to work, you configure a Cisco router
as the <emphasis role="strong">mapping agent</emphasis>. It uses IP multicast to learn which routers or switches
in the network are possible candidate RPs by joining the well-known
Cisco-RP-announce multicast group (224.0.1.39) to receive candidate RP
announcements. Candidate RPs send multicast RP-announce messages to a
particular group or group range every 60 seconds (default) to announce their
availability. Each RP-announce message contains a holdtime that tells the
mapping agent how long the candidate RP announcement is valid. The default is
180 seconds.</simpara>
<simpara>Mapping agents listen to these candidate RP announcements and use the
information to create entries in their Group-to-RP mapping caches. Only one
mapping cache entry is created for any Group-to-RP range received, even if
multiple candidate RPs are sending RP announcements for the same range. As the
RP-announce messages arrive, the mapping agent selects the router or switch
with the highest IP address as the active RP and stores this RP address in the
Group-to-RP mapping cache.</simpara>
<simpara>Mapping agents multicast the contents of their Group-to-RP mapping cache in
RP-discovery messages every 60 seconds (default) to the Cisco-RP-discovery
multicast group (224.0.1.40), which all Cisco PIM routers and multilayer
switches join to receive Group-to-RP mapping information. Thus, all routers and
switches automatically discover which RP to use for the groups they support.
The discovery messages also contain a holdtime, which defines how long the
Group-to-RP mapping is valid. If a router or switch fails to receive
RP-discovery messages and the Group-to-RP mapping information expires, it
switches to a statically configured RP that was defined with the <emphasis role="strong">ip pim
rp-address</emphasis> global configuration command. If no statically configured RP exists,
the router or switch changes the group to dense-mode operation.</simpara>
<simpara>Multiple RPs serve different group ranges or serve as hot backups of each
other.</simpara>
</section>
<section xml:id="_bootstrap_router">
<title>Bootstrap Router</title>
<simpara>PIMv2 BSR is another method to distribute group-to-RP mapping information to
all PIM routers and multilayer switches in the network. It eliminates the need
to manually configure RP information in every router and switch in the network.
However, instead of using IP multicast to distribute group-to-RP mapping
information, BSR uses hop-by-hop flooding of special BSR messages to distribute
the mapping information.</simpara>
<simpara>The BSR is elected from a set of candidate routers and switches in the domain
that have been configured to function as BSRs. The election mechanism is
similar to the root-bridge election mechanism used in bridged LANs. The BSR
election is based on the BSR priority of the device contained in the BSR
messages that are sent hop-by-hop through the network. Each BSR device examines
the message and forwards out all interfaces only the message that has either a
higher BSR priority than its BSR priority or the same BSR priority, but with a
higher BSR IP address. Using this method, the BSR is elected.</simpara>
<simpara>The elected BSR sends BSR messages to the all-PIM-routers multicast group
(224.0.0.13) with a TTL of 1. Neighboring PIMv2 routers es
receive the BSR message and multicast it out all other interfaces (except the
one on which it was received) with a TTL of 1. In this way, BSR messages travel
hop-by-hop throughout the PIM domain. Because BSR messages contain the IP
address of the current BSR, the flooding mechanism allows candidate RPs to
automatically learn which device is the elected BSR.</simpara>
<simpara>Candidate RPs send candidate RP advertisements showing the group range for
which they are responsible directly to the BSR, which stores this information
in its local candidate-RP cache. The BSR periodically advertises the contents
of this cache in BSR messages to all other PIM devices in the domain. These
messages travel hop-by-hop through the network to all routers and switches,
which store the RP information in the BSR message in their local RP cache. The
routers and switches select the same RP for a given group because they all use
a common RP hashing algorithm.</simpara>
<section xml:id="_multicast_forwarding_and_reverse_path_check">
<title>Multicast Forwarding and Reverse Path Check</title>
<simpara>With unicast routing, routers and multilayer switches forward traffic through
the network along a single path from the source to the destination host whose
IP address appears in the destination address field of the IP packet. Each
router and switch along the way makes a unicast forwarding decision, using the
destination IP address in the packet, by looking up the destination address in
the unicast routing table and forwarding the packet through the specified
interface to the next hop toward the destination.</simpara>
<simpara>With multicasting, the source is sending traffic to an arbitrary group of hosts
represented by a multicast group address in the destination address field of
the IP packet. To determine whether to forward or drop an incoming multicast
packet, the router  uses a <emphasis role="strong">reverse path forwarding</emphasis> (RPF)
check on the packet as follows and shown in Figure <xref linkend="rpf"/>:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>The router  examines the source address of the arriving
multicast packet to determine whether the packet arrived on an interface that
is on the reverse path back to the source.</simpara>
</listitem>
<listitem>
<simpara>If the packet arrives on the interface leading back to the source, the RPF
check is successful and the packet is forwarded to all interfaces in the
outgoing interface list (which might not be all interfaces on the router).</simpara>
</listitem>
<listitem>
<simpara>If the RPF check fails, the packet is discarded.</simpara>
</listitem>
</orderedlist>
<simpara>Some multicast routing protocols, such as DVMRP, maintain a separate multicast
routing table and use it for the RPF check. However, PIM uses the unicast
routing table to perform the RPF check.</simpara>
<simpara>Figure <xref linkend="rpf"/> shows Gigabit Ethernet interface 0/2 receiving a multicast packet from source 151.10.3.21. A check of the routing table shows that the interface on the reverse path to the source is Gigabit Ethernet interface 0/1, not interface 0/2. Because the RPF check fails, the multilayer switch discards the packet. Another multicast packet from source 151.10.3.21 is received on interface 0/1, and the routing table shows this interface is on the reverse path to the source. Because the RPF check passes, the switch forwards the packet to all interfaces in the outgoing interface list.</simpara>
<figure xml:id="rpf">
<title>RPF Check</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/pim-rpf-check.png"/>
</imageobject>
<textobject><phrase>pim rpf check</phrase></textobject>
</mediaobject>
</figure>
<simpara>PIM uses both source trees and RP-rooted shared trees to forward datagrams ; the RPF check is performed differently for each:</simpara>
<itemizedlist>
<listitem>
<simpara>If a PIM router  has a source-tree state (that is, an (S,G) entry is present in the multicast routing table), it performs the RPF check against the IP address of the source of the multicast packet.</simpara>
</listitem>
<listitem>
<simpara>If a PIM router  has a shared-tree state (and no explicit source-tree state), it performs the RPF check on the rendezvous point (RP) address (which is known when members join the group).</simpara>
</listitem>
</itemizedlist>
<simpara>Sparse-mode PIM uses the RPF lookup function to determine where it needs to send joins and prunes:</simpara>
<itemizedlist>
<listitem>
<simpara>(S,G) joins (which are source-tree states) are sent toward the source.</simpara>
</listitem>
<listitem>
<simpara>(*,G) joins (which are shared-tree states) are sent toward the RP.</simpara>
</listitem>
</itemizedlist>
<simpara>DVMRP and dense-mode PIM use only source trees and use RPF as previously described.</simpara>
</section>
</section>
<section xml:id="_neighbor_discovery">
<title>Neighbor Discovery</title>
<simpara>PIM uses a neighbor discovery mechanism to establish PIM neighbor adjacencies.
To establish adjacencies, a PIM router  sends PIM hello
messages to the all-PIM-routers multicast group (224.0.0.13) on each of its
multicast-enabled interfaces. The hello message contains a holdtime, which
tells the receiver when the neighbor adjacency associated with the sender
expires if no more PIM hello messages are received. Keeping track of
adjacencies is important for PIM DM operation for building the source
distribution tree.</simpara>
<simpara>PIM hello messages are also used to elect the DR for multi-access networks
(Ethernet). The router  on the network with the highest IP
address is the DR. With PIM DM operation, the DR has meaning only if IGMPv1 is
in use; IGMPv1 does not have an IGMP querier election process, so the elected
DR functions as the IGMP querier. In PIM SM operation, the DR is the router or
switch that is directly connected to the multicast source. It sends PIM
register messages to notify the RP that multicast traffic from a source needs
to be forwarded down the shared tree.</simpara>
</section>
<section xml:id="_pimv1_and_pimv2_interoperability">
<title>PIMv1 and PIMv2 interoperability</title>
<simpara>The Cisco PIMv2 implementation allows interoperability and transition between
Version 1 and Version 2, although there might be some minor problems.</simpara>
<simpara>You can upgrade to PIMv2 incrementally. PIM Versions 1 and 2 can be configured
on different routers and multilayer switches within one network. Internally,
all routers and multilayer switches on a shared media network must run the same
PIM version. Therefore, if a PIMv2 device detects a PIMv1 device, the Version 2
device downgrades itself to Version 1 until all Version 1 devices have been
shut down or upgraded.</simpara>
<simpara>PIMv2 uses the BSR to discover and announce RP-set information for each group
prefix to all the routers and multilayer switches in a PIM domain. PIMv1,
together with the Auto-RP feature, can perform the same tasks as the PIMv2 BSR.
However, Auto-RP is a standalone protocol, separate from PIMv1, and is a
proprietary Cisco protocol. PIMv2 is a standards track protocol in the IETF. We
recommend that you use PIMv2. The BSR mechanism interoperates with Auto-RP on
Cisco routers and multilayer switches.</simpara>
<simpara>When PIMv2 devices interoperate with PIMv1 devices, Auto-RP should have already
been deployed. A PIMv2 BSR that is also an Auto-RP mapping agent automatically
advertises the RP elected by Auto-RP. That is, Auto-RP sets its single RP on
every router  in the group. Not all routers and switches in
the domain use the PIMv2 hash function to select multiple RPs.</simpara>
<simpara>Dense-mode groups in a mixed PIMv1 and PIMv2 region need no special
configuration; they automatically interoperate.</simpara>
<simpara>Sparse-mode groups in a mixed PIMv1 and PIMv2 region are possible because the
Auto-RP feature in PIMv1 interoperates with the PIMv2 RP feature. Although all
PIMv2 devices can also use PIMv1, we recommend that the RPs be upgraded to
PIMv2 (or at least upgraded to PIMv1 in the Cisco IOS Release 11.3 software).
To ease the transition to PIMv2, we have these recommendations:</simpara>
<itemizedlist>
<listitem>
<simpara>Use Auto-RP throughout the region.</simpara>
</listitem>
<listitem>
<simpara>Configure sparse-dense mode throughout the region.</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_auto_rp_and_bsr_configuration_guidelines">
<title>Auto-RP and BSR configuration guidelines</title>
<simpara>There are two approaches to using PIMv2. You can use Version 2 exclusively in
your network or migrate to Version 2 by employing a mixed PIM version
environment.</simpara>
<itemizedlist>
<listitem>
<simpara>If your network is all Cisco routers and multilayer switches, you can use
either Auto-RP or BSR.</simpara>
</listitem>
<listitem>
<simpara>If you have non-Cisco routers in your network, you must use BSR.</simpara>
</listitem>
<listitem>
<simpara>If you have Cisco PIMv1 and PIMv2 routers and multilayer switches and
non-Cisco routers, you must use both Auto-RP and BSR.</simpara>
</listitem>
<listitem>
<simpara>Because bootstrap messages are sent hop-by-hop, a PIMv1 device prevents these
messages from reaching all routers and multilayer switches in your network.
Therefore, if your network has a PIMv1 device in it and only Cisco routers and
multilayer switches, it is best to use Auto-RP.</simpara>
</listitem>
<listitem>
<simpara>If you have a network that includes non-Cisco routers, configure the Auto-RP
mapping agent and the BSR on a Cisco PIMv2 router . Ensure
that no PIMv1 device is on the path between the BSR and a non-Cisco PIMv2
router.</simpara>
</listitem>
<listitem>
<simpara>If you have non-Cisco PIMv2 routers that need to interoperate with Cisco PIMv1
routers and multilayer switches, both Auto-RP and a BSR are required. We
recommend that a Cisco PIMv2 device be both the Auto-RP mapping agent and the
BSR.</simpara>
</listitem>
</itemizedlist>
</section>
</section>
<section xml:id="_configuration_tasks_2">
<title>Configuration tasks</title>
<section xml:id="_configure_basic_multicast_routing">
<title>Configure basic multicast routing</title>
<simpara>You must enable IP multicast routing and configure the PIM version and PIM mode
so that the IOS software can forward multicast packets and determine how the
multilayer switch populates its multicast routing table.</simpara>
<simpara>You can configure an interface to be in PIM dense mode, sparse mode, or
sparse-dense mode. The mode determines how the switch populates its multicast
routing table and how it forwards multicast packets it receives from its
directly connected LANs. You must enable PIM in one of these modes for an
interface to perform IP multicast routing. Enabling PIM on an interface also
enables IGMP operation on that interface.</simpara>
<simpara>By default, multicast routing is disabled, and there is no default mode
setting. The following procedure is required.</simpara>
<itemizedlist>
<listitem>
<simpara>Enable IP multicast forwarding</simpara>
</listitem>
</itemizedlist>
<screen>(config)# ip multicast-routing</screen>
<itemizedlist>
<listitem>
<simpara>Enter interface configuration mode, and specify the Layer 3 interface on which you want to enable multicast routing.
The specified interface must be one of the following:</simpara>
<itemizedlist>
<listitem>
<simpara>A routed port: a physical port that has been configured as a Layer 3 port by entering the no <emphasis role="strong">switchport interface</emphasis> configuration command.</simpara>
</listitem>
<listitem>
<simpara>An SVI: a VLAN interface created by using the <emphasis role="strong">interface vlan vlan-id</emphasis> global configuration command.</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<simpara>These ports must have IP addresses assigned to them.</simpara>
<screen>interface &lt;interface-id&gt;</screen>
<itemizedlist>
<listitem>
<simpara>Configure the PIM version on the interface. By default, version 2 is enabled and is the recommended setting.</simpara>
</listitem>
</itemizedlist>
<screen>(config-if)# ip pim version [1|2]</screen>
<itemizedlist>
<listitem>
<simpara>Enable a PIM mode on the interface.  By default, no mode is configured.</simpara>
</listitem>
</itemizedlist>
<screen>(config-if)# pim {dense-mode | sparse-mode | sparse-dense-mode }</screen>
<section xml:id="_manually_assigning_an_rp_to_multicast_groups">
<title>Manually Assigning an RP to Multicast Groups</title>
<simpara>Senders of multicast traffic announce their existence through register messages
received from the source&#8217;s first-hop router (designated router) and forwarded
to the RP. Receivers of multicast packets use RPs to join a multicast group by
using explicit join messages. RPs are not members of the multicast group;
rather, they serve as a meeting place for multicast sources and group members.</simpara>
<simpara>Configure the address of a PIM RP.</simpara>
<simpara>By default, no PIM RP address is configured. You must configure the IP address
of RPs on all routers and multilayer switches (including the RP). If there is
no RP configured for a group, the multilayer switch treats the group as dense,
using the dense-mode PIM techniques. A PIM device can use multiple RPs, but
only one per group.</simpara>
<itemizedlist>
<listitem>
<simpara>For ip-address, enter the unicast address of the RP in dotted-decimal
notation.</simpara>
</listitem>
<listitem>
<simpara>(Optional) For access-list-number, enter an IP standard access list number
from 1 to 99. If no access list is configured, the RP is used for all groups.</simpara>
</listitem>
<listitem>
<simpara>(Optional) The override keyword means that if there is a conflict between the
RP configured with this command and one learned by Auto-RP or BSR, the RP
configured with this command prevails.</simpara>
</listitem>
</itemizedlist>
<screen>ip pim rp-address ip-address [access-list-number] [override]</screen>
</section>
</section>
<section xml:id="_configure_auto_rp">
<title>Configure Auto-RP</title>
<simpara>Configure another PIM device to be the candidate RP for local groups.</simpara>
<itemizedlist>
<listitem>
<simpara>For interface-id, enter the interface type and number that identifies the RP
address. Valid interfaces include physical ports, port channels, and VLANs.</simpara>
</listitem>
<listitem>
<simpara>For scope ttl, specify the time-to-live value in hops. Enter a hop count that
is high enough so that the RP-announce messages reach all mapping agents in the
network. There is no default setting. The range is 1 to 255.</simpara>
</listitem>
<listitem>
<simpara>For <emphasis role="strong">group-list</emphasis> access-list-number, enter an IP standard access list number
from 1 to 99. If no access list is configured, the RP is used for all groups.</simpara>
</listitem>
<listitem>
<simpara>For interval seconds, specify how often the announcement messages must be
sent. The default is 60 seconds. The range is 1 to 16383.</simpara>
</listitem>
</itemizedlist>
<screen>ip pim send-rp-announce &lt;interface-id&gt; scope &lt;ttl&gt; group-list &lt;access-list-number&gt; interval &lt;seconds&gt;</screen>
<simpara>Find a multilayer switch whose connectivity is not likely to be interrupted,
and assign it the role of RP-mapping agent.</simpara>
<simpara>For scope ttl, specify the time-to-live value in hops to limit the RP discovery
packets. All devices within the hop count from the source device receive the
Auto-RP discovery messages. These messages tell other devices which group-to-RP
mapping to use to avoid conflicts (such as overlapping group-to-RP ranges).
There is no default setting. The range is 1 to 255.</simpara>
<screen>ip pim send-rp-discovery scope &lt;1..255&gt;</screen>
<simpara>Configure PIM-SM interfaces to use dense mode to flood Auto-RP traffic to 224.0.1.39 and 224.0.1.40.</simpara>
<screen>ip pim autorp listener</screen>
</section>
<section xml:id="_prevent_join_messages_to_false_rps">
<title>Prevent Join Messages to false RPs</title>
<simpara>Determine whether the <emphasis role="strong">ip pim accept-rp</emphasis> command was previously configured
throughout the network by using the show running-config privileged EXEC
command. If the <emphasis role="strong">ip pim accept-rp</emphasis> command is not configured on any device, this
problem can be addressed later. In those routers es already
configured with the <emphasis role="strong">ip pim accept-rp</emphasis> command, you must enter the command again
to accept the newly advertised RP.</simpara>
<simpara>To accept all RPs advertised with Auto-RP and reject all other RPs by default,
use the <emphasis role="strong">ip pim accept-rp auto-rp</emphasis> global configuration command.</simpara>
<simpara>If all interfaces are in sparse mode, use a default-configured RP to support
the two well-known groups 224.0.1.39 and 224.0.1.40. Auto-RP uses these two
well-known groups to collect and distribute RP-mapping information. When this
is the case and the <emphasis role="strong">ip pim accept-rp auto-rp</emphasis> command is configured, another <emphasis role="strong">ip
pim accept-rp</emphasis> command accepting the RP must be configured as follows:</simpara>
<screen>Switch(config)# ip pim accept-rp 172.10.20.1 1
Switch(config)# access-list 1 permit 224.0.1.39
Switch(config)# access-list 1 permit 224.0.1.40</screen>
</section>
<section xml:id="_prevent_candidate_rp_spoofing">
<title>Prevent candidate RP spoofing</title>
<simpara>Filter incoming RP announcement messages.</simpara>
<simpara>Enter this command on each mapping agent in the network.</simpara>
<simpara>Without this command, all incoming RP-announce messages are accepted by
default.</simpara>
<simpara>For <emphasis role="strong">rp-list</emphasis> access-list-number, configure an access list of candidate RP
addresses that, if permitted, is accepted for the group ranges supplied in the
group-list access-list-number variable. If this variable is omitted, the filter
applies to all multicast groups.</simpara>
<simpara>If more than one mapping agent is used, the filters must be consistent across
all mapping agents to ensure that no conflicts occur in the Group-to-RP mapping
information.</simpara>
<screen>ip pim rp-announce-filter rp-list &lt;access-list-number&gt; group-list &lt;access-list-number&gt;</screen>
</section>
<section xml:id="_define_the_pim_domain_border">
<title>Define the PIM domain border</title>
<simpara>As IP multicast becomes more widespread, the chances of one PIMv2 domain
bordering another PIMv2 domain is increasing. Because these two domains
probably do not share the same set of RPs, BSR, candidate RPs, and candidate
BSRs, you need to constrain PIMv2 BSR messages from flowing into or out of the
domain. Allowing these messages to leak across the domain borders could
adversely affect the normal BSR election mechanism and elect a single BSR
across all bordering domains and co-mingle candidate RP advertisements,
resulting in the election of RPs in the wrong domain.</simpara>
<simpara>Define a PIM bootstrap message boundary for the PIM domain.</simpara>
<simpara>Enter this command on each interface that connects to other bordering PIM
domains. This command instructs the multilayer switch to neither send or
receive PIMv2 BSR messages on this interface as shown in Figure <xref linkend="bsr-boundaries"/>.</simpara>
<screen>(config-if)# ip pim bsr-border</screen>
<figure xml:id="bsr-boundaries">
<title>Constraining PIMv2 BSR Messages</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/pim-constraining-bsr-messages.png"/>
</imageobject>
<textobject><phrase>pim constraining bsr messages</phrase></textobject>
</mediaobject>
</figure>
</section>
<section xml:id="_define_the_ip_multicast_boundary">
<title>Define the IP multicast boundary</title>
<simpara>You define a multicast boundary to prevent Auto-RP messages from entering the
PIM domain. You create an access list to deny packets destined for 224.0.1.39
and 224.0.1.40, which carry Auto-RP information.</simpara>
<screen>(config-if)# ip multicast boundary &lt;access-list-number&gt;</screen>
</section>
<section xml:id="_configure_candidate_bsrs">
<title>Configure candidate BSRs</title>
<simpara>You can configure one or more candidate BSRs. The devices serving as candidate
BSRs should have good connectivity to other devices and be in the backbone
portion of the network.</simpara>
<simpara>Configure your multilayer switch to be a candidate BSR.</simpara>
<itemizedlist>
<listitem>
<simpara>For interface-id, enter the interface type and number on this switch from which the BSR address is derived to make it a candidate. This interface must be enabled with PIM. Valid interfaces include physical ports, port channels, and VLANs.</simpara>
</listitem>
<listitem>
<simpara>For hash-mask-length, specify the mask length (32 bits maximum) that is to be ANDed with the group address before the hash function is called. All groups with the same seed hash correspond to the same RP. For example, if this value is 24, only the first 24 bits of the group addresses matter.</simpara>
</listitem>
<listitem>
<simpara>(Optional) For priority, enter a number from 0 to 255. The BSR with the larger priority is preferred. If the priority values are the same, the device with the highest IP address is selected as the BSR. The default is 0.</simpara>
</listitem>
</itemizedlist>
<screen>(config)# ip pim bsr-candidate &lt;interface-id&gt; &lt;hash-mask-length&gt; [priority]</screen>
</section>
<section xml:id="_configure_candidate_rps">
<title>Configure Candidate RPs</title>
<simpara>You can configure one or more candidate RPs. Similar to BSRs, the RPs should
also have good connectivity to other devices and be in the backbone portion of
the network. An RP can serve the entire IP multicast address space or a portion
of it. Candidate RPs send candidate RP advertisements to the BSR. When deciding
which devices should be RPs, consider these options:</simpara>
<itemizedlist>
<listitem>
<simpara>In a network of Cisco routers and multilayer switches where only Auto-RP is
used, any device can be configured as an RP.</simpara>
</listitem>
<listitem>
<simpara>In a network that includes only Cisco PIMv2 routers and multilayer switches
and with routers from other vendors, any device can be used as an RP.</simpara>
</listitem>
<listitem>
<simpara>In a network of Cisco PIMv1 routers, Cisco PIMv2 routers, and routers from
other vendors, configure only Cisco PIMv2 routers and multilayer switches as
RPs.</simpara>
</listitem>
</itemizedlist>
<simpara>Configure your multilayer switch to be a candidate RP.</simpara>
<itemizedlist>
<listitem>
<simpara>For interface-id, enter the interface type and number whose associated IP address is advertised as a candidate RP address. Valid interfaces include physical ports, port channels, and VLANs.</simpara>
</listitem>
<listitem>
<simpara>(Optional) For group-list access-list-number, enter an IP standard access list number from 1 to 99. If no group-list is specified, the multilayer switch is a candidate RP for all groups.</simpara>
</listitem>
</itemizedlist>
<screen>ip pim rp-candidate interface-id [group-list access-list-number]</screen>
</section>
<section xml:id="_delay_the_use_of_pim_shortest_path_tree">
<title>Delay the Use of PIM Shortest-Path Tree</title>
<simpara>The change from shared to source tree happens when the first data packet
arrives at the last-hop router. This change occurs
because the <emphasis role="strong">ip pim spt-threshold</emphasis> interface configuration command controls that
timing; its default setting is 0 kbps.</simpara>
<simpara>The shortest-path tree requires more memory than the shared tree but reduces
delay. You might want to postpone its use. Instead of allowing the leaf router
to immediately move to the shortest-path tree, you can specify that the traffic
must first reach a threshold.</simpara>
<simpara>You can configure when a PIM leaf router should join the shortest-path tree for
a specified group. If a source sends at a rate greater than or equal to the
specified kbps rate, the multilayer switch triggers a PIM join message toward
the source to construct a source tree (shortest-path tree). If the traffic rate
from the source drops below the threshold value, the leaf router switches back
to the shared tree and sends a prune message toward the source.</simpara>
<simpara>You can specify to which groups the shortest-path tree threshold applies by
using a group list (a standard access list). If a value of 0 is specified or if
the group list is not used, the threshold applies to all groups.</simpara>
<simpara>Specify the threshold that must be reached before moving to shortest-path tree
(spt).</simpara>
<itemizedlist>
<listitem>
<simpara>For kbps, specify the traffic rate in kilobits per second. The default is 0
kbps. The range is 0 to 4294967.</simpara>
</listitem>
<listitem>
<simpara>Specify infinity if you want all sources for the specified group to use the
shared tree, never switching to the source tree.</simpara>
</listitem>
<listitem>
<simpara>(Optional) For group-list access-list-number, specify the access list created
in Step 2. If the value is 0 or if the group-list is not used, the threshold
applies to all groups.</simpara>
</listitem>
</itemizedlist>
<screen>ip pim spt-threshold {kbps | infinity} [group-list access-list-number]</screen>
</section>
<section xml:id="_modifying_the_pim_router_query_message_interval">
<title>Modifying the PIM Router-Query Message Interval</title>
<simpara>PIM routers and multilayer switches send PIM router-query messages to determine
which device will be the DR for each LAN segment (subnet). The DR is
responsible for sending IGMP host-query messages to all hosts on the directly
connected LAN.</simpara>
<simpara>With PIM DM operation, the DR has meaning only if IGMPv1 is in use. IGMPv1 does
not have an IGMP querier election process, so the elected DR functions as the
IGMP querier. With PIM SM operation, the DR is the device that is directly
connected to the multicast source. It sends PIM register messages to notify the
RP that multicast traffic from a source needs to be forwarded down the shared
tree. In this case, the DR is the device with the highest IP address.</simpara>
<simpara>The default is 30 seconds. The range is 1 to 65535.</simpara>
<screen>ip pim query-interval &lt;seconds&gt;</screen>
</section>
<section xml:id="_verify_2">
<title>Verify</title>
<simpara>Display information about interfaces configured for PIM.</simpara>
<screen>show ip pim interface [type number] [count]</screen>
<simpara>List the PIM neighbors discovered by the multilayer switch.</simpara>
<screen>show ip pim neighbor [type number]</screen>
<simpara>Display the elected BSR</simpara>
<screen>show ip pim bsr</screen>
<simpara>displays the RP that was selected for the specified group.</simpara>
<screen>show ip pim rp-hash group</screen>
<simpara>displays how the multilayer switch learns of the RP (through the BSR or the Auto-RP mechanism).</simpara>
<screen>show ip pim rp [group-name | group-address | mapping]</screen>
<simpara>Display the RP routers associated with a sparse-mode multicast group.</simpara>
<screen>show ip pim rp [group-name | group-address]</screen>
<simpara>Display how the multilayer switch is doing Reverse-Path Forwarding</simpara>
<screen>show ip rpf {source-address | name}</screen>
<simpara>Query a multicast router  about which neighboring multicast devices are peering with it.</simpara>
<screen>mrinfo [hostname | address] [source-address | interface]</screen>
<simpara>Display IP multicast packet rate and loss information.</simpara>
<screen>mstat source [destination] [group]</screen>
<simpara>Trace the path from a source to a destination branch for a multicast distribution tree for a given group.</simpara>
<screen>mtrace source [destination] [group]</screen>
</section>
</section>
<section xml:id="_troubleshoot_2">
<title>Troubleshoot</title>
<simpara>When debugging interoperability problems between PIMv1 and PIMv2, check these
in the order shown:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Verify RP mapping with the show ip pim rp-hash privileged EXEC command,
making sure that all systems agree on the same RP for the same group.</simpara>
</listitem>
<listitem>
<simpara>Verify interoperability between different versions of DRs and RPs. Make sure
the RPs are interacting with the DRs properly (by responding with
register-stops and forwarding decapsulated data packets from registers).</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_misc">
<title>Misc</title>
<simpara>TODO To be added in the text</simpara>
<table frame="all" rowsep="1" colsep="1">
<title>PIM type code</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="10*"/>
<colspec colname="col_2" colwidth="90*"/>
<thead>
<row>
<entry align="left" valign="top">Type</entry>
<entry align="left" valign="top">Name</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>0</simpara></entry>
<entry align="left" valign="top"><simpara>Hello</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>1</simpara></entry>
<entry align="left" valign="top"><simpara>Register</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>2</simpara></entry>
<entry align="left" valign="top"><simpara>Register Stop</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>3</simpara></entry>
<entry align="left" valign="top"><simpara>Join/Prune</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>4</simpara></entry>
<entry align="left" valign="top"><simpara>Bootstrap</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>5</simpara></entry>
<entry align="left" valign="top"><simpara>Assert</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>6</simpara></entry>
<entry align="left" valign="top"><simpara>Graft</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>7</simpara></entry>
<entry align="left" valign="top"><simpara>Graft-Ack</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>8</simpara></entry>
<entry align="left" valign="top"><simpara>Candidate RP Advertisement</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>9</simpara></entry>
<entry align="left" valign="top"><simpara>State Refresh</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>10</simpara></entry>
<entry align="left" valign="top"><simpara>DF Election</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>11-14</simpara></entry>
<entry align="left" valign="top"><simpara>Unassigned</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>15</simpara></entry>
<entry align="left" valign="top"><simpara>Reserved for extension of type space</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<simpara>Define the ssm range of IP multicast addresses</simpara>
<screen>(config)# ip pim [vrf name] ssm { default | range access-list-number}</screen>
<simpara><emphasis role="strong">default</emphasis> defines the ssm range access list to 232/8</simpara>
<simpara>TODO: Need to delete section below.</simpara>
<section xml:id="_configure_the_ttl_threshold">
<title>Configure the TTL Threshold</title>
<simpara>Each time an IP multicast packet is forwarded by the multilayer switch, the
time-to-live (TTL) value in the IP header is decremented by one. If the packet
TTL decrements to zero, the switch drops the packet. TTL thresholds can be
applied to individual interfaces of the multilayer switch to prevent multicast
packets with a TTL less than the TTL threshold from being forwarded out the
interface. TTL thresholds provide a simple method to prevent the forwarding of
multicast traffic beyond the boundary of a site or region, based on the TTL
field in a multicast packet. This is known as TTL scoping.</simpara>
<simpara>Figure 33-10 shows a multicast packet arriving on Gigabit Ethernet interface
0/2 with a TTL value of 24. Assuming that the RPF check succeeds and that
Gigabit Ethernet interfaces 0/1, 0/3, and 0/4 are all in the outgoing interface
list, the packet would normally be forwarded out these interfaces. Because some
TTL thresholds have been applied to these interfaces, the multilayer switch
makes sure that the packet TTL value, which is decremented by 1 to 23, is
greater than or equal to the interface TTL threshold before forwarding the
packet out the interface. In this example, the packet is forwarded out
interfaces 0/1 and 0/4, but not interface 0/3.</simpara>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/multicast-ttl-threshold.png"/>
</imageobject>
<textobject><phrase>multicast ttl threshold</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>Figure 33-11 shows an example of TTL threshold boundaries being used to limit
the forwarding of multicast traffic. Company XYZ has set a TTL threshold of 100
on all routed interfaces at the perimeter of its network. Multicast
applications that constrain traffic to within the company&#8217;s network need to
send multicast packets with an initial TTL value set to 99. The engineering and
marketing departments have set a TTL threshold of 40 at the perimeter of their
networks; therefore, multicast applications running on these networks can
prevent their multicast transmissions from leaving their respective networks.</simpara>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/multicast-ttl-boundaries.png"/>
</imageobject>
<textobject><phrase>multicast ttl boundaries</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>The default TTL value is 0 hops, which means that all multicast packets are
forwarded out the interface. The range is 0 to 255.</simpara>
<simpara>Only multicast packets with a TTL value greater than the threshold are
forwarded out the interface.</simpara>
<simpara>You should configure the TTL threshold only on routed interfaces at the
perimeter of the network.</simpara>
<screen>(config-if)# ip multicast ttl-threshold _value_</screen>
</section>
<section xml:id="_configure_an_ip_multicast_boundary">
<title>Configure an IP multicast boundary</title>
<simpara>Like TTL thresholds, administratively-scoped boundaries can also be used to
limit the forwarding of multicast traffic outside of a domain or subdomain.
This approach uses a special range of multicast addresses, called
administratively-scoped addresses, as the boundary mechanism. If you configure
an administratively-scoped boundary on a routed interface, multicast traffic
whose multicast group addresses fall in this range can not enter or exit this
interface, thereby providing a firewall for multicast traffic in this address
range.</simpara>
<simpara>Figure 33-12 shows that Company XYZ has an administratively-scoped boundary set
for the multicast address range 239.0.0.0/8 on all routed interfaces at the
perimeter of its network. This boundary prevents any multicast traffic in the
range 239.0.0.0 through 239.255.255.255 from entering or leaving the network.
Similarly, the engineering and marketing departments have an
administratively-scoped boundary of 239.128.0.0/16 around the perimeter of
their networks. This boundary prevents multicast traffic in the range of
239.128.0.0 through 239.128.255.255 from entering or leaving their respective
networks.</simpara>
<figure>
<title>Administratively-Scoped Boundaries</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/multicast-administratively-scoped-boundaries.png"/>
</imageobject>
<textobject><phrase>multicast administratively scoped boundaries</phrase></textobject>
</mediaobject>
</figure>
<simpara>You can define an administratively-scoped boundary on a routed interface for
multicast group addresses. A standard access list defines the range of
addresses affected. When a boundary is defined, no multicast data packets are
allowed to flow across the boundary from either direction. The boundary allows
the same multicast group address to be reused in different administrative
domains.</simpara>
<simpara>The IANA has designated the multicast address range 239.0.0.0 to
239.255.255.255 as the administratively-scoped addresses. This range of
addresses can then be reused in domains administered by different
organizations. The addresses would be considered local, not globally unique.</simpara>
<screen>(config-if)# ip multicast boundary _standard-access-list-number_</screen>
</section>
</section>
</section>
</chapter>
<chapter xml:id="_wan">
<title>WAN</title>
<section xml:id="_hdlc">
<title>HDLC</title>
<section xml:id="_concepts_3">
<title>Concepts</title>

</section>
<section xml:id="_configuration_4">
<title>Configuration</title>

</section>
</section>
<section xml:id="_ppp">
<title>PPP</title>
<section xml:id="_concepts_4">
<title>Concepts</title>
<itemizedlist>
<listitem>
</listitem>
<listitem>
<simpara>ISO HDLC does not include a Type field , so the Cisco implementation adds a proprietary 2-byte Type field</simpara>
</listitem>
<listitem>
<simpara>hdlc : error detection, default on IOS serial links</simpara>
</listitem>
<listitem>
<simpara>ppp : error detection, error recovery, standard protocol Type field, supports synchronous and asynchronous links</simpara>
</listitem>
<listitem>
<simpara>hdlc vs ppp framing</simpara>
</listitem>
</itemizedlist>
<section xml:id="_ppp_lcp">
<title>PPP LCP</title>
<itemizedlist>
<listitem>
</listitem>
<listitem>
<simpara>NCP ( network control protocol) for each protocol (IP, appletalk, )</simpara>
</listitem>
<listitem>
<simpara>LCP operations:</simpara>
</listitem>
<listitem>
<simpara>LCP features</simpara>
</listitem>
<listitem>
</listitem>
<listitem>
</listitem>
<listitem>
<simpara>layer 2 load balancing: fragment frames over multilink PPP</simpara>
</listitem>
<listitem>
<simpara>authentication: chap, pap</simpara>
</listitem>
</itemizedlist>
<section xml:id="_configuration_5">
<title>configuration</title>
<itemizedlist>
<listitem>
<simpara>minimal with <emphasis role="strong">encapsulation ppp</emphasis></simpara>
</listitem>
<listitem>
<simpara>optional authentication, quality</simpara>
</listitem>
</itemizedlist>
</section>
</section>
<section xml:id="_multilink_ppp">
<title>multilink PPP</title>
<itemizedlist>
<listitem>
<simpara>originally intended to combine multiple ISDN B-channels without requiring any Layer 3 load balancing</simpara>
</listitem>
<listitem>
</listitem>
<listitem>
<simpara>add a header ( 2 or 4 bytes ) to allow reassembly on the receiving end</simpara>
</listitem>
<listitem>
<simpara>configuration with multilink interfaces or virtual templates</simpara>
</listitem>
</itemizedlist>
<itemizedlist>
<listitem>
</listitem>
<listitem>
<simpara>prevents small, delay sensitive packets from having to wait on longer, delay-insensitive packets to be completely serialized out an interface.</simpara>
</listitem>
<listitem>
<simpara>the queuing scheduler generally LLQ on the multilink interface determines the next packet to send:</simpara>
</listitem>
</itemizedlist>
<section xml:id="_configuration_6">
<title>configuration</title>
<simpara>ppp multilink interleave
ppp multilink fragment-delay ms  defines the fragment size based on size = x * bandwidth</simpara>
</section>
</section>
<section xml:id="_ppp_compression">
<title>ppp compression</title>
<itemizedlist>
<listitem>
<simpara>use L2 payload compression ( ip + tcp + data + DL) : best with longer packet</simpara>
</listitem>
<listitem>
<simpara>TCP header compression ( ip + tcp )</simpara>
</listitem>
<listitem>
<simpara>RTP header compression (ip + udp + rtp)</simpara>
</listitem>
<listitem>
<simpara>payload compression works best with longer packets, and header with shorter packets</simpara>
</listitem>
<listitem>
<simpara>header compression : achieves better compression ration 10:1 to 20:1</simpara>
</listitem>
</itemizedlist>
<section xml:id="_layer_2_compression">
<title>layer 2 compression</title>
<itemizedlist>
<listitem>
<simpara>options: LZS (Lempel-Ziv Stacker), MPPC (microsoft point-to-point compression), Predictor</simpara>
</listitem>
<listitem>
<simpara>LZS use more CPU and less RAM than Predictor algorithm and have better compression ratio</simpara>
</listitem>
<listitem>
<simpara>stacker: supports hdlc, ppp, FR, ATM</simpara>
</listitem>
<listitem>
<simpara>mppc: ppp, atm</simpara>
</listitem>
<listitem>
<simpara>predictor: ppp, atm</simpara>
</listitem>
<listitem>
<simpara>configuration with a matching <emphasis role="strong">compress</emphasis> command under each interface on both end of the links</simpara>
</listitem>
<listitem>
<simpara>once configured, ppp starts ccp (compression control protocol) which is another NCP</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_header_compression">
<title>header compression</title>
<itemizedlist>
<listitem>
<simpara>configured with legacy commands or MQC commands</simpara>
</listitem>
<listitem>
<simpara>legacy under the serial (ppp) or multilink interface</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">ip tcp header-compression [passive]</emphasis></simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">ip rtp header-compression [passive]</emphasis></simpara>
</listitem>
<listitem>
<simpara>add also MQC commands</simpara>
</listitem>
</itemizedlist>
</section>
</section>
</section>
<section xml:id="_configuration_tasks_3">
<title>Configuration tasks</title>
<screen>debug ppp authentication</screen>
</section>
<section xml:id="_pppoe">
<title>PPPoE</title>
<itemizedlist>
<listitem>
<simpara>used for digital subscriber line (DSL) Internet access
because the public telephone network uses ATM for its transport protocol;
therefore, Ethernet frames must be encapsulated in a protocol supported over both Ethernet and ATM.</simpara>
</listitem>
<listitem>
<simpara>The PPP Client feature permits a Cisco IOS router, rather than an endpoint host, to serve as the client
in a network. This permits multiple hosts to connect over a single PPPoE connection.</simpara>
</listitem>
<listitem>
<simpara>In a DSL environment, PPP interface IP addresses are derived from an upstream DHCP server
using IP Configuration Protocol (IPCP). Therefore, IP address negotiation must be enabled on the
routers dialer interface. This is done using the ip address negotiated command in the dialer
interface configuration.</simpara>
</listitem>
<listitem>
<simpara>Because of the 8-byte PPP header, the MTU for PPPoE is usually set to 1492 bytes so that the
entire encapsulated frame fits within the 1500-byte Ethernet frame. A maximum transmission unit
(MTU) mismatch prevents a PPPoE connection from coming up. Checking the MTU setting is a
good first step when troubleshooting PPPoE connections.</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_configuration_tasks_4">
<title>Configuration tasks</title>
<simpara>Example</simpara>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/pppoe-topology-example.png" contentdepth="150"/>
</imageobject>
<textobject><phrase>pppoe topology example</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>Example of config on the Edge router</simpara>
<screen># conf t
(config)# interface fa0/1
(config-if)# ip address 192.168.100.1 255.255.255.0
(config-if)# ip nat inside
(config)# interface fa0/1
(config-if)# pppoe-client dial-pool-number 1
(config-if)# exit
(config)# interface dialer1
(config-if)# mtu 1492
(config-if)# encapsulation ppp
(config-if)# ip address negotiated
(config-if)# ppp authentication chap

!The remaining CHAP commands have been omitted for brevity.

(config-if)# ip nat outside
(config-if)# dialer pool 1
(config-if)# dialer-group 1
(config-if)# exit
(config)# dialer-list 1 protocol ip permit
(config)# ip nat inside source list 1 interface dialier1 overload
(config)# access-list 1 permit 192.168.100.0 0.0.0.255
(config)# ip route 0.0.0.0 0.0.0.0 dialer1</screen>
<simpara>Verify PPPoE connectivity</simpara>
<screen>show pppoe session</screen>
<simpara>Debug</simpara>
<screen>debug pppoe [data | errors | events | packets]</screen>
</section>
</section>
</chapter>
</part>
<part xml:id="_layer_3_technologies">
<title>Layer 3 Technologies</title>
<chapter xml:id="_ipv4">
<title>IPv4</title>
<section xml:id="_concepts_5">
<title>Concepts</title>
<itemizedlist>
<listitem>
<simpara>RFC 791</simpara>
</listitem>
</itemizedlist>
<section xml:id="_ip_packet_format">
<title>IP packet format</title>
<figure>
<title>IP packet format</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/ip-packet-format.png"/>
</imageobject>
<textobject><phrase>ip packet format</phrase></textobject>
</mediaobject>
</figure>
<variablelist>
<varlistentry>
<term>Version</term>
<listitem>
<simpara>Indicates the version of IP currently used.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>IP Header Length (IHL)</term>
<listitem>
<simpara>Indicates the datagram header length in 32-bit words.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Type-of-Service</term>
<listitem>
<simpara>Specifies how an upper-layer protocol would like a current datagram to be handled, and assigns datagrams various levels of importance. Currently referred to as Differentiated Services Code Point (DSCP) (6 bits).</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Total Length</term>
<listitem>
<simpara>Specifies the length, in bytes, of the entire IP packet, including the data and header.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Identification</term>
<listitem>
<simpara>Contains an integer that identifies the current datagram. This field is used to help piece together datagram fragments.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Flags</term>
<listitem>
<simpara>Consists of a 3-bit field of which the two low-order (least-significant) bits control fragmentation. The low-order bit specifies whether the packet can be fragmented. The middle bit specifies whether the packet is the last fragment in a series of fragmented packets. The third or high-order bit is not used.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Fragment Offset</term>
<listitem>
<simpara>Indicates the position of the fragment&#8217;s data relative to the beginning of the data in the original datagram, which allows the destination IP process to properly reconstruct the original datagram.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Time-to-Live</term>
<listitem>
<simpara>Maintains a counter that gradually decrements down to zero, at which point the datagram is discarded. This keeps packets from looping endlessly.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Protocol</term>
<listitem>
<simpara>Indicates which upper-layer protocol receives incoming packets after IP processing is complete.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Header Checksum</term>
<listitem>
<simpara>Helps ensure IP header integrity.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Source Address</term>
<listitem>
<simpara>Specifies the sending node.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Destination Address</term>
<listitem>
<simpara>Specifies the receiving node.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Options</term>
<listitem>
<simpara>Allows IP to support various options, such as security.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Data</term>
<listitem>
<simpara>Contains upper-layer information.</simpara>
</listitem>
</varlistentry>
</variablelist>
</section>
<section xml:id="_ip_addressing">
<title>IP addressing</title>
<itemizedlist>
<listitem>
<simpara>32-bits written in "dotted decimal"</simpara>
</listitem>
<listitem>
<simpara>classes: A,B,C,D,E</simpara>
</listitem>
<listitem>
<simpara>classless : prefix + host</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_cidr">
<title>CIDR</title>
<itemizedlist>
<listitem>
<simpara>Classless interdomain routing</simpara>
</listitem>
<listitem>
<simpara>defined in RFS 1517-1520</simpara>
</listitem>
<listitem>
<simpara>administrative assigment of large address blocks and the related summarized
routes for the purpose of reducing the size of the Internet routing table</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_private_addressing">
<title>Private addressing</title>
<itemizedlist>
<listitem>
<simpara>RFC 1918</simpara>
</listitem>
<listitem>
<simpara>10.0.0.0/8</simpara>
</listitem>
<listitem>
<simpara>172.16.0.0/12</simpara>
</listitem>
<listitem>
<simpara>192.168.0.0/16</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_vlsm">
<title>VLSM</title>
<itemizedlist>
<listitem>
<simpara>Variable length subnet mask</simpara>
</listitem>
</itemizedlist>
</section>
</section>
<section xml:id="_configuration_tasks_5">
<title>Configuration tasks</title>
<section xml:id="_assign_an_ip_address_to_an_interface">
<title>Assign an IP address to an interface</title>
<screen>(config-if)# ip address ip-address mask [secondary]</screen>
</section>
<section xml:id="_allow_the_use_of_ip_subnet_zero">
<title>Allow the use of IP subnet zero</title>
<screen>(config)# ip subnet-zero</screen>
</section>
<section xml:id="_specify_the_format_in_which_netmask_appear_for_the_current_session">
<title>Specify the format in which netmask appear for the current session</title>
<screen>term ip netmask-format {bitcount | decimal | hexadecimal}</screen>
</section>
<section xml:id="_specify_the_format_in_which_netmask_appear_for_the_current_line">
<title>Specify the format in which netmask appear for the current line</title>
<simpara>Enters line configuration mode for the range of lines specified by the first and last arguments.</simpara>
<screen>(config)# line vty first last</screen>
<simpara>Specifies the format the router uses to display the network mask for an individual line.</simpara>
<screen>term ip netmask-format {bitcount | decimal | hexadecimal}</screen>
</section>
<section xml:id="_use_ip_unnumbered_interfaces_on_point_to_point_wan_interfaces">
<title>Use IP unnumbered interfaces on point-to-point WAN interfaces</title>
<itemizedlist>
<listitem>
<simpara>Borrow the IP address of another interface</simpara>
</listitem>
</itemizedlist>
<screen>(config-if)# ip unnumbered interface-type interface-id</screen>
<itemizedlist mark="NOTE">
<title>Restrictions</title>
<listitem>
<simpara>only point-to-point (non-multiaccess) WAN interfaces</simpara>
</listitem>
<listitem>
<simpara>You cannot reboot a IOS image over an ip unnumbered interface</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_use_a_31_bit_prefix_on_point_to_point_wan_interfaces">
<title>Use a 31-bit prefix on point-to-point WAN interfaces</title>
<itemizedlist>
<listitem>
<simpara>Since RFC 3021</simpara>
</listitem>
<listitem>
<simpara>only on point-to-point WAN interfaces</simpara>
</listitem>
</itemizedlist>
<screen>(config)# ip classless
(config-if)# ip address a.b.c.d 255.255.255.254</screen>
</section>
</section>
<section xml:id="_troubleshooting_4">
<title>Troubleshooting</title>
<section xml:id="_display_the_ip_parameters_for_the_interface">
<title>Display the IP parameters for the interface</title>
<screen>show ip interface</screen>
</section>
<section xml:id="_display_the_ip_networks_the_device_is_connected_to">
<title>Display the IP networks the device is connected to</title>
<screen>show ip route connected</screen>
</section>
<section xml:id="_rfc_5227_ipv4_address_conflict_detection">
<title>RFC 5227 - IPv4 address conflict detection</title>

</section>
</section>
</chapter>
<chapter xml:id="_gre">
<title>GRE</title>
<section xml:id="_concepts_6">
<title>Concepts</title>
<section xml:id="_tunneling">
<title>Tunneling</title>
<itemizedlist>
<listitem>
<simpara>Tunneling encapsulates data packets from one protocol inside a different
protocol and transports the data packets unchanged across a foreign network.
Unlike encapsulation, tunneling allows a lower-layer protocol, or same-layer
protocol, to be carried through the tunnel.</simpara>
</listitem>
</itemizedlist>
<simpara>Components:</simpara>
<itemizedlist>
<listitem>
<simpara><emphasis role="strong">Passenger protocol</emphasis> : The protocol that you are encapsulating. Examples: AppleTalk, IP, IPX.</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">Carrier protocol</emphasis> : The protocol that does the encapsulating. Examples: GRE, IP-in-IP, L2TP,MPLS, STUN,DLSw+.</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">Transport protocol</emphasis> : The protocol used to carry the encapsulated protocol. The main transport protocol is IP.</simpara>
</listitem>
</itemizedlist>
<figure>
<title>IP Tunneling Terminology and Concepts</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/ip-tunneling-concepts.png"/>
</imageobject>
<textobject><phrase>ip tunneling concepts</phrase></textobject>
</mediaobject>
</figure>
</section>
<section xml:id="_gre_2">
<title>GRE</title>
<itemizedlist>
<listitem>
<simpara>IP protocol 47</simpara>
</listitem>
<listitem>
</listitem>
<listitem>
</listitem>
<listitem>
</listitem>
</itemizedlist>
<section xml:id="_gre_header">
<title>GRE header</title>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/gre-header-format.png.png"/>
</imageobject>
<textobject><phrase>gre header format.png</phrase></textobject>
</mediaobject>
</informalfigure>
<variablelist>
<varlistentry>
<term>Checksum present</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>bit 0</simpara>
</listitem>
<listitem>
<simpara>indicates that the checksum and the Reserved1 field are present</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Reserved0</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>12 bits</simpara>
</listitem>
<listitem>
<simpara>if any of bits 1-5 are non-zero, a receiver must discard the packet
unless receiver implements RFC1701</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
</section>
<section xml:id="_gre_keepalive">
<title>GRE keepalive</title>
<simpara>The GRE tunnel keepalive mechanism gives the ability for one side to originate
and receive keepalive packets to and from a remote router even if the remote
router does not support GRE keepalives. For GRE keepalives, the sender
pre-builds the keepalive response packet inside the original keepalive request
packet so that the remote end only needs to do standard GRE decapsulation of
the outer GRE IP header and then forward the inner IP GRE packet. GRE tunnel
keepalives timers on each side are independent and do not have to match. The
problem with the configuration of keepalives only on one side of the tunnel is
that only the router that has keepalives configured marks its tunnel interface
as down if the keepalive timer expires. The GRE tunnel interface on the other
side, where keepalives are not configured, remains up even if the other side of
the tunnel is down. The tunnel can become a black-hole for packets directed
into the tunnel from the side that did not have keepalives configured.</simpara>
</section>
</section>
</section>
<section xml:id="_configuration_7">
<title>Configuration</title>
<section xml:id="_configure_a_gre_tunnel">
<title>Configure a GRE tunnel</title>
<simpara>To build a tunnel, a tunnel interface must be defined on each of two routers
and the tunnel interfaces must reference each other.
At each router, the tunnel interface must be configured with a L3 address.
The tunnel endpoints, tunnel source, and tunnel destination must be defined,
and the type of tunnel must be selected.</simpara>
<simpara>Optional steps can be performed to customize the tunnel.</simpara>
<simpara>Remember to configure the router at each end of the tunnel.
If only one side of a tunnel is configured,
the tunnel interface may still come up and stay up (unless
keepalive is configured), but packets going into the tunnel will be dropped.</simpara>
<formalpara>
<title>summary steps</title>
<para>
<screen>interface tunnel number
  bandwidth kbps
  keepalive [period [retries]]
  tunnel source {ip-address | interface-type interface-number}
  tunnel destination {hostname | ip-address}
  tunnel key key-number
  tunnel mode {gre ip| gre multipoint}
  ip mtu bytes
  ip tcp mss mss-value
  tunnel path-mtu-discovery [age-timer {aging-mins| infinite}]</screen>
</para>
</formalpara>
<section xml:id="_create_a_tunnel_interface">
<title>Create a tunnel interface</title>
<screen>interface tunnel number</screen>
</section>
<section xml:id="_specify_a_source_interface_for_the_tunnel">
<title>Specify a source interface for the tunnel.</title>
<simpara>The tunnel source interface can be a local physical or logical local interface,
and not just an IP address</simpara>
<screen>tunnel source {a.b.c.d | source-interface }</screen>
</section>
<section xml:id="_specify_the_destination_ip_address_for_the_tunnel">
<title>Specify the destination IP address for the tunnel</title>
<tip>
<simpara>The router should have a route to this address, but not through the tunnel interface.</simpara>
</tip>
<screen>tunnel destination ip-address</screen>
</section>
<section xml:id="_specify_the_tunnel_mode">
<title>Specify the tunnel mode</title>
<simpara>The default tunnel mode is <emphasis role="strong">gre ip</emphasis>.</simpara>
<screen>tunnel mode [gre {ip | multipoint} | dvmrp | ipip | mpls | nos]</screen>
</section>
<section xml:id="_adjust_the_gre_keepalive">
<title>Adjust the GRE keepalive</title>
<simpara>Specifies the number of times that the device will continue to send keepalive
packets without response before bringing the tunnel interface protocol down.</simpara>
<simpara>GRE keepalive packets may be configured either on only one side of the tunnel or on both.
<simpara>This command is supported only on GRE point-to-point tunnels.</simpara>
<screen>(config-if)# keepalive [ period [retries]]</screen>
</section>
</section>
<section xml:id="_configuration_example">
<title>Configuration example</title>
<simpara>Note that Ethernet interface 0/1 is the tunnel source for Router A and the tunnel destination for Router B.
Fast Ethernet interface 0/1 is the tunnel source for Router B and the tunnel destination for Router A.</simpara>
<variablelist>
<varlistentry>
<term>Router A</term>
<listitem>
<screen>interface Tunnel0
 ip address 10.1.1.2 255.255.255.0
 tunnel source Ethernet0/1
 tunnel destination 192.168.3.2
 tunnel mode gre ip
!
interface Ethernet0/1
 ip address 192.168.4.2 255.255.255.0</screen>
</listitem>
</varlistentry>
<varlistentry>
<term>Router B</term>
<listitem>
<screen>interface Tunnel0
 ip address 10.1.1.1 255.255.255.0
 tunnel source FastEthernet0/1
 tunnel destination 192.168.4.2
 tunnel mode gre ip
!
interface FastEthernet0/1
 ip address 192.168.3.2 255.255.255.0</screen>
</listitem>
</varlistentry>
</variablelist>
</section>
</section>
<section xml:id="_troubleshooting_5">
<title>Troubleshooting</title>
<simpara>Three reasons for a GRE tunnel to shut down:</simpara>
<itemizedlist>
<listitem>
<simpara>There is no route to the tunnel destination address.</simpara>
</listitem>
<listitem>
<simpara>The interface that anchors the tunnel source is down.</simpara>
</listitem>
<listitem>
<simpara>The route to the tunnel destination address is through the tunnel itself. %TUN-5-RECURDOWN:Tunnel0</simpara>
</listitem>
</itemizedlist>
<simpara>With the above three reasons for tunnel shut down are problems local to the
router at the tunnel endpoints and do not cover problems in the intervening
network.</simpara>
<simpara>Also if the two routers tunnel modes do not match, the tunnel interface can
still stay in an up/ip state but the routers cannot forward packets because of
the mismatch encapsulation.</simpara>
<section xml:id="__tun_5_recurdown_error_message_and_flapping_eigrp_ospf_bgp_neighbors_over_a_gre_tunnel">
<title>"%TUN-5-RECURDOWN" error message and flapping EIGRP/OSPF/BGP neighbors over a GRE tunnel</title>
</section>
</section>
<section xml:id="_questions_2">
<title>Questions</title>
<orderedlist numeration="arabic">
<listitem>
<simpara>What is the minimum amount of additional header that GRE adds to a packet?</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>16 bytes</simpara>
</listitem>
<listitem>
<simpara>20 bytes</simpara>
</listitem>
<listitem>
<simpara>24 bytes</simpara>
</listitem>
<listitem>
<simpara>36 bytes</simpara>
</listitem>
<listitem>
<simpara>48 bytes</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Which of the following are valid options in a GRE header (select all that apply)?</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>GRE Header Length</simpara>
</listitem>
<listitem>
<simpara>Checksum Present</simpara>
</listitem>
<listitem>
<simpara>Key Present</simpara>
</listitem>
<listitem>
<simpara>External Encryption</simpara>
</listitem>
<listitem>
<simpara>Protocol</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>What is the purpose of a GRE tunnel interface?</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>It is always the tunnel source interface.</simpara>
</listitem>
<listitem>
<simpara>It is always the tunnel destination interface.</simpara>
</listitem>
<listitem>
<simpara>It is where the protocol that travels through the tunnel is configured.</simpara>
</listitem>
<listitem>
<simpara>It is the interface that maps to the physical tunnel port.</simpara>
</listitem>
<listitem>
<simpara>It is not used today</simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
</chapter>
<chapter xml:id="_rip">
<title>RIP</title>
<section xml:id="_overview_9">
<title>Overview</title>
<itemizedlist>
<listitem>
<simpara>Distance vector protocol</simpara>
</listitem>
<listitem>
<simpara>transport: UDP 520</simpara>
</listitem>
<listitem>
<simpara>update destination:</simpara>
<itemizedlist>
<listitem>
<simpara>broadcast 255.255.255.255 for RIPv1</simpara>
</listitem>
<listitem>
<simpara>multicast 224.0.0.9 for RIPv2</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>full updates every 30 seconds</simpara>
</listitem>
<listitem>
<simpara>Trigerred updates</simpara>
</listitem>
<listitem>
<simpara>multiple routes to the same subnet with equal metric:</simpara>
<itemizedlist>
<listitem>
<simpara>1 to 6</simpara>
</listitem>
<listitem>
<simpara>default = 4</simpara>
</listitem>
<listitem>
<simpara>configured with <emphasis role="strong">ip maximum-paths <emphasis>n</emphasis></emphasis></simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>metric: hop count with</simpara>
<itemizedlist>
<listitem>
<simpara>1 signifying a directly connected network of the advertising router</simpara>
</listitem>
<listitem>
<simpara>16 signifying an unreachable network.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Support CIDR, VLSM, authentication</simpara>
</listitem>
<listitem>
<simpara>Periodic updates every 30 seconds to multicast address 224.0.0.9</simpara>
</listitem>
<listitem>
<simpara>Split horizon with poison reverse</simpara>
</listitem>
<listitem>
<simpara>Subnet mask included in route entry</simpara>
</listitem>
<listitem>
<simpara>Administrative distance: 120</simpara>
</listitem>
<listitem>
<simpara>Route tags when routes are redistributed into RIP</simpara>
</listitem>
<listitem>
<simpara>Can advertise a next-hop router that is different from itself</simpara>
</listitem>
<listitem>
<simpara>Does not keep a separate topology table</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_default_rip_configuration">
<title>Default RIP configuration</title>
<itemizedlist>
<listitem>
<simpara>version : 1</simpara>
</listitem>
<listitem>
<simpara>auto-summary : enable</simpara>
</listitem>
<listitem>
<simpara>authentication : disable</simpara>
</listitem>
<listitem>
<simpara>authentication mode: text</simpara>
</listitem>
<listitem>
<simpara>split-horizon : enable</simpara>
</listitem>
<listitem>
<simpara>Interpacket delay : no</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_basic_configuration_2">
<title>Basic configuration</title>
<screen>(config)#router rip
(config-router)#version 2
(config-router)#network 10.0.0.0
(config-router)#no auto-summary</screen>
</section>
<section xml:id="_version_4">
<title>Version</title>
<formalpara>
<title>Task: Specify the RIP version globally</title>
<para>
<screen>(config-router)# version {1 | 2}</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure an interface to send only a RIPv2 packets</title>
<para>
<screen>(config-if)ip rip send version {1,2}</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure an interface to receive only a RIPv2 packets</title>
<para>
<screen>(config-if)ip rip receive version {1|2}</screen>
</para>
</formalpara>
</section>
<section xml:id="_authentication">
<title>Authentication</title>
<formalpara>
<title>Task: Enable RIP authentication</title>
<para>
<screen>(config-if)# ip rip authentication key-chain &lt;name&gt;
(config-if)# ip rip authentication mode {text | md5}</screen>
</para>
</formalpara>
<tip>
<simpara>Use *show key chain" to spot invisible blank space after passwords</simpara>
</tip>
</section>
<section xml:id="_summarization">
<title>Summarization</title>
<itemizedlist>
<listitem>
<simpara>Default: auto-summarization</simpara>
<itemizedlist>
<listitem>
<simpara>summarizes prefixes to the classful network boundaries
when classful network boundaries are crossed.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Supernet advertisement not allowed</simpara>
<itemizedlist>
<listitem>
<simpara>e.g. <emphasis role="strong">ip summary-address rip 10.0.0.0 252.0.0.0</emphasis></simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Disable automatic route summarization</title>
<para>
<screen>(config-router)# no auto-summary</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Summarize a prefix</title>
<para>
<screen>(config-if)# ip summary-address rip &lt;ip-address&gt; &lt;mask&gt;</screen>
</para>
</formalpara>
</section>
<section xml:id="_route_updates">
<title>Route updates</title>
<formalpara>
<title>Task: Disable sending RIP updates on an interface but continue to receive the update</title>
<para>
<screen>(config-if)# passive-interface { default | &lt;type number&gt;}</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Disable the validation of the source IP address of incoming RIP routing updates</title>
<para>
<screen>(config-router)# no validate-update-source</screen>
</para>
</formalpara>
</section>
<section xml:id="_route_filtering">
<title>Route filtering</title>
<formalpara>
<title>Task: Stop advertising a route with a prefix-list</title>
<para>
<screen></screen>
</para>
</formalpara>
<formalpara>
<title>Task: filter out RIP routes with extended access lists</title>
<para>
<screen>(config-router)# distribute-list &lt;extended-acl&gt; {in|out} [&lt;interface-id&gt;]</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>The source field in the ACL matches the update source of the route</simpara>
</listitem>
<listitem>
<simpara>The destination field represents the network address</simpara>
</listitem>
</itemizedlist>
</note>
</section>
<section xml:id="_route_metric">
<title>Route metric</title>

</section>
<section xml:id="_split_horizon">
<title>Split horizon</title>
<formalpara>
<title>Task: Disable split horizon</title>
<para>
<screen>(config-if)# no ip split-horizon</screen>
</para>
</formalpara>
</section>
<section xml:id="_interpacket_delay_for_rip_updates">
<title>Interpacket delay for RIP updates</title>
<itemizedlist>
<listitem>
<simpara>Useful when high-end router send RIP updates to low-end router</simpara>
</listitem>
<listitem>
<simpara>default: 0 in range 8 to 50 milliseconds</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Configure interpacket delay</title>
<para>
<screen>(config-if)# output-delay &lt;milliseconds&gt;</screen>
</para>
</formalpara>
</section>
<section xml:id="_rip_optimization_over_wan">
<title>Rip Optimization over WAN</title>
<formalpara>
<title>Task: Enable triggered extensions for RIP</title>
<para>
<screen>(config)# int serial &lt;controller-number&gt;
(config-if)# ip rip trigerred</screen>
</para>
</formalpara>
</section>
<section xml:id="_offset_list">
<title>Offset-list</title>
<formalpara>
<title>Task: Add an offset to incoming and outgoing metrics to RIP routes</title>
<para>
<screen>(config-router)# offset-list {&lt;acl&gt;} {in | out } &lt;offset&gt; {interface-type-number&gt;}</screen>
</para>
</formalpara>
</section>
<section xml:id="_timers_3">
<title>Timers</title>
<formalpara>
<title>Task: Configure RIP timers</title>
<para>
<screen>(config-router)# timers basic &lt;update&gt; &lt;invalid&gt; &lt;holddown&gt; &lt;flush&gt; [&lt;sleeptime&gt;]</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>Update timer: interval between updates. Default: 30 seconds</simpara>
</listitem>
<listitem>
<simpara>Invalid timer: time in seconds after which a route is declared invalid.</simpara>
<itemizedlist>
<listitem>
<simpara>Should be at least 3 times the update timer.</simpara>
</listitem>
<listitem>
<simpara>Invalid routes are still used for forwarding packets</simpara>
</listitem>
<listitem>
<simpara>Default: 180 seconds</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Holdown timer: interval during which routing information about better paths is suppressed.</simpara>
<itemizedlist>
<listitem>
<simpara>Should be at least 3 times the update timer</simpara>
</listitem>
<listitem>
<simpara>The route is marked inaccessible and advertised as unreachable.</simpara>
</listitem>
<listitem>
<simpara>Holdown routes are still used for forwarding packets</simpara>
</listitem>
<listitem>
<simpara>Default: 180 seconds</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Flush timer: amount of time that must pass berore a route is removed from the RIB. Default: 240 seconds</simpara>
</listitem>
<listitem>
<simpara>Sleep time: amount of time for which routing updates will be postponed.</simpara>
</listitem>
</itemizedlist>
</note>
<formalpara>
<title>Task: Specify a default update interval on an interface</title>
<para>
<screen>(config-if)# ip rip advertise &lt;seconds&gt;</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>The comd above overrides the update timers set by <emphasis role="strong">timers basic</emphasis> command.</simpara>
</listitem>
</itemizedlist>
</note>
</section>
</chapter>
<chapter xml:id="_eigrp">
<title>EIGRP</title>
<section xml:id="_overview_10">
<title>Overview</title>
<itemizedlist>
<listitem>
<simpara>classless protocol (VLSM, summarization)</simpara>
</listitem>
<listitem>
<simpara>multiple routed protocol support (ipv4, ipx, appletalk, )</simpara>
</listitem>
<listitem>
<simpara>uses its own transport protocol</simpara>
<itemizedlist>
<listitem>
<simpara>IP protocol 88: RTP</simpara>
</listitem>
<listitem>
<simpara>uses multicast to 224.0.0.10 and unicast</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Forms active neighbor adjacencies</simpara>
</listitem>
<listitem>
<simpara>DUAL for loop-free topology and fast convergence</simpara>
</listitem>
<listitem>
<simpara>granular metric</simpara>
</listitem>
<listitem>
<simpara>unequal cost load balancing</simpara>
</listitem>
<listitem>
<simpara>summarization</simpara>
</listitem>
<listitem>
<simpara>Supports MD5 based authentication</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_eigrp_messages">
<title>EIGRP messages</title>
<variablelist>
<varlistentry>
<term>Hello</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>multicast to 224.0.0.10</simpara>
</listitem>
<listitem>
<simpara>do not require acknowlegment</simpara>
</listitem>
<listitem>
<simpara>can be used as Ack if sent without data</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Ack</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>unicast</simpara>
</listitem>
<listitem>
<simpara>contains a nonzero acknowledgement number</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Update</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>multicast or unicast</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Query</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>multicast unless in response to a received query</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Reply</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>unicast</simpara>
</listitem>
<listitem>
<simpara>indicates that it does not need to go into Active state
because it has a FS</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Request</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>unicast or multicast</simpara>
</listitem>
<listitem>
<simpara>get specific info from neighbors</simpara>
</listitem>
<listitem>
<simpara>used in route server applications</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<formalpara>
<title>Task: Exchange EIGRP packets only as unicast</title>
<para>
<screen>(config-router)# neighbor &lt;a.b.c.d&gt; &lt;interface-id&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Exchange EIGRP packets only as unicast</title>
<para>
<screen>(config-router-af-interface)# neighbor &lt;a.b.c.d&gt; &lt;interface-id&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: debug EIGRP</title>
<para>
<screen>debug ip eigrp packet [hello | ack | update } quey | reply]</screen>
</para>
</formalpara>
</section>
<section xml:id="_neighbors_3">
<title>Neighbors</title>
<itemizedlist>
<listitem>
<simpara>discovered with Hello packets</simpara>
</listitem>
<listitem>
<simpara>must agree on</simpara>
</listitem>
<listitem>
<simpara>primary IPv4 subnet</simpara>
</listitem>
<listitem>
<simpara>Autonomous System Number</simpara>
</listitem>
<listitem>
<simpara>authentication</simpara>
</listitem>
<listitem>
<simpara>K values</simpara>
</listitem>
<listitem>
<simpara>do not need to agree on timers</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Verify neighbor adjacencies</title>
<para>
<screen># sh ip eigrp neighbors [detail]</screen>
</para>
</formalpara>
<tip>
<simpara>Check that the queue count is zero</simpara>
</tip>
</section>
<section xml:id="_eigrp_loop_prevention_techniques">
<title>EIGRP Loop prevention techniques</title>

</section>
<section xml:id="_split_horizon_2">
<title>Split horizon</title>
<itemizedlist>
<listitem>
<simpara>Enable by default on all interfaces</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Disable split horizon for EIGRP</title>
<para>
<screen>(config-if)# no ip split-horizon eigrp &lt;asn&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Disable split horizon in named configuration</title>
<para>
<screen>(config-router-af-interface)# no split-horizon</screen>
</para>
</formalpara>
</section>
<section xml:id="_dual_feasibility_condition">
<title>DUAL feasibility condition</title>

</section>
<section xml:id="_eigrp_reconvergence">
<title>EIGRP reconvergence</title>
<itemizedlist>
<listitem>
<simpara>if the successor becomes unreachable,</simpara>
<itemizedlist>
<listitem>
<simpara>if there is a feasible successor</simpara>
<itemizedlist>
<listitem>
<simpara>use the FS without local computation</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>else</simpara>
<itemizedlist>
<listitem>
<simpara>query the neighbors and put the route in active</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Transport: IP protocol 88</simpara>
</listitem>
<listitem>
<simpara>Administrative distance : 90 internal routes, 5 summary routes , 170 external routes</simpara>
</listitem>
<listitem>
<simpara>Hello interval</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_metric">
<title>Metric</title>
<simpara>metric = 256 * [K1 x bandwidth + (k2 x bandwidth)/ (256 -load) + k3 x delay] x [k5 /( reliability + k4)]</simpara>
<itemizedlist>
<listitem>
<simpara>bandwith: 10<superscript>7</superscript> / minimum bandwidth in Kbps</simpara>
</listitem>
<listitem>
<simpara>delay: in tens-of-microseconds</simpara>
</listitem>
<listitem>
<simpara>reliability: likelihood of successful packet transmission with 0 means 0% and 255 means 100%</simpara>
</listitem>
<listitem>
<simpara>load : effective load of the route with 255 means 100% loading</simpara>
</listitem>
<listitem>
<simpara>mtu : minimum Maximum transmission unit</simpara>
</listitem>
<listitem>
<simpara>default values: k1,k2,k3,k4,k5 = 1,0,1,0,0</simpara>
</listitem>
<listitem>
<simpara>the values of K must match for the neighbors to become adjacents</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Description</title>
<para>
<screen>(config-router)# metric weights</screen>
</para>
</formalpara>
</section>
<section xml:id="_wide_metric">
<title>Wide Metric</title>
<simpara>Metric = [(K1*Minimum Throughput + (K2*Minimum Throughput/(256-Load) + (K3*Total Latency) + (K6*Extended Attributes)]* [K5/(K4 + Reliability)]</simpara>
</section>
<section xml:id="_eigrp_autonomous_system_configuration">
<title>EIGRP Autonomous System Configuration</title>
<itemizedlist>
<listitem>
<simpara>created with the command  <emphasis role="strong">router eigrp</emphasis> &lt;autonomous-system-number&gt;</simpara>
</listitem>
<listitem>
<simpara>EIGRP VPNS can be configured only under IPv4 address family. A VRF instance and route distinguisher must be defined before the address family session can be created.</simpara>
</listitem>
<listitem>
<simpara>recommendation: configure the asn when the address family is configured by <emphasis role="strong">router eigrp</emphasis> &lt;asn&gt; <emphasis role="strong">address-family</emphasis> or seperately using the <emphasis role="strong">autonomous-system</emphasis> command.</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_eigrp_named_configuration">
<title>EIGRP Named Configuration</title>
<itemizedlist>
<listitem>
<simpara>Global params under SAFI or in <emphasis role="strong">config-router-topology base</emphasis> mode</simpara>
</listitem>
<listitem>
<simpara>interface params in <emphasis role="strong">config-router-af-interface</emphasis> mode</simpara>
</listitem>
<listitem>
<simpara>wide-meric scaling automatic enabled</simpara>
</listitem>
<listitem>
<simpara>can* be configured in IPv4 and IPv6 named configuration</simpara>
</listitem>
<listitem>
<simpara>VRF instance and a RD are optional</simpara>
</listitem>
<listitem>
<simpara>EIGRP IPv6 VRF-lite feature is available only in EIGRP named configuration</simpara>
</listitem>
<listitem>
<simpara>EIGRP VPNs can be configured. A VRF and RD must be defind before the address-family session can be created.</simpara>
</listitem>
<listitem>
<simpara>a single EIGRP routing process can support multiple VRFs.  However, a single VRF can be supported by each VPN . Redistribution between VRFs is not supported.</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Configure a basic EIGRP named configuration</title>
<para>
<screen>(config)# router eigrp &lt;virtual-instance-name&gt;
(config-router)# address-family ipv4 [multicast] [umicast] [vrf vrf-name] autonomous-system asn
(config-router-af)# network a.b.c.d</screen>
</para>
</formalpara>
</section>
<section xml:id="_eigrpv3">
<title>EIGRPv3</title>
<screen>(config-router)# address-family ipv6 [unicast] [vrf vrf-name] autonomous-system asn</screen>
</section>
<section xml:id="_eigrp_neighbor_relationship_maintenance">
<title>EIGRP Neighbor Relationship Maintenance</title>
<itemizedlist>
<listitem>
<simpara>Hellos</simpara>
</listitem>
<listitem>
<simpara>adjancency</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_dual_finite_state_machine">
<title>DUAL Finite State Machine</title>
<itemizedlist>
<listitem>
<simpara>a successor is a neighboring router that has a least-cost path to a
destination that is guarentedd not to be part of a routinf</simpara>
</listitem>
<listitem>
<simpara>Feasibility condition: RD &lt; FD</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_protocol_dependent_modules">
<title>Protocol-Dependent Modules</title>

</section>
<section xml:id="_goodbye_message">
<title>Goodbye Message</title>
<itemizedlist>
<listitem>
<simpara>broadcast when an EIGRP routing process is shut down</simpara>
</listitem>
<listitem>
<simpara>Speeds convergence as peers don&#8217;t have to wait the hold timer expiration</simpara>
</listitem>
<listitem>
<simpara>Normal message displayed by routers that support Good Bye message</simpara>
</listitem>
</itemizedlist>
<screen>*Apr 26 13:48:42.523: %DUAL-5-NBRCHANGE: IP-EIGRP(0) 1: Neighbor 10.1.1.1
(Ethernet0/0) is down: Interface Goodbye received</screen>
<itemizedlist>
<listitem>
<simpara>Misleading message displayed by router which doesn&#8217;t support the Goodbye message</simpara>
</listitem>
</itemizedlist>
<screen>*Apr 26 13:48:41.811: %DUAL-5-NBRCHANGE: IP-EIGRP(0) 1: Neighbor
(Ethernet0/0) is down: K-value mismatch</screen>
<itemizedlist>
<listitem>
<simpara>The receipt of a goodbye message by a non supporting peer does not disrupt normal network operations.</simpara>
</listitem>
<listitem>
<simpara>The nonsupporting peer will terminate the session when the hold timer expires</simpara>
</listitem>
<listitem>
<simpara>The sending and receiving routers will converge normally after the sender reloads</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_routing_metric_offset_lists">
<title>Routing Metric Offset Lists</title>

</section>
<section xml:id="_eigrp_cost_metrics">
<title>EIGRP Cost Metrics</title>

</section>
<section xml:id="_summarization_2">
<title>Summarization</title>
<itemizedlist>
<listitem>
<simpara>All subnets are suppressed</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Enable auto-summarization</title>
<para>
<screen>(config-router)# auto-summarization</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>Cannot be used in divergent networks</simpara>
</listitem>
<listitem>
<simpara>create null0 summary</simpara>
</listitem>
</itemizedlist>
</note>
<formalpara>
<title>Task: Advertise a single summary in EIGRP classic mode</title>
<para>
<screen>(config-if)# ip summary-address eigrp &lt;asn&gt; &lt;prefix&gt; &lt;mask&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Advertise a single summary in EIGRP named mode</title>
<para>
<screen>(config-router-af-interface)# summary-address &lt;prefix&gt; &lt;mask&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure summarization to advertise a default route into EIGRP</title>
<para>
<screen>(config-if)# ip summary-address eigrp &lt;asn&gt; 0.0.0.0 0.0.0.0</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>All subnets will be suppressed because all IPv4 networks are subnet of 0/0</simpara>
</listitem>
</itemizedlist>
</note>
<section xml:id="_leak_map">
<title>Leak map</title>
<formalpara>
<title>Task: Advertise specific subnets of a EIGRP summary</title>
<para>
<screen>(config-if)# ip summary-address eigrp &lt;asn&gt; &lt;prefix&gt; &lt;mask&gt; leak-map &lt;route-maps&gt;</screen>
</para>
</formalpara>
</section>
<section xml:id="_floating_summary_routes">
<title>Floating Summary Routes</title>
<simpara>TODO
- By default, summarization install a route to Null0 to match the summary
  to prevent forwarding traffic for unreachable destinations.
-</simpara>
</section>
<section xml:id="_poisoned_floating_summarization">
<title>Poisoned Floating Summarization</title>
<simpara>TODO</simpara>
</section>
</section>
<section xml:id="_eigrp_route_authentication">
<title>EIGRP Route Authentication</title>
<itemizedlist>
<listitem>
<simpara>Supports MD5 in classic mode</simpara>
</listitem>
<listitem>
<simpara>supports MD5 and SHA-256 in multi-af mode</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Use MD5 password in EIGRP classic mode</title>
<para>
<screen>(config-if)# ip authentication mode eigrp &lt;asn&gt; md5
(config-if)# ip authentication key-chain eigrp &lt;asn&gt; &lt;password&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Use MD5 password in EIGRP named mode</title>
<para>
<screen>(config-router-af-interface)# authentication mode md5
(config-router-af-interface)# authentication key-chain &lt;sesame&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Authenticate EIGRP neighbor with SHA-256 password</title>
<para>
<screen>(config-router-af-interface)# authenticate mode hmac-sha-256 &lt;password&gt;</screen>
</para>
</formalpara>
<itemizedlist>
<listitem>
<simpara>can be applied at the <emphasis role="strong">af-interface-default</emphasis> in multi-af mode</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_hello_packets_and_the_hold_time_intervals">
<title>Hello Packets and the Hold-Time Intervals</title>

</section>
<section xml:id="_split_horizon_3">
<title>Split Horizon</title>

</section>
<section xml:id="_link_bandwidth_percentage">
<itemizedlist>
<listitem>
</listitem>
<listitem>
<simpara>bandwidth configured by <emphasis role="strong">bandwidth</emphasis> in AS configuration and <emphasis role="strong">bandwith-percent</emphasis> for named configuration</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_eigrp_stub_routing">
<title>EIGRP Stub Routing</title>

</section>
<section xml:id="_eigrp_stub_routing_leak_map_support">
<title>EIGRP Stub Routing Leak Map Support</title>

</section>
<section xml:id="_eigrp_autonomous_system_configuration_2">
<title>EIGRP autonomous system configuration</title>
<formalpara>
<title>Task: Create a basic EIGRP AS system configuration</title>
<para>
<screen>(config)# router eigrp asn
(config-router)# network a.b.c.d [e.f.g.h]</screen>
</para>
</formalpara>
<itemizedlist>
<listitem>
<simpara>A maximum of 30 EIGRP can be configured</simpara>
</listitem>
<listitem>
<simpara>EIGRP sends updates only interfaces in the specified networks</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_verify_eigrp_topology">
<title>verify eigrp topology</title>
<screen>show ip eigrp topology [all-links]
show ip eigrp topology [prefix/len]</screen>
</section>
</chapter>
<chapter xml:id="_ospf">
<title>OSPF</title>
<section xml:id="_overview_11">
<title>Overview</title>
<itemizedlist>
<listitem>
</listitem>
<listitem>
<simpara>RFC 2328</simpara>
</listitem>
<listitem>
<simpara>Dijkstra short path first algorithm</simpara>
</listitem>
<listitem>
<simpara>classless protocol</simpara>
</listitem>
<listitem>
<simpara>Transport via IP protocol 89</simpara>
<itemizedlist>
<listitem>
<simpara>multicasts to 224.0.0.5 for AllSPF routers and to 224.0.0.6 for Designated Routers</simpara>
</listitem>
<listitem>
<simpara>unicasts</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>equal-cost multipath</simpara>
</listitem>
<listitem>
<simpara>hierarchical design to reduce traffic</simpara>
</listitem>
<listitem>
<simpara>authentication updates</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_neighbors_4">
<title>Neighbors</title>
<simpara>To form adjacency neighbors must agree on &#8230;&#8203;</simpara>
<itemizedlist>
<listitem>
<simpara>unique router ID</simpara>
</listitem>
<listitem>
<simpara>unique interface IP address</simpara>
<itemizedlist>
<listitem>
<simpara>primary IP address for OSPFv2</simpara>
</listitem>
<listitem>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>common attributes</simpara>
<itemizedlist>
<listitem>
<simpara>interface area-id</simpara>
</listitem>
<listitem>
<simpara>authentication</simpara>
</listitem>
<listitem>
<simpara>hello and dead intervals</simpara>
</listitem>
<listitem>
<simpara>stub area flag</simpara>
</listitem>
<listitem>
<simpara>interface MTU ??</simpara>
</listitem>
<listitem>
<simpara>other optional capabilities</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</section>
<section xml:id="_ospf_cost">
<title>Ospf cost</title>
<simpara><inlineequation><alt><![CDATA[cost = 10^8 / bandwidth(bps)]]></alt><mathphrase><![CDATA[cost = 10^8 / bandwidth(bps)]]></mathphrase></inlineequation></simpara>
<formalpara>
<title>Task: Description</title>
<para>
<screen>(config-router)# auto-cost reference-bandwitch &lt;bps&gt;</screen>
</para>
</formalpara>
</section>
<section xml:id="_common_ospf_protocol_header_format">
<title>Common OSPF protocol header format</title>
<section xml:id="_packet_types">
<title>Packet types</title>
<figure>
<title>OSPF header format</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/ospf-header-format.png"/>
</imageobject>
<textobject><phrase>OSPF header format</phrase></textobject>
</mediaobject>
</figure>
<variablelist>
<varlistentry>
<term>Version</term>
<listitem>
<simpara>The OSPF version number (2).</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Type</term>
<listitem>
</listitem>
</varlistentry>
<varlistentry>
<term>Packet length</term>
<listitem>
<simpara>Length of the protocol packet in bytes including the OSPF header.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Router ID</term>
<listitem>
<simpara>The ID of the router originating the packet.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Area ID</term>
<listitem>
<simpara>The area that the packet is being sent into.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Checksum</term>
<listitem>
<simpara>The standard IP checksum of the entire contents of the packet, excluding the 64-bit authentication field.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>AuType</term>
<listitem>
<simpara>Identifies the authentication scheme to be used for the packet.</simpara>
<itemizedlist>
<listitem>
<simpara>0: no authentication</simpara>
</listitem>
<listitem>
<simpara>1: plain-text authentication</simpara>
</listitem>
<listitem>
<simpara>2: cryptographic authentication</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Authentication</term>
<listitem>
<simpara>A 64-bit field for use by the authentication scheme.</simpara>
</listitem>
</varlistentry>
</variablelist>
</section>
<section xml:id="_hello_packet">
<title>Hello Packet</title>
<figure>
<title>OSPF Hello Packet format</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/ospf-hello-packet-format.png"/>
</imageobject>
<textobject><phrase>OSPF Hello Packet format</phrase></textobject>
</mediaobject>
</figure>
</section>
<section xml:id="_database_description_packet">
<title>Database Description Packet</title>
<figure>
<title>OSPF Hello Packet format</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/ospf-database-description-message-format.png"/>
</imageobject>
<textobject><phrase>OSPF Hello Packet format</phrase></textobject>
</mediaobject>
</figure>
<variablelist>
<varlistentry>
<term>Interface MTU</term>
<listitem>
<simpara>Size of the largest IP message that can be sent on this router&#8217;s interface
without fragmentation</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Options</term>
<listitem>
<simpara>For optional OSPF capabilities</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>I-bit</term>
<listitem>
<simpara>Initial for the first in a sequence of DD messages</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>M-bit</term>
<listitem>
<simpara>More DD follow this one</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>MS-bit</term>
<listitem>
<simpara>if this message is sent by the master in the communication</simpara>
</listitem>
</varlistentry>
</variablelist>
<informaltable frame="all" rowsep="1" colsep="1">
<tgroup cols="3">
<colspec colname="col_1" colwidth="10*"/>
<colspec colname="col_2" colwidth="30*"/>
<colspec colname="col_3" colwidth="60*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Type</simpara></entry>
<entry align="left" valign="top"><simpara>Description</simpara></entry>
<entry align="left" valign="top"><simpara>functionality</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>1</simpara></entry>
<entry align="left" valign="top"><simpara>Hello</simpara></entry>
<entry align="left" valign="top"><simpara>discover/maintain neighbors</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>2</simpara></entry>
<entry align="left" valign="top"><simpara>Database description</simpara></entry>
<entry align="left" valign="top"><simpara>summarize database contents</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>3</simpara></entry>
<entry align="left" valign="top"><simpara>database download</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>4</simpara></entry>
<entry align="left" valign="top"><simpara>databases update</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>5</simpara></entry>
<entry align="left" valign="top"><simpara>flooding acknowledgement</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
<section xml:id="_link_state_request">
<figure>
<mediaobject>
<imageobject>
</imageobject>
</mediaobject>
</figure>
</section>
<section xml:id="_link_state_update">
<figure>
<mediaobject>
<imageobject>
</imageobject>
</mediaobject>
</figure>
</section>
<section xml:id="_link_state_acknowledgment">
<figure>
<mediaobject>
<imageobject>
</imageobject>
</mediaobject>
</figure>
<variablelist>
<varlistentry>
<term>LSA headers</term>
<listitem>
<simpara>Contains LSA headers to identify the LSAs acknowledged.</simpara>
</listitem>
</varlistentry>
</variablelist>
</section>
<section xml:id="_link_state_packets">
<variablelist>
<varlistentry>
<term>Type 1</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Router LSA</simpara>
</listitem>
<listitem>
<simpara>generated by each router for each interface in the area</simpara>
</listitem>
<listitem>
<simpara>flooded only within the same area</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Type 2</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Network LSA</simpara>
</listitem>
<listitem>
<simpara>generated by DR</simpara>
</listitem>
<listitem>
<simpara>describes the set of routers attached to a particular network</simpara>
</listitem>
<listitem>
<simpara>flooded only within the area that contains the network</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Type 3</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Summary inter-area LSA</simpara>
</listitem>
<listitem>
<simpara>Generated by ABR</simpara>
</listitem>
<listitem>
<simpara>describes inter-area routes to network</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Type 4</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Summary inter-area LSA</simpara>
</listitem>
<listitem>
<simpara>Generated by ABR</simpara>
</listitem>
<listitem>
<simpara>describes routes to ASBR</simpara>
</listitem>
<listitem>
<simpara>tells other other routers in the area how to get to the advertising router
of an external route</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Type 5</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>AS external LSA</simpara>
</listitem>
<listitem>
<simpara>originated by ASBR</simpara>
</listitem>
<listitem>
<simpara>describes routes to destinations external to the AS</simpara>
</listitem>
<listitem>
<simpara>flooded all over except stub areas</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<note>
<simpara>OSPF&#8217;s SPF algorithm links different pieces of information together.
For a router in Area 1 to reach the external route in Area 3,
it has to look at the Type-5 that represents the external route.
Then it has to look at the Type-4 representing the ABR on the area that the ASBR lives in.
Then we have to look at the Type-3 to get to that remote ABR.
Finally we look at the Type-1 and Type-2 LSAs in our area to determine how to get to our closest ABR.
Read more
</note>
</section>
</section>
<section xml:id="_backbone_and_area_0">
<title>backbone and area 0</title>

</section>
<section xml:id="_virtual_links">
<title>Virtual links</title>
<itemizedlist>
<listitem>
<simpara>purposes:</simpara>
<itemizedlist>
<listitem>
<simpara>Areas not physically connected to area 0</simpara>
</listitem>
<listitem>
<simpara>partitioning the backbone</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>transit area can not be stub</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Router A</title>
<para>
<screen>(config)# router ospf 10
</para>
</formalpara>
<formalpara>
<title>Router B</title>
<para>
<screen>(config)# router ospf 10
</para>
</formalpara>
<formalpara>
<title>Task: TODO</title>
<para>
<screen>(config-router)# no capability transit</screen>
</para>
</formalpara>
<section xml:id="_adjacency">
<title>Adjacency</title>

</section>
<section xml:id="_dr_election">
<title>DR election</title>
<itemizedlist>
<listitem>
<simpara>There is no pre-emption in ospf</simpara>
<itemizedlist>
<listitem>
<simpara>Router must wait for the failure of the current DR</simpara>
</listitem>
<listitem>
<simpara>use the WAIT timer = DEAD timer</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>on hub-and-spoke, best practice is to have hub as DR and spokes not eligible as DR with priority=0jgt</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_router_id">
<title>Router id</title>
<simpara>Determined by these rules in order of preference at boot or ospf process restart:</simpara>
<itemizedlist>
<listitem>
<simpara>manually configured router id</simpara>
</listitem>
<listitem>
<simpara>highest IP address of an up/up loopback not used by other OSPF process</simpara>
</listitem>
<listitem>
<simpara>highest IP address of an up/up non-loopack interfaces  not used by other OSPF process</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Set the router-id</title>
<para>
<screen>(config-router)# router-id &lt;a.b.c.d&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Priority</title>
<para>
<screen>(config-if)# ip ospf priority &lt;0-255&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Set the WAIT timer</title>
<para>
<screen>(config-if)# ip ospf dead-timer &lt;seconds&gt;</screen>
</para>
</formalpara>
</section>
<section xml:id="_network_types">
<title>network types</title>
<variablelist>
<varlistentry>
<term>Point-to-point</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>only 2 routers</simpara>
</listitem>
<listitem>
<simpara>automatic neighbor relationships</simpara>
</listitem>
<listitem>
<simpara>no DR/BDR election</simpara>
</listitem>
<listitem>
<simpara>multicast hellos</simpara>
</listitem>
<listitem>
<simpara>default for HDLC and PPP</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>broadcast</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>automatic neighbor discovery</simpara>
</listitem>
<listitem>
<simpara>DR/BDR election</simpara>
</listitem>
<listitem>
<simpara>default for ethernet, TR, FDDI</simpara>
</listitem>
<listitem>
<simpara>multicast hellos</simpara>
</listitem>
<listitem>
<simpara>DR doesn&#8217;t change the next hop of advertised prefixes</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Non-broadcast</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>unicast hellos</simpara>
</listitem>
<listitem>
<simpara>manual configuration of neighbor</simpara>
</listitem>
<listitem>
<simpara>DR/BDR election</simpara>
</listitem>
<listitem>
<simpara>default on Frame Relay, X.25 and SMDS</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Point-to-multipoint</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>multi-access, broadcast</simpara>
</listitem>
<listitem>
<simpara>automatic discovery of neighbor (MA)</simpara>
</listitem>
<listitem>
<simpara>DR/BDR election</simpara>
</listitem>
<listitem>
<simpara>one IP subnet</simpara>
</listitem>
<listitem>
<simpara>maintain connectivity during a VC failure ???</simpara>
</listitem>
<listitem>
<simpara>generates host routes (with mask /32 ) for each neighbor</simpara>
</listitem>
<listitem>
<simpara>default for ???</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Point-to-multipoint non-broadcast</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>manual configuration of neighbor</simpara>
</listitem>
<listitem>
<simpara>no DR/BDR election</simpara>
</listitem>
<listitem>
<simpara>network proprietary to Cisco</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Loopback</term>
<listitem>
<tip>
<simpara>if Multi-Access network type then no DR/BDR election
if non-broadcast, then manual configuration of neighbors</simpara>
</tip>
</listitem>
</varlistentry>
</variablelist>
<important>
<title>OSPF network type compatibilities</title>
<itemizedlist>
<listitem>
<simpara>iakfsadfj</simpara>
</listitem>
<listitem>
<simpara>adsfkjasdf</simpara>
</listitem>
<listitem>
<simpara>asdfjsadfj</simpara>
</listitem>
</itemizedlist>
</important>
</section>
<section xml:id="_graceful_restart">
<title>Graceful restart</title>
<itemizedlist>
<listitem>
<simpara>enables a router to continue to forward packets during a restart of the routing process</simpara>
</listitem>
<listitem>
<simpara>must be configured on all neighbor routers</simpara>
</listitem>
<listitem>
<simpara>can also work with EIGRP, BGP, IS-IS</simpara>
</listitem>
<listitem>
<simpara>default since IOS 12.4(6)T</simpara>
</listitem>
<listitem>
<simpara>2 versions: RFC 3623 and Cisco NSF</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_spf_throttling">
<title>SPF throttling</title>

</section>
<section xml:id="_capability_vrf_lite">
<title>capability vrf-lite</title>
<simpara>Read OSG, chapter 19, VRF lite, pp. 872-876</simpara>
</section>
<section xml:id="_summarization_3">
<title>summarization</title>
<simpara>Why the null 0 interface is added ?</simpara>
<itemizedlist>
<listitem>
<simpara>do prevent routing loops</simpara>
<itemizedlist>
<listitem>
<simpara>packets destined for the routes that have been summarized will a longer  match</simpara>
</listitem>
<listitem>
<simpara>packets destined to summary routes will be dropped</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<simpara>See good explanation</simpara>
</section>
<section xml:id="_ospf_states">
<title>OSPF states</title>
<variablelist>
<varlistentry>
<term>Down</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>No hellos have been received from neighbors</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Attempt</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Unicast hello packet has been sent to neighbor, but not yet received back</simpara>
</listitem>
<listitem>
<simpara>only used for manually configured NBMA neighbors</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Init</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>I have received a hello packet from a neighbor,
but they have not acknowledged a hello from me</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>2-way</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>I have received a hello packet from a neighbor
and he acknowledged a hello from me</simpara>
</listitem>
<listitem>
<simpara>I can see my Router Id in the neighbor&#8217;s hello packet</simpara>
</listitem>
<listitem>
<simpara>Stop here for DROthers</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Exstart</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Master &amp; slave relationship is formed where master has higher router-id</simpara>
</listitem>
<listitem>
<simpara>Master chooses the starting sequence number ofr the DBD packets that are
used for actual LSA exchange.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Exchange</term>
<listitem>
<itemizedlist>
<listitem>
</listitem>
<listitem>
<simpara>DBD sequence number is used for reliable acknowledgement/retransmission</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Loading</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>LSR packets are sent to ask for more info about a particular LSA</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Full</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Neighbors are fully adjacent and databases are synchronized.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
</section>
</section>
<section xml:id="_ospf_process">
<title>OSPF process</title>
<formalpara>
<title>Task: Enable OSPF process (legacy command )</title>
<para>
<screen>(config)# router ospf &lt;process-id&gt;
(config-router)# network &lt;a.b.c.d&gt; [&lt;w.i.l.d&gt;] area &lt;id&gt;</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>inject both the primary and secondary addresses</simpara>
</listitem>
<listitem>
<simpara>If an interface is IP unnumbered, and there is a <emphasis role="strong">network</emphasis> statement
that matches the IP address of the primary interface,
inject both the primary interface and the unnumbered interface</simpara>
</listitem>
</itemizedlist>
</note>
<formalpara>
<title>Task: Enable OSPF Process (interface level)</title>
<para>
<screen>(config-if)# ip ospf &lt;process-id&gt; area &lt;id&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Prevent OSPF to advertize secondary prefixes</title>
<para>
<screen>(config-if)# ip ospf &lt;process-id&gt; area &lt;id&gt; secondaries none</screen>
</para>
</formalpara>
<section xml:id="_ospf_authentication">
<title>OSPF authentication</title>
<itemizedlist>
<listitem>
<simpara>Null , default: type 0</simpara>
</listitem>
<listitem>
<simpara>Plain-text, simple password authentication</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# area &lt;id&gt; authentication
(config-if)# ip ospf authentication-key &lt;string&gt;</screen>
<itemizedlist>
<listitem>
<simpara>Message digest authentication</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# area &lt;id&gt; authentication message-digest
(config-if)# ip ospg message-digest-key key-id md5 &lt;string&gt;</screen>
<itemizedlist>
<listitem>
<simpara>Message digest</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_spf_timers">
<title>spf timers</title>
<itemizedlist>
<listitem>
<simpara>spf-delay: between topology change notifications and recalculation of the shortest path</simpara>
</listitem>
<listitem>
<simpara>spf-holdtime : between spf calculations</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Configure spf timers</title>
<para>
<screen>(config-router)# timers spf seconds &lt;seconds&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: configure spf throttling</title>
<para>
<screen>spf ???</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Ensure that one router performs LSA translation in a NSSA area</title>
<para>TODO</para>
</formalpara>
</section>
</section>
<section xml:id="_readings_2">
<title>readings</title>
</section>
</chapter>
<chapter xml:id="_bgp">
<title>BGP</title>
<section xml:id="_concepts_7">
<title>Concepts</title>
<itemizedlist>
<listitem>
<simpara>Exterior gateway protocol</simpara>
</listitem>
<listitem>
<simpara>Creates loop-free inter-domain routing between AS.</simpara>
</listitem>
<listitem>
<simpara>Path vector algorithm = (distance vector + AS-path loop detection)</simpara>
</listitem>
<listitem>
<simpara>TCP 179</simpara>
</listitem>
<listitem>
<simpara>AD: external 20 , internal and local 200</simpara>
</listitem>
<listitem>
<simpara>RFC 1771</simpara>
</listitem>
</itemizedlist>
<section xml:id="_autonomous_systems">
<title>Autonomous systems</title>
<itemizedlist>
<listitem>
<simpara>AS: set of routers under a single technical administration</simpara>
</listitem>
<listitem>
<simpara>AS can be:</simpara>
<itemizedlist>
<listitem>
<simpara>stub : only one exit</simpara>
</listitem>
<listitem>
<simpara>multihomed: multiple connections with the one or multiple providers</simpara>
<itemizedlist>
<listitem>
<simpara>transit: allows traffic with origin and destination outside the AS</simpara>
</listitem>
<listitem>
<simpara>non-transit:</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<section xml:id="_asn_format">
<title>ASN format</title>
<itemizedlist>
<listitem>
<simpara>2-byte (RFC 4271)</simpara>
<itemizedlist>
<listitem>
<simpara>0 - 65535</simpara>
</listitem>
<listitem>
<simpara>reserved: 0, 65535</simpara>
</listitem>
<listitem>
<simpara>public use: 1 - 64495</simpara>
</listitem>
<listitem>
<simpara>documentation: 64496-64511 (RFC 5398)</simpara>
</listitem>
<listitem>
<simpara>private use: 64512 - 65534</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>4-byte (RFC 5396)</simpara>
<itemizedlist>
<listitem>
<simpara>Asplain: decimal value notation for 2-byte and 4-byte ASNs</simpara>
</listitem>
<listitem>
<simpara>Asdot: decimal value notation for 2-byte and dot notation for 4-byte ASN</simpara>
</listitem>
<listitem>
<simpara>Documentation: 65536-65551 (RFC 5398)</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>AS 23456: reserved for gradual transition from 2-byte to 4-byte (RFC 4893)</simpara>
</listitem>
</itemizedlist>
</section>
</section>
</section>
<section xml:id="_bgp_peers">
<title>BGP peers</title>
<itemizedlist>
<listitem>
<simpara>Manually configured and not automatically discovered</simpara>
</listitem>
<listitem>
<simpara>Formed over a TCP connection</simpara>
</listitem>
<listitem>
<simpara>Exchanges PA(Path Attributes) and NLRI (IP/prefix) with the same PA</simpara>
</listitem>
<listitem>
<simpara>Starts with full BGP routing table then incremental updates</simpara>
</listitem>
<listitem>
<simpara>Keep table version number</simpara>
<variablelist>
<varlistentry>
<term>iBPG peers </term>
<listitem>
</listitem>
</varlistentry>
</variablelist>
</listitem>
<listitem>
<simpara>same AS</simpara>
</listitem>
<listitem>
<simpara>must be fully meshed within AS</simpara>
<variablelist>
<varlistentry>
<term>eBGP peers </term>
<listitem>
</listitem>
</varlistentry>
</variablelist>
</listitem>
<listitem>
<simpara>different AS</simpara>
</listitem>
<listitem>
<simpara>by default, one hop away but you can change that with <emphasis role="strong">ebgp-multihop</emphasis></simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_bgp_message_format">
<title>BGP message format</title>
<itemizedlist>
<listitem>
<simpara>Minimum size: 19 bytes</simpara>
</listitem>
<listitem>
<simpara>Maximum size: 4096 bytes (why?)</simpara>
</listitem>
</itemizedlist>
<section xml:id="_keepalive">
<title>KEEPALIVE</title>
<figure>
<title>BGP header format</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/tcp-header-format.png"/>
</imageobject>
<textobject><phrase>BGP header format</phrase></textobject>
</mediaobject>
</figure>
<itemizedlist>
<listitem>
<simpara>Marker:</simpara>
<itemizedlist>
<listitem>
<simpara>16 bytes</simpara>
</listitem>
<listitem>
<simpara>set to all 1s for OPEN message or if OPEN message without authentication</simpara>
</listitem>
<listitem>
<simpara>computed by the authentication process</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Length:</simpara>
<itemizedlist>
<listitem>
<simpara>2 bytes</simpara>
</listitem>
<listitem>
<simpara>total length in bytes of the message including the header</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Type:</simpara>
<itemizedlist>
<listitem>
<simpara>1 byte</simpara>
</listitem>
<listitem>
<simpara>indicates message type (1: Open, 2: Update, 3: Notification, 4: Keepalive)</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</section>
<section xml:id="_open">
<title>OPEN</title>
<itemizedlist>
<listitem>
<simpara>Initiates the session</simpara>
</listitem>
<listitem>
<simpara>Contains BGP version , local AS number, BGP router Id</simpara>
</listitem>
</itemizedlist>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/bgp-open.png"/>
</imageobject>
<textobject><phrase>bgp open</phrase></textobject>
</mediaobject>
</informalfigure>
<itemizedlist>
<listitem>
<simpara>Version: 1 octet</simpara>
</listitem>
<listitem>
<simpara>My autonomous system:</simpara>
</listitem>
<listitem>
<simpara>Hold time:</simpara>
<itemizedlist>
<listitem>
<simpara>maximum interval in seconds between successive Keepalive  or Update messages.</simpara>
</listitem>
<listitem>
<simpara>A receiver compares the value of the Hold Time and the value of its configured hold time
and accepts the smaller value or rejects the connection.</simpara>
</listitem>
<listitem>
<simpara>Can be set to zero to indicates that the connection is always up //find a better formulation</simpara>
</listitem>
<listitem>
<simpara>if not set to zero, the minimum recommended hold time is 3 seconds</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>BGP identifier:</simpara>
<itemizedlist>
<listitem>
<simpara>router ID</simpara>
</listitem>
<listitem>
<simpara>determined by these rules in order of preference at boot or bgp process restart:</simpara>
<itemizedlist>
<listitem>
<simpara>manually configured router id</simpara>
</listitem>
<listitem>
<simpara>highest IP address of an up/up loopback</simpara>
</listitem>
<listitem>
<simpara>highest IP address of an up/up non-loopack</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Optional parameters length:</simpara>
</listitem>
<listitem>
<simpara>total length in octects of the following Optional Parameters field</simpara>
</listitem>
<listitem>
<simpara>Optional Parameters:</simpara>
</listitem>
<listitem>
<simpara>Variable length field containing a triplet &lt;Type: 1 octet,Length: 1 octet,Value&gt;</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_keepalive_2">
<title>KEEPALIVE</title>
<itemizedlist>
<listitem>
<simpara>Every 60 seconds</simpara>
</listitem>
<listitem>
<simpara>Hold-time: 180 seconds</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_update">
<title>UPDATE</title>
<itemizedlist>
<listitem>
<simpara>Advertises a single feasible route to a peer and/or withdraws multiple unfeasible routes</simpara>
</listitem>
</itemizedlist>
<figure>
<title>header format</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/.png"/>
</imageobject>
<textobject><phrase>header format</phrase></textobject>
</mediaobject>
</figure>
<itemizedlist>
<listitem>
<simpara>Unfeasible Routes Length</simpara>
<itemizedlist>
<listitem>
<simpara>2-octet field</simpara>
</listitem>
<listitem>
<simpara>total length of the following Withdrawn Routes field, in octets.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Withdrawn Routes</simpara>
<itemizedlist>
<listitem>
<simpara>variable-length</simpara>
</listitem>
<listitem>
<simpara>lists routes to be withdrawn from service.</simpara>
</listitem>
<listitem>
<simpara>Each route in the list is described with a (Length, Prefix) tuple in which the Length is
the length of the prefix and the Prefix is the IP address prefix of the withdrawn route.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Total Path Attribute Length</simpara>
<itemizedlist>
<listitem>
<simpara>2-octet</simpara>
</listitem>
<listitem>
<simpara>total length of the following Path Attribute field, in octets.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Path Attributes</simpara>
<itemizedlist>
<listitem>
<simpara>variable-length</simpara>
</listitem>
<listitem>
<simpara>lists the attributes associated with the NLRI in the following field.
  Each path attribute is a variable-length triple of (Attribute Type, Attribute
Length, Attribute Value). The Attribute Type part of the triple is a 2-octet field consisting of
four flag bits, four unused bits, and an Attribute Type code (see <xref linkend="AttributeTypeCode"/>).</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<figure>
<title>Attribute Type part of the Path Attributes field</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/bgp-attribute.png"/>
</imageobject>
<textobject><phrase>Attribute Type part of the Path Attributes field</phrase></textobject>
</mediaobject>
</figure>
<variablelist>
<varlistentry>
<term>Flag bits (1/0)</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>O: Optional / Well-known</simpara>
</listitem>
<listitem>
<simpara>T: Transitive / Non-transitive</simpara>
</listitem>
<listitem>
<simpara>P: Partial / Complete</simpara>
</listitem>
<listitem>
<simpara>E: Extended length / Regular length ( 2-bytes/ 1-bytes)</simpara>
</listitem>
<listitem>
<simpara>U: Unused</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<table xml:id="AttributeTypeCode" frame="all" rowsep="1" colsep="1">
<title>Attribute Type Code</title>
<tgroup cols="3">
<colspec colname="col_1" colwidth="11.1111*"/>
<colspec colname="col_2" colwidth="44.4444*"/>
<colspec colname="col_3" colwidth="44.4445*"/>
<thead>
<row>
<entry align="left" valign="top">Code</entry>
<entry align="left" valign="top">Attribute</entry>
<entry align="left" valign="top">Category</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>1</simpara></entry>
<entry align="left" valign="top"><simpara>ORIGIN</simpara></entry>
<entry align="left" valign="top"><simpara>Well-known mandatory</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>2</simpara></entry>
<entry align="left" valign="top"><simpara>AS_PATH</simpara></entry>
<entry align="left" valign="top"><simpara>Well-known mandatory</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>3</simpara></entry>
<entry align="left" valign="top"><simpara>NEXT_HOP</simpara></entry>
<entry align="left" valign="top"><simpara>Well-known mandatory</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>4</simpara></entry>
<entry align="left" valign="top"><simpara>MULTI_EXIT_DISC</simpara></entry>
<entry align="left" valign="top"><simpara>Optional nontransitive</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>5</simpara></entry>
<entry align="left" valign="top"><simpara>LOCAL_REF</simpara></entry>
<entry align="left" valign="top"><simpara>Optional transitive</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>6</simpara></entry>
<entry align="left" valign="top"><simpara>ATOMIC_AGGREGATE</simpara></entry>
<entry align="left" valign="top"><simpara>Well-known discretionary</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>7</simpara></entry>
<entry align="left" valign="top"><simpara>AGGREGATOR</simpara></entry>
<entry align="left" valign="top"><simpara>Optional transitive</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>8</simpara></entry>
<entry align="left" valign="top"><simpara>COMMUNITY</simpara></entry>
<entry align="left" valign="top"><simpara>Optional transitive</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>9</simpara></entry>
<entry align="left" valign="top"><simpara>ORIGINATOR_ID</simpara></entry>
<entry align="left" valign="top"><simpara>Optional nontransitive</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>10</simpara></entry>
<entry align="left" valign="top"><simpara>CLUSTER_LIST</simpara></entry>
<entry align="left" valign="top"><simpara>Optional nontransitive</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<note>
<simpara>tasks for Internet, no-export, no-advertise, local-as</simpara>
</note>
</section>
<section xml:id="_notification">
<title>NOTIFICATION</title>
<itemizedlist>
<listitem>
<simpara>go out in response to error, fatal condition</simpara>
</listitem>
<listitem>
<simpara>torn down or reset the BGP peer session</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_bgp_fsm_states">
<title>BGP FSM States</title>
<figure>
<title>BGP neighbor negotiation finite state machines</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/diag-d6ff0ffda84c98a3d039a592e4eae223.png"/>
</imageobject>
<textobject><phrase>BGP neighbor negotiation finite state machines</phrase></textobject>
</mediaobject>
</figure>
<itemizedlist>
<listitem>
<simpara><emphasis role="strong">Idle</emphasis>  initial BGP state after enabling BGP process or resetting device.</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">Connect</emphasis> - waits for a TCP connection with the remote peer. If
successful, sends OPEN message. If not, resets the ConnectRetry timer and transitions to Active state.</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">Active</emphasis>  attempts to initiate a TCP connection with the remote
peer. If successful, sends OPEN message. If not, resets ConnectRetry timer and transitions back to Connect state</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">OpenSent</emphasis>  TCP connection up and OPEN message sent,  transition to OpenReceive state and wait for initial
keepalive to move into OpenConfirm state.
If TCP session disconnect, terminate BGP session, reset ConnectRetry timer, move back to Active State.</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">OpenConfirm</emphasis>  OPEN messages sent and received. Wait for KEEPALIVE</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">Established</emphasis>  KEEPALIVE received, neighbor parameters match. the BGP peer session is fully established. UPDATE
messages containing routing information will now be sent.</simpara>
</listitem>
<listitem>
<simpara>If peer stuck in <emphasis role="strong">Active</emphasis> state, potential problems can include:</simpara>
<itemizedlist>
<listitem>
<simpara>no IP connectivity</simpara>
</listitem>
<listitem>
<simpara>incorrect <emphasis role="strong">neighbor</emphasis> statement</simpara>
</listitem>
<listitem>
<simpara>access-list filtering TCP port 179</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</section>
<section xml:id="_bgp_session_reset">
<title>BGP session reset</title>
<itemizedlist>
<listitem>
<simpara>Whenever the routing policy changes due to a configuration change</simpara>
</listitem>
<listitem>
<simpara>Reset with <emphasis role="strong">clear ip bgp</emphasis></simpara>
</listitem>
<listitem>
<simpara>Can be hard reset, soft reset or dynamic inbound soft reset</simpara>
</listitem>
</itemizedlist>
<section xml:id="_hard_reset">
<title>Hard reset</title>
<itemizedlist>
<listitem>
<simpara>Tears down the peering sessions including the TCP connections</simpara>
</listitem>
<listitem>
<simpara>Deletes prefixes learned from the peers.</simpara>
</listitem>
<listitem>
<simpara>Pros: no memory overhead</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_soft_reset">
<title>Soft reset</title>
<itemizedlist>
<listitem>
<simpara>Stores prefix information</simpara>
</listitem>
<listitem>
<simpara>Do not tearn down existing peering sessions</simpara>
</listitem>
<listitem>
<simpara>Can be configured for inbound or outbound sessions</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_dynamic_inbound_soft_reset">
<title>Dynamic inbound soft reset</title>
<itemizedlist>
<listitem>
<simpara>Do not store update information locally</simpara>
</listitem>
<listitem>
<simpara>Relies on dynamic exchanges with supporting peers</simpara>
</listitem>
<listitem>
<simpara>The peers supports the capability if  <emphasis role="strong">show ip bgp neighbors</emphasis> displays
<emphasis>Received route refresh capability from peer</emphasis> .</simpara>
</listitem>
<listitem>
<simpara>Use <emphasis role="strong">bgp soft-reconfig-backup</emphasis> to store updates for peers who do not support the refresh route capability</simpara>
</listitem>
</itemizedlist>
</section>
</section>
<section xml:id="_bgp_route_aggregation">
<title>BGP route aggregation</title>
<itemizedlist>
<listitem>
<simpara>2 methods</simpara>
<itemizedlist>
<listitem>
<simpara>basic route redistribution: creates an aggregate route, then redistributes the routes in BGP</simpara>
</listitem>
<listitem>
<simpara>conditional aggregation: creates an aggregate route , then advertises or not certain routes
based on route maps, AS-SET, or summary information</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara><emphasis role="strong">bgp suppress-inactive</emphasis> stops BGP to advertise inactive routes (not installed
into the RIB) to any peer.</simpara>
</listitem>
</itemizedlist>
<section xml:id="_bgp_route_aggregation_generating_as_set_information">
<title>BGP route aggregation generating AS_SET information</title>
<simpara>#TODO: improve this part</simpara>
<simpara>AS_SET information can be generated when BGP routes are aggregated using the
aggregate-address command. The path advertised for such a route is an AS_SET
consisting of all the elements, including the communities, contained in all the
paths that are being summarized. If the AS_PATHs to be aggregated are
identical, only the AS_PATH is advertised. The ATOMIC-AGGREGATE attribute, set
by default for the aggregate-address command, is not added to the AS_SET.</simpara>
</section>
</section>
<section xml:id="_routing_policy_change_management">
<title>Routing policy change management</title>
<simpara>TODO: add this part under bgp reset</simpara>
</section>
<section xml:id="_bgp_peer_groups">
<title>BGP peer groups</title>
<itemizedlist>
<listitem>
<simpara>Group of peers with the same update policies ( outbound route maps, distribute lists, filter lists, update source ,)</simpara>
</listitem>
<listitem>
<simpara>Benefits:</simpara>
<itemizedlist>
<listitem>
<simpara>simplify configuration</simpara>
</listitem>
<listitem>
<simpara>make configuration updates more efficient</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Restrictions for eBGP peers:</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_bgp_backdoor_routes">
<title>BGP backdoor routes</title>
<itemizedlist>
<listitem>
<simpara>Use <emphasis role="strong">network backdoor</emphasis> to cause BGP to prefer EIGRP</simpara>
</listitem>
</itemizedlist>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/bgp-backdoor-route-topology.png"/>
</imageobject>
<textobject><phrase>bgp backdoor route topology</phrase></textobject>
</mediaobject>
</informalfigure>
</section>
<section xml:id="_best_path_selection_algorithm">
<title>Best path selection algorithm</title>
<orderedlist numeration="arabic">
<listitem>
<simpara>highest weight</simpara>
</listitem>
<listitem>
<simpara>highest local pref</simpara>
</listitem>
<listitem>
<simpara>locally originated paths over externally originated paths</simpara>
</listitem>
<listitem>
<simpara>shortest AS path</simpara>
</listitem>
<listitem>
<simpara>lowest origin type ( internal over external over incomplete)</simpara>
</listitem>
<listitem>
<simpara>lowest MED</simpara>
</listitem>
<listitem>
<simpara>eBGP paths over iBGP paths</simpara>
</listitem>
<listitem>
<simpara>lowest IGP cost</simpara>
</listitem>
<listitem>
<simpara>oldest path</simpara>
</listitem>
<listitem>
<simpara>lowest BGP router id</simpara>
</listitem>
</orderedlist>
<tip>
<simpara>We Love Oranges AS Oranges Mean Pure Refreshment.
W Weight (Highest) L Local_Pref (Highest) O Originate (local originate) AS
As_Path (shortest) O Origin Code (IGP &lt; EGP &lt; Incomplete) M MED (lowest) P
Paths (External Paths preferred Over Internal) R Router ID (lowest)</simpara>
</tip>
</section>
<section xml:id="_community_attributes">
<title>community attributes</title>
<itemizedlist>
<listitem>
<simpara>No-advertise: prevents advertisements to any BGP peer</simpara>
</listitem>
<listitem>
<simpara>No-export: prevents advertisements to any eBGP peer</simpara>
</listitem>
<listitem>
<simpara>No-advertise: prevents advertisements outside the AS, or in confederation scenarios, outside the sub-AS</simpara>
</listitem>
<listitem>
<simpara>Internet:  advertises routes to any route</simpara>
</listitem>
</itemizedlist>
</section>
</section>
<section xml:id="_configuration_tasks_6">
<title>Configuration tasks</title>
<section xml:id="_configuring_a_bgp_routing_process">
<title>Configuring a BGP Routing Process</title>
<itemizedlist>
<listitem>
<simpara>Configure a bgp routing process</simpara>
</listitem>
</itemizedlist>
<screen>router bgp &lt;asn&gt;</screen>
<itemizedlist>
<listitem>
<simpara>Specify a network as  local to the BGP routing table</simpara>
</listitem>
</itemizedlist>
<screen>network &lt;prefix&gt; [mask  &lt;a.b.c.d&gt;] [route-map &lt;name&gt;]</screen>
<itemizedlist>
<listitem>
<simpara>Configure the bgp router id</simpara>
</listitem>
</itemizedlist>
<screen>bgp router-id &lt;ip-address&gt;</screen>
<itemizedlist>
<listitem>
<simpara>Set the bgp network timers</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# timers bgp &lt;keepalive-seconds&gt; &lt;holdtime-seconds&gt;</screen>
</section>
<section xml:id="_configuring_a_bgp_peer">
<title>Configuring a BGP Peer</title>
<screen>neighbor &lt;ip-address&gt; remote-as &lt;asn&gt;</screen>
<itemizedlist>
<listitem>
<simpara>Specify the IPv4 address family</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# address-family ipv4 [unicast | multicast | vrf &lt;name&gt;]</screen>
<itemizedlist>
<listitem>
<simpara>Enable the neighbor to exchange prefixes for the ipv4 unicast address family with the local device</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# neighbor &lt;ip-address&gt; activate</screen>
</section>
<section xml:id="_configuring_a_bgp_peer_for_the_ipv4_vrf_address_family">
<title>Configuring a BGP Peer for the IPv4 VRF Address Family</title>
<itemizedlist>
<listitem>
<simpara>Associate a vpn vrf instance with an interface</simpara>
</listitem>
</itemizedlist>
<screen>(config-if)# interface &lt;type&gt; &lt;number&gt;
(config-if)# vrf forwarding &lt;name&gt;
(config-if)# ip address &lt;prefix&gt; &lt;mask&gt; [secondary [vrf &lt;name&gt;]]</screen>
<itemizedlist>
<listitem>
<simpara>Configure a VRF routing table with the same name assigned to the VRF
and enters the VRF configuration mode</simpara>
</listitem>
</itemizedlist>
<screen>(config)# ip vrf &lt;name&gt;</screen>
<itemizedlist>
<listitem>
<simpara>Create routing and forwarding tables and specify the default route distinguisher for a vpn</simpara>
</listitem>
</itemizedlist>
<screen>(config-vrf)# rd &lt;route-distinguisher&gt;</screen>
<itemizedlist>
<listitem>
<simpara>Create a route target extended community for a VRF</simpara>
</listitem>
</itemizedlist>
<screen>(config-vrf)# route-target [import | export | both] &lt;community&gt;</screen>
</section>
<section xml:id="_customizing_a_bgp_peer">
<title>Customizing a BGP Peer</title>
<itemizedlist>
<listitem>
<simpara>Disable the IPv4 unicast address family for the BGP routing process</simpara>
</listitem>
</itemizedlist>
<screen>no bgp default ipv4-unicast</screen>
<itemizedlist>
<listitem>
<simpara>Add a neighbor</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# neighbor &lt;ip-address&gt; remote-as &lt;asn&gt;</screen>
<itemizedlist>
<listitem>
<simpara>Add a text description with a specified neighbor</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# neighbor &lt;ip-address&gt; description &lt;text&gt;</screen>
<itemizedlist>
<listitem>
<simpara>Add a text description with a specified peer group</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# neighbor &lt;peer-group-name&gt; description &lt;text&gt;</screen>
<itemizedlist>
<listitem>
<simpara>Exit address family configuration mode</simpara>
</listitem>
</itemizedlist>
<screen>(config-router-af)# exit-address-family</screen>
<itemizedlist>
<listitem>
<simpara>Disable a BGP peer or peer group</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# neighbor &lt;ip-address&gt; shutdown</screen>
</section>
<section xml:id="_monitoring_and_maintaining_basic_bgp">
<title>Monitoring and Maintaining Basic BGP</title>
<itemizedlist>
<listitem>
<simpara>Enable logging of BGP neighbor resets</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# bgp log-neighbor-changes</screen>
<itemizedlist>
<listitem>
<simpara>Configure a BGP speaker to perform inbound soft reconfiguration
for peers that do not support the route refresh capability.</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# bgp soft-reconfig-backup</screen>
<itemizedlist>
<listitem>
<simpara>Start storing updates for each neighbor that do not support route refresh</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# neighbor &lt;ip-address|peer-group-name&gt; soft-reconfiguration [inbound]</screen>
<note>
<itemizedlist>
<listitem>
<simpara>All the updates received from this neighbor will be stored unmodified,
regardless of the inbound policy. When inbound soft reconfiguration is done
later, the stored information will be used to generate a new set of inbound
updates.</simpara>
</listitem>
<listitem>
<simpara>Memory requirements can increased.</simpara>
</listitem>
</itemizedlist>
</note>
<itemizedlist>
<listitem>
<simpara>Apply a route map to incoming or outgoing routes</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# neighbor &lt;ip-address|peer-group-name&gt; route-map &lt;name&gt; [in | out]</screen>
</section>
<section xml:id="_aggregating_route_prefixes_using_bgp">
<title>Aggregating Route Prefixes Using BGP</title>
<itemizedlist>
<listitem>
<simpara>Redistribute static routes into the BGP routing table</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# redistribute static</screen>
<itemizedlist>
<listitem>
<simpara>Create an aggregate entry in a BGP routing table</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# aggregate-address &lt;prefix&gt; &lt;mask&gt; [as-set]</screen>
<itemizedlist>
<listitem>
<simpara>Create an aggregate route and suppress advertisements of more-specific routes to all peers</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# aggregate-address &lt;prefix&gt; &lt;mask&gt; [summary-only]</screen>
<itemizedlist>
<listitem>
<simpara>Create an aggregate route but suppress advertisement of specified routes</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# aggregate-address &lt;prefix&gt; &lt;mask&gt; [suppress-map &lt;map-name&gt;]</screen>
<itemizedlist>
<listitem>
<simpara>Selectively advertises routes previously suppressed by the <emphasis role="strong">aggregate-address</emphasis> command</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# neighbor &lt;ip-address | peer-group-name&gt; unsuppress-map &lt;map-name&gt;</screen>
<itemizedlist>
<listitem>
<simpara>Conditionally advertise BGP routes</simpara>
</listitem>
</itemizedlist>
<simpara>The routes or prefixes that will be conditionally advertised are defined in two
route maps: an advertise map and either an exist map or nonexist map. The route
map associated with the exist map or nonexist map specifies the prefix that the
BGP speaker will track. The route map associated with the advertise map
specifies the prefix that will be advertised to the specified neighbor when the
condition is met.</simpara>
<itemizedlist>
<listitem>
<simpara>If a prefix is found to be present in the exist map by the BGP speaker, the
prefix specified by the advertise map is advertised.</simpara>
</listitem>
<listitem>
<simpara>If a prefix is found not to be present in the nonexist map by the BGP
speaker, the prefix specified by the advertise map is advertised.</simpara>
</listitem>
<listitem>
<simpara>If the condition is not met, the route is withdrawn and conditional
advertisement does not occur. All routes that may be dynamically advertised
or not advertised must exist in the BGP routing table in order for
conditional advertisement to occur. These routes are referenced from an
access list or an IP prefix list.</simpara>
</listitem>
<listitem>
<simpara>Advertise selectively some BGP routes to neighbor</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# neighbor &lt;ip-address&gt; advertise-map &lt;name-1&gt; { exist-map &lt;name&gt; | non-exist-map &lt;name&gt;}</screen>
<itemizedlist>
<listitem>
<simpara>Inject more specific prefixes into a BGP routing table over less specific prefixes</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# bgp inject-map &lt;name&gt; exist-map &lt;name&gt; [copy-attributes]</screen>
</section>
<section xml:id="_originating_bgp_routes">
<title>Originating BGP Routes</title>
<itemizedlist>
<listitem>
<simpara>Advertise a default route to BGP peers</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# neighbor &lt;ip-address&gt; default-originate  [route-map &lt;name&gt;]</screen>
<itemizedlist>
<listitem>
<simpara>Indicate a network reachable through a backdoor route</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# network &lt;ip-address&gt; backdoor</screen>
<tip>
<simpara>BGP only advertize networks in the RIB</simpara>
</tip>
</section>
<section xml:id="_configuring_a_bgp_peer_group">
<title>Configuring a BGP Peer Group</title>
<itemizedlist>
<listitem>
<simpara>Create a BGP peer group</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# neighbor &lt;peer-group-name&gt; peer-group</screen>
<itemizedlist>
<listitem>
<simpara>Assign a neighbor to a peer group</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# neighbor &lt;ip-address&gt; peer-group &lt;name&gt;</screen>
</section>
<section xml:id="_modify_the_default_output_and_regex_match_format_for_4_byte_asn">
<title>Modify the default output and regex match format for 4-byte ASN</title>
<screen>(config-router)# bgp asnotation dot</screen>
</section>
<section xml:id="_suppress_inactive_route_advertisement_using_bgp">
<title>Suppress inactive route advertisement using BGP</title>
<itemizedlist>
<listitem>
<simpara>Suppress inactive route advertisement</simpara>
</listitem>
</itemizedlist>
<screen>(config-router-af)# bgp suppress-inactive</screen>
</section>
<section xml:id="_configure_basic_peer_session_template">
<title>Configure basic peer session template</title>
<itemizedlist>
<listitem>
<simpara>Create a peer session template</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# template peer-session &lt;name&gt;</screen>
<itemizedlist>
<listitem>
<simpara>Inherit the configuration of another peer session template</simpara>
</listitem>
</itemizedlist>
<screen>(config-router-stmp)# inherit peer-session &lt;template-name&gt;</screen>
<itemizedlist>
<listitem>
<simpara>Send a peer session template to a neighbor so that the neighbor can inherit the configuration</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# neighbor &lt;ip-address&gt; inherit peer-session &lt;template-name&gt;</screen>
</section>
<section xml:id="_configure_basic_peer_policy_template">
<title>configure basic peer policy template</title>
<itemizedlist>
<listitem>
<simpara>Create a peer policy template</simpara>
</listitem>
</itemizedlist>
<screen>(config-router)# template peer-policy &lt;name&gt;</screen>
<itemizedlist>
<listitem>
<simpara>Configure the maximum number of prefixes that a neighbor will accept from this peer</simpara>
</listitem>
</itemizedlist>
<screen>(config-router-ptmp)# maximum-prefix &lt;limit&gt; [&lt;threshold&gt;] [restart &lt;interval&gt; | warning-only]</screen>
<itemizedlist mark="NOTE">
<listitem>
<simpara>A peer policy template can directly or indirectly inherit up to 8 peer
policy templates.</simpara>
</listitem>
<listitem>
<simpara>A BGP neighbor cannot be configured to work with both peer groups and peer
templates. A BGP neighbor can be configured to belong only to a peer group or
to inherit policies only from peer templates.</simpara>
</listitem>
</itemizedlist>
</section>
</section>
<section xml:id="_verify_3">
<title>Verify</title>
<itemizedlist>
<listitem>
<simpara>Display the entries in the bgp routing table</simpara>
</listitem>
</itemizedlist>
<screen>show ip bgp [prefix] [mask]</screen>
<itemizedlist>
<listitem>
<simpara>Display info about the TCP and BGP connection to neighbors</simpara>
</listitem>
</itemizedlist>
<screen>#  show ip bgp neigbors &lt;ip-address&gt;</screen>
<itemizedlist>
<listitem>
<simpara>Verify that the VRF instance has been created</simpara>
</listitem>
</itemizedlist>
<screen># show ip vrf</screen>
<itemizedlist>
<listitem>
<simpara>Display information about all the BGP paths in the database</simpara>
</listitem>
</itemizedlist>
<screen># show ip bgp paths</screen>
<itemizedlist>
<listitem>
<simpara>Display the status of all BGP connections</simpara>
</listitem>
</itemizedlist>
<screen># show ip bgp summary</screen>
<itemizedlist>
<listitem>
<simpara>Display IPv4 multicast database-related information</simpara>
</listitem>
</itemizedlist>
<screen>show ip bgp ipv4 multicast &lt;command&gt;</screen>
<itemizedlist>
<listitem>
<simpara>Display injected paths</simpara>
</listitem>
</itemizedlist>
<screen># show ip bgp injected-paths

BGP table version is 11, local router ID is 10.0.0.1
Status codes:s suppressed, d damped, h history, * valid, &gt; best, i -
internal
Origin codes:i - IGP, e - EGP, ? - incomplete
   Network          Next Hop            Metric LocPrf Weight Path
*&gt; 172.16.0.0       10.0.0.2                               0 ?
*&gt; 172.17.0.0/16    10.0.0.2                               0 ?</screen>
<itemizedlist>
<listitem>
<simpara>Display update replication stats for BGP update groups</simpara>
</listitem>
</itemizedlist>
<screen># show ip bgp replication [&lt;index-group&gt; | &lt;ip-address&gt;] [summary]</screen>
<itemizedlist>
<listitem>
<simpara>Display BGP routes that are not installed in the RIB</simpara>
</listitem>
</itemizedlist>
<screen># show ip bgp rib-failure

Network            Next Hop                      RIB-failure   RIB-NH Matches
10.1.15.0/24       10.1.35.5           Higher admin distance              n/a
10.1.16.0/24       10.1.15.1           Higher admin distance              n/a</screen>
<itemizedlist>
<listitem>
<simpara>Display locally configured peer session template</simpara>
</listitem>
</itemizedlist>
<screen>show ip bgp template peer-session</screen>
</section>
<section xml:id="_troubleshoot_3">
<title>Troubleshoot</title>
<itemizedlist>
<listitem>
<simpara>Verify basic network connectivity between BGP devices</simpara>
</listitem>
</itemizedlist>
<screen>ping vrf</screen>
<itemizedlist>
<listitem>
<simpara>Clear and reset BGP neighbor sessions</simpara>
</listitem>
</itemizedlist>
<screen># clear ip bgp *</screen>
<itemizedlist>
<listitem>
<simpara>Clear BGP update group membership and recalcultar BGP update groups</simpara>
</listitem>
</itemizedlist>
<screen># clear ip bgp update-group [ &lt;index-group&gt; | &lt;ip-address&gt; ]</screen>
<itemizedlist>
<listitem>
<simpara>Display info about the processing of BGP update groups.</simpara>
</listitem>
</itemizedlist>
<screen># debug ip bgp groups</screen>
</section>
<section xml:id="_todos">
<title>todos</title>
<itemizedlist>
<listitem>
<simpara>Concept: bgp route aggregation generating AS_SET information</simpara>
</listitem>
<listitem>
<simpara>Multiprotocol bgp concepts</simpara>
</listitem>
<listitem>
<simpara>Multiprotocol bgp extensions for IP multicast concepts</simpara>
</listitem>
<listitem>
<simpara>AFI bgp address family identifier model : ipv4, ipv6,clns, vpnv4</simpara>
</listitem>
</itemizedlist>
</section>
</chapter>
<chapter xml:id="_redistribution">
<title>Redistribution</title>
<itemizedlist>
<listitem>
<simpara>Redistribution occurs from the routing table not the routing database</simpara>
</listitem>
<listitem>
<simpara>When redistributing protocol X into Y, take &#8230;&#8203;</simpara>
<itemizedlist>
<listitem>
<simpara>routes in the RIB via protocol X</simpara>
</listitem>
<listitem>
<simpara>connected interfaces running protocol X</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>choose</simpara>
<itemizedlist>
<listitem>
<simpara>routes with lower AD</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<section xml:id="_administrative_distance">
<title>Administrative distance</title>
<informaltable frame="all" rowsep="1" colsep="1">
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top">Route source</entry>
<entry align="left" valign="top">Distance</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Connected route</simpara></entry>
<entry align="left" valign="top"><simpara>0</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Static route</simpara></entry>
<entry align="left" valign="top"><simpara>1</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>summary EIGRP</simpara></entry>
<entry align="left" valign="top"><simpara>5</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>eBGP</simpara></entry>
<entry align="left" valign="top"><simpara>20</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>internal EIGRP</simpara></entry>
<entry align="left" valign="top"><simpara>90</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>IGRP</simpara></entry>
<entry align="left" valign="top"><simpara>100</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>OSPF</simpara></entry>
<entry align="left" valign="top"><simpara>110</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>IS-IS</simpara></entry>
<entry align="left" valign="top"><simpara>115</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>RIP</simpara></entry>
<entry align="left" valign="top"><simpara>120</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>ODR</simpara></entry>
<entry align="left" valign="top"><simpara>160</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>External EIGRP</simpara></entry>
<entry align="left" valign="top"><simpara>170</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>iBGP</simpara></entry>
<entry align="left" valign="top"><simpara>200</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Unknown</simpara></entry>
<entry align="left" valign="top"><simpara>255</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
<section xml:id="_spot_issues">
<title>Spot issues</title>
<itemizedlist>
<listitem>
<simpara>Loops cannot occur with one single point of redistribution</simpara>
</listitem>
<listitem>
<simpara>Loops may occur with multiple points of redistribution</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_heuristics">
<title>heuristics</title>
<itemizedlist>
<listitem>
<simpara>identify each domain and associate a tag</simpara>
</listitem>
<listitem>
<simpara>assign tags to each domain</simpara>
</listitem>
</itemizedlist>
<screen>  route-map ospf2eigrp permit
    set tag 123</screen>
<itemizedlist>
<listitem>
<simpara>deny tag on re-entry</simpara>
<itemizedlist>
<listitem>
<simpara>always block routes to be re-enter the domain</simpara>
</listitem>
<listitem>
<simpara>optionaly: block routes as per scenario requirement</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<screen>  ! block own routes
  route-map ospf2eigrp deny 10
    match tag 456
  ! block some routes if requested
  route-map deny 20
    match tag 78</screen>
<itemizedlist>
<listitem>
<simpara>all tags to pass through transit domains without re-tagging them</simpara>
</listitem>
</itemizedlist>
<screen>! identify the transit tags without tagging
route-map ospf2eigrp permit 60
  match tag 234</screen>
<itemizedlist>
<listitem>
<simpara>Use BGP community instead of tags for BGP</simpara>
</listitem>
</itemizedlist>
<screen>route-map ospf2bgp permit 70
  set community 110</screen>
<screen>ip community-list 1 permit 10
  match community 1
  set tag 110</screen>
</section>
<section xml:id="_connected_routes">
<title>Connected routes</title>
<formalpara>
<title>Task: redistribute connected routes</title>
<para>
<screen>redistribute connected</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>OVerride the implicit redistribution of interfaces running the protocol X</simpara>
</listitem>
</itemizedlist>
</note>
</section>
<section xml:id="_static_routes">
<title>Static routes</title>
<formalpara>
<title>Task: redistribute static route</title>
<para>
<screen>(config-router)# redistribute static route-map &lt;name&gt; metric &lt;value&gt;
(config-router)# default-metric &lt;hops&gt;</screen>
</para>
</formalpara>
</section>
<section xml:id="_rip_2">
<title>RIP</title>
<itemizedlist>
<listitem>
<simpara>doesn&#8217;t differentiate between internal and external routes</simpara>
</listitem>
<listitem>
<simpara>no default seed metric</simpara>
<itemizedlist>
<listitem>
<simpara>recommendation: use  1 as default-metric</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Prevent loss of packet when BGP routes are redistributed in RIP</title>
<para>
<screen>(config)# router rip
(config-router)# input-queue 1024</screen>
</para>
</formalpara>
</section>
<section xml:id="_eigrp_2">
<title>EIGRP</title>
<screen>redistribute &lt;protocol&gt; metric &lt;bandwidth&gt; &lt;delay&gt; &lt;load&gt; &lt;reliability&gt; &lt;MTU&gt;</screen>
<itemizedlist>
<listitem>
<simpara>internal routes AD &lt; external routes</simpara>
</listitem>
<listitem>
<simpara>uses router-id for loop prevention</simpara>
</listitem>
<listitem>
<simpara>no default seed metric unless EIGRP to EIGRP</simpara>
<itemizedlist>
<listitem>
<simpara>default-metric &lt;bandwidth&gt; &lt;delay&gt; &lt;load&gt; &lt;reliability&gt; &lt;MTU&gt;</simpara>
</listitem>
<listitem>
<simpara>default-metric 10000 100 1 255 1500</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<tip>
<simpara>Duplicate router-ids will prevent EIGRP to install routes</simpara>
</tip>
</section>
<section xml:id="_ospf_redistribution">
<title>OSPF redistribution</title>
<itemizedlist>
<listitem>
<simpara>differentiates between internal and external routes but same AD= 110</simpara>
</listitem>
<listitem>
<simpara>Router-id for flooding loop prevention</simpara>
</listitem>
<listitem>
<simpara>Use <emphasis role="strong">subnets</emphasis> keyword</simpara>
</listitem>
<listitem>
<simpara>default metric is 1 for BGP and 20 for other IGP</simpara>
</listitem>
<listitem>
<simpara>default metric-type E2/N2</simpara>
</listitem>
<listitem>
<simpara>OSPF path selection
TODO: improve this part</simpara>
<itemizedlist>
<listitem>
<simpara>E1 &gt; E2 &gt; N1 &gt; N2</simpara>
</listitem>
<listitem>
<simpara>E1 &amp; N1 vs E2 &amp; N2 metrics</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<screen>router ospf 1
  redistribute rip
  redistribute eigrp
  default-metric 10</screen>
<formalpara>
<title>Task: Assign different AD to internal and external</title>
<para>
<screen></screen>
</para>
</formalpara>
</section>
<section xml:id="_bgp_redistribution">
<title>BGP redistribution</title>
<section xml:id="_igp_to_bgp">
<title>IGP to BGP</title>
<itemizedlist>
<listitem>
<simpara>denies OSPF external routes by default</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: redistribute OSPF into BGP</title>
<para>
<screen>redistribute ospf &lt;pid&gt; match internal external</screen>
</para>
</formalpara>
</section>
<section xml:id="_bgp_to_igp">
<title>BGP to IGP</title>
<itemizedlist>
<listitem>
<simpara>iBGP routes denied by default, eBGP routes win</simpara>
</listitem>
</itemizedlist>
</section>
</section>
</chapter>
</part>
<part xml:id="_vpn_technologies">
<title>VPN Technologies</title>
<chapter xml:id="_mpls">
<title>MPLS</title>
<section xml:id="_concepts_8">
<title>Concepts</title>
<itemizedlist>
<listitem>
<simpara>mpls vpn</simpara>
<itemizedlist>
<listitem>
<simpara>ce : no mpls-aware</simpara>
</listitem>
<listitem>
<simpara>pe : mpls and vpn aware</simpara>
</listitem>
<listitem>
<simpara>p : no vpn aware</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<section xml:id="_mpls_label_stack">
<title>MPLS label stack</title>
<figure>
<title>MPLS header format</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/mpls-header-format.png"/>
</imageobject>
<textobject><phrase>MPLS header format</phrase></textobject>
</mediaobject>
</figure>
<variablelist>
<varlistentry>
<term>Label</term>
<listitem>
<simpara>Locally significant to the router</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>EXP</term>
<listitem>
<simpara>Experimental, class of service</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>S</term>
<listitem>
<simpara>Bottom-of-Stack flag</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>TTL</term>
<listitem>
<simpara>Time to live</simpara>
</listitem>
</varlistentry>
</variablelist>
</section>
<section xml:id="_label_distribution">
<title>label distribution</title>
<itemizedlist>
<listitem>
<simpara>protocol : ldp (default rfc 3036) or tdp (cisco)</simpara>
</listitem>
</itemizedlist>
<section xml:id="_dynamic_discovery_of_adjacent_ldp_peers">
<title>dynamic discovery of adjacent ldp peers</title>
<itemizedlist>
<listitem>
<simpara>neigbhbor discovery UDP port 646</simpara>
<itemizedlist>
<listitem>
<simpara>basic neighbor discovery: multicast hellos to directly connected neighbors</simpara>
</listitem>
<listitem>
<simpara>extended neighbor discovery: unicast hellos to non-directly connected neighbors</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<screen>R1#sh mpls ldp neighbor
  Peer LDP Ident: 192.1.5.5:0; Local LDP Ident 192.1.1.1:0
    TCP connection: 192.1.5.5.21288 - 192.1.1.1.646
    State: Oper; Msgs sent/rcvd: 10/11; Downstream
    Up time: 00:04:24
    LDP discovery sources:
      FastEthernet0/0, Src IP addr: 172.16.15.5
    Addresses bound to peer LDP Ident:
    172.16.15.5 192.1.5.5</screen>
<itemizedlist>
<listitem>
<simpara>timers: hello interval (5 seconds) and holdtime (15 seconds)</simpara>
</listitem>
</itemizedlist>
<screen>(config)# mpls ldp discovery hello interval &lt;sec&gt;
(config)# mpls ldp discovery hello holdtime &lt;sec&gt;</screen>
</section>
<section xml:id="_peering_establishment">
<title>peering establishment</title>
<simpara>in 2 steps:</simpara>
<itemizedlist>
<listitem>
<simpara>transport connection: if the 2 peers have never established a tcp session, create a new session with a client (active device, highest ip address)
using a random port and the server (lowest ip addr) listening on the TCP 646 port.</simpara>
</listitem>
</itemizedlist>
<screen>R1#show tcp brief (state)
TCB        Local_Address   Foreign_Address
498D80D8   192.1.1.1.646   192.1.5.5.21288   ESTAB</screen>
<itemizedlist>
<listitem>
<simpara>session establishment:</simpara>
<itemizedlist>
<listitem>
<simpara>negotiates ldp protocol version, label exchange method, timers</simpara>
</listitem>
<listitem>
<simpara>if incompatibility, sends error negotiation messages and restart the negotiation
with initial backoff value (15 seconds) and maximum backoff value (120 seconds)</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<screen>R1#show mpls ldp parameters
  Protocol version: 1
  Session hold time: 180 sec; keep alive interval: 60 sec
  Discovery hello: holdtime: 15 sec; interval: 5 sec
  Discovery targeted hello: holdtime: 90 sec; interval: 10 sec
  Downstream on Demand max hop count: 255
  Downstream on Demand Path Vector Limit: 255
  LDP for targeted sessions
  LDP initial/maximum backoff: 15/120 sec
  LDP loop detection: off</screen>
</section>
</section>
<section xml:id="_regulation_of_peer_to_peer_communication_and_label_exchange">
<title>regulation of peer-to-peer communication and label exchange</title>
<itemizedlist>
<listitem>
<simpara>with keepalives (60 seconds)</simpara>
</listitem>
</itemizedlist>
<screen>(config)# mpls ldp holdtime &lt;sec&gt;
%Previously established sessions may not use the new holdtime.</screen>
<itemizedlist>
<listitem>
<simpara>keepalive timer is reset every time ldp packets or keepalive are received</simpara>
</listitem>
<listitem>
<simpara>keepalive are automatically adjusted to 1/3 of the configured holdtime</simpara>
</listitem>
<listitem>
<simpara>you need to reset the tcp session for new timers to take effect</simpara>
</listitem>
</itemizedlist>
</section>
</section>
<section xml:id="_label_distribution_and_control">
<title>label distribution and control</title>
<itemizedlist>
<listitem>
<simpara>methods:</simpara>
<itemizedlist>
<listitem>
<simpara>Unsolicited downstream distribution mode</simpara>
</listitem>
<listitem>
<simpara>solicited downstream distribution mode</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<simpara>(to be revised )</simpara>
<section xml:id="_route_distinguishers_and_route_targets">
<title>Route distinguishers and route targets</title>
<simpara>RD is added to prefix when BGP vpnv4 advertised NLRI.
  - only one per NLRI
RT is Path attribute of the NLRI
  - 1 or + for each RD/prefix
  - useful in overlapping VPNs or central service VPN offered by SP</simpara>
</section>
</section>
<section xml:id="_commands">
<title>Commands</title>
<screen>show mpls forwarding-table</screen>
</section>
</chapter>
<chapter xml:id="_gre_3">
<title>GRE</title>
<section xml:id="_concepts_9">
<title>Concepts</title>
<section xml:id="_tunneling_2">
<title>Tunneling</title>
<itemizedlist>
<listitem>
<simpara>Tunneling encapsulates data packets from one protocol inside a different
protocol and transports the data packets unchanged across a foreign network.
Unlike encapsulation, tunneling allows a lower-layer protocol, or same-layer
protocol, to be carried through the tunnel.</simpara>
</listitem>
</itemizedlist>
<simpara>Components:</simpara>
<itemizedlist>
<listitem>
<simpara><emphasis role="strong">Passenger protocol</emphasis> : The protocol that you are encapsulating. Examples: AppleTalk, IP, IPX.</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">Carrier protocol</emphasis> : The protocol that does the encapsulating. Examples: GRE, IP-in-IP, L2TP,MPLS, STUN,DLSw+.</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">Transport protocol</emphasis> : The protocol used to carry the encapsulated protocol. The main transport protocol is IP.</simpara>
</listitem>
</itemizedlist>
<figure>
<title>IP Tunneling Terminology and Concepts</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/ip-tunneling-concepts.png"/>
</imageobject>
<textobject><phrase>ip tunneling concepts</phrase></textobject>
</mediaobject>
</figure>
</section>
<section xml:id="_gre_4">
<title>GRE</title>
<itemizedlist>
<listitem>
<simpara>IP protocol 47</simpara>
</listitem>
<listitem>
</listitem>
<listitem>
</listitem>
<listitem>
</listitem>
</itemizedlist>
<section xml:id="_gre_header_2">
<title>GRE header</title>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/gre-header-format.png.png"/>
</imageobject>
<textobject><phrase>gre header format.png</phrase></textobject>
</mediaobject>
</informalfigure>
<variablelist>
<varlistentry>
<term>Checksum present</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>bit 0</simpara>
</listitem>
<listitem>
<simpara>indicates that the checksum and the Reserved1 field are present</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Reserved0</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>12 bits</simpara>
</listitem>
<listitem>
<simpara>if any of bits 1-5 are non-zero, a receiver must discard the packet
unless receiver implements RFC1701</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
</section>
<section xml:id="_gre_keepalive_2">
<title>GRE keepalive</title>
<simpara>The GRE tunnel keepalive mechanism gives the ability for one side to originate
and receive keepalive packets to and from a remote router even if the remote
router does not support GRE keepalives. For GRE keepalives, the sender
pre-builds the keepalive response packet inside the original keepalive request
packet so that the remote end only needs to do standard GRE decapsulation of
the outer GRE IP header and then forward the inner IP GRE packet. GRE tunnel
keepalives timers on each side are independent and do not have to match. The
problem with the configuration of keepalives only on one side of the tunnel is
that only the router that has keepalives configured marks its tunnel interface
as down if the keepalive timer expires. The GRE tunnel interface on the other
side, where keepalives are not configured, remains up even if the other side of
the tunnel is down. The tunnel can become a black-hole for packets directed
into the tunnel from the side that did not have keepalives configured.</simpara>
</section>
</section>
</section>
<section xml:id="_configuration_8">
<title>Configuration</title>
<section xml:id="_configure_a_gre_tunnel_2">
<title>Configure a GRE tunnel</title>
<simpara>To build a tunnel, a tunnel interface must be defined on each of two routers
and the tunnel interfaces must reference each other.
At each router, the tunnel interface must be configured with a L3 address.
The tunnel endpoints, tunnel source, and tunnel destination must be defined,
and the type of tunnel must be selected.</simpara>
<simpara>Optional steps can be performed to customize the tunnel.</simpara>
<simpara>Remember to configure the router at each end of the tunnel.
If only one side of a tunnel is configured,
the tunnel interface may still come up and stay up (unless
keepalive is configured), but packets going into the tunnel will be dropped.</simpara>
<formalpara>
<title>summary steps</title>
<para>
<screen>interface tunnel number
  bandwidth kbps
  keepalive [period [retries]]
  tunnel source {ip-address | interface-type interface-number}
  tunnel destination {hostname | ip-address}
  tunnel key key-number
  tunnel mode {gre ip| gre multipoint}
  ip mtu bytes
  ip tcp mss mss-value
  tunnel path-mtu-discovery [age-timer {aging-mins| infinite}]</screen>
</para>
</formalpara>
<section xml:id="_create_a_tunnel_interface_2">
<title>Create a tunnel interface</title>
<screen>interface tunnel number</screen>
</section>
<section xml:id="_specify_a_source_interface_for_the_tunnel_2">
<title>Specify a source interface for the tunnel.</title>
<simpara>The tunnel source interface can be a local physical or logical local interface,
and not just an IP address</simpara>
<screen>tunnel source {a.b.c.d | source-interface }</screen>
</section>
<section xml:id="_specify_the_destination_ip_address_for_the_tunnel_2">
<title>Specify the destination IP address for the tunnel</title>
<tip>
<simpara>The router should have a route to this address, but not through the tunnel interface.</simpara>
</tip>
<screen>tunnel destination ip-address</screen>
</section>
<section xml:id="_specify_the_tunnel_mode_2">
<title>Specify the tunnel mode</title>
<simpara>The default tunnel mode is <emphasis role="strong">gre ip</emphasis>.</simpara>
<screen>tunnel mode [gre {ip | multipoint} | dvmrp | ipip | mpls | nos]</screen>
</section>
<section xml:id="_adjust_the_gre_keepalive_2">
<title>Adjust the GRE keepalive</title>
<simpara>Specifies the number of times that the device will continue to send keepalive
packets without response before bringing the tunnel interface protocol down.</simpara>
<simpara>GRE keepalive packets may be configured either on only one side of the tunnel or on both.
<simpara>This command is supported only on GRE point-to-point tunnels.</simpara>
<screen>(config-if)# keepalive [ period [retries]]</screen>
</section>
</section>
<section xml:id="_configuration_example_2">
<title>Configuration example</title>
<simpara>Note that Ethernet interface 0/1 is the tunnel source for Router A and the tunnel destination for Router B.
Fast Ethernet interface 0/1 is the tunnel source for Router B and the tunnel destination for Router A.</simpara>
<variablelist>
<varlistentry>
<term>Router A</term>
<listitem>
<screen>interface Tunnel0
 ip address 10.1.1.2 255.255.255.0
 tunnel source Ethernet0/1
 tunnel destination 192.168.3.2
 tunnel mode gre ip
!
interface Ethernet0/1
 ip address 192.168.4.2 255.255.255.0</screen>
</listitem>
</varlistentry>
<varlistentry>
<term>Router B</term>
<listitem>
<screen>interface Tunnel0
 ip address 10.1.1.1 255.255.255.0
 tunnel source FastEthernet0/1
 tunnel destination 192.168.4.2
 tunnel mode gre ip
!
interface FastEthernet0/1
 ip address 192.168.3.2 255.255.255.0</screen>
</listitem>
</varlistentry>
</variablelist>
</section>
</section>
<section xml:id="_troubleshooting_6">
<title>Troubleshooting</title>
<simpara>Three reasons for a GRE tunnel to shut down:</simpara>
<itemizedlist>
<listitem>
<simpara>There is no route to the tunnel destination address.</simpara>
</listitem>
<listitem>
<simpara>The interface that anchors the tunnel source is down.</simpara>
</listitem>
<listitem>
<simpara>The route to the tunnel destination address is through the tunnel itself. %TUN-5-RECURDOWN:Tunnel0</simpara>
</listitem>
</itemizedlist>
<simpara>With the above three reasons for tunnel shut down are problems local to the
router at the tunnel endpoints and do not cover problems in the intervening
network.</simpara>
<simpara>Also if the two routers tunnel modes do not match, the tunnel interface can
still stay in an up/ip state but the routers cannot forward packets because of
the mismatch encapsulation.</simpara>
<section xml:id="__tun_5_recurdown_error_message_and_flapping_eigrp_ospf_bgp_neighbors_over_a_gre_tunnel_2">
<title>"%TUN-5-RECURDOWN" error message and flapping EIGRP/OSPF/BGP neighbors over a GRE tunnel</title>
</section>
</section>
<section xml:id="_questions_3">
<title>Questions</title>
<orderedlist numeration="arabic">
<listitem>
<simpara>What is the minimum amount of additional header that GRE adds to a packet?</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>16 bytes</simpara>
</listitem>
<listitem>
<simpara>20 bytes</simpara>
</listitem>
<listitem>
<simpara>24 bytes</simpara>
</listitem>
<listitem>
<simpara>36 bytes</simpara>
</listitem>
<listitem>
<simpara>48 bytes</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Which of the following are valid options in a GRE header (select all that apply)?</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>GRE Header Length</simpara>
</listitem>
<listitem>
<simpara>Checksum Present</simpara>
</listitem>
<listitem>
<simpara>Key Present</simpara>
</listitem>
<listitem>
<simpara>External Encryption</simpara>
</listitem>
<listitem>
<simpara>Protocol</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>What is the purpose of a GRE tunnel interface?</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>It is always the tunnel source interface.</simpara>
</listitem>
<listitem>
<simpara>It is always the tunnel destination interface.</simpara>
</listitem>
<listitem>
<simpara>It is where the protocol that travels through the tunnel is configured.</simpara>
</listitem>
<listitem>
<simpara>It is the interface that maps to the physical tunnel port.</simpara>
</listitem>
<listitem>
<simpara>It is not used today</simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
</chapter>
<chapter xml:id="_dmvpn">
<title>DMVPN</title>
<section xml:id="_concepts_10">
<title>Concepts</title>
<itemizedlist>
<listitem>
<simpara>dynamic creation of spoke-to-spoke</simpara>
</listitem>
<listitem>
<simpara>DMVPN = mGRE + NHRP + IPSec</simpara>
</listitem>
</itemizedlist>
<simpara>Start with mGRE configuration</simpara>
<simpara>interface tunnel 0
  ip address 141.11.10.1 255.255.255.0
  tunnel source e0
  tunnel mode gre multipoint</simpara>
</section>
<section xml:id="_phases">
<title>Phases</title>
<variablelist>
<varlistentry>
<term>Phase 1</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Hub and spoke functionality</simpara>
</listitem>
<listitem>
<simpara>for simplified and smaller configuration</simpara>
</listitem>
<listitem>
<simpara>zero touch provisioning for adding spokes to the VPN</simpara>
</listitem>
<listitem>
<simpara>supports dynamically addressed CPEs</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Phase 2</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Spoke-to-spoke functionality</simpara>
</listitem>
<listitem>
<simpara>on demand spoke-to-spoke tunnels avoids dual encrypts/decrypts</simpara>
</listitem>
<listitem>
<simpara>Smaller spoke CPE can participate in the virtual mesh</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Phase 3</term>
<listitem>
<simpara>Architecture and scaling</simpara>
</listitem>
</varlistentry>
</variablelist>
<formalpara>
<title>Task: Verify NHRP configuration</title>
<para>
<screen># sh ip nhrp

141.11.10.2/32 via 141.11.10.2
   Tunnel1234 created 00:02:21, expire 00:57:38
   Type: dynamic, Flags: unique registered
   NBMA address: 10.11.10.2
141.11.10.3/32 via 141.11.10.3
   Tunnel1234 created 00:02:09, expire 00:57:50
   Type: dynamic, Flags: unique registered
   NBMA address: 10.11.10.3</screen>
</para>
</formalpara>
</section>
</chapter>
<chapter xml:id="_nhrp">
<title>NHRP</title>
<simpara>TIP:
if dmvpn phase 3, the tunnel key must be the same as the tunnel key</simpara>
<simpara>!! DMVPN HUB
int f0/0.123
	enc dot1q 123
	ip address 10.0.0.1 255.255.255.0
	no shut
int t123
  ip add 129.99.123.1 255.255.255.0
  tunnel source f0/0.123
  tunnel mode gre multipoint
  tunnel key 123
  ip nhrp network-id 123
  ip nhrp map multicast dynamic
  ip nhrp network-id 321</simpara>
<simpara>!! DMVPN SPOKE
int f0/0.123
	desc ospf
	enc dot1q 123
	ip address 10.0.0.2 255.255.255.0
int t123
  ip add 129.99.123.2 255.255.255.0
  tunnel source f0/0.123
  tunnel destination 10.0.0.1
  tunnel key 123
  ip nhrp network-id 123
  ip nhrp nhs 129.99.123.1
  ip nhrp map multicast 10.0.0.1
  ip nhrp map 129.99.123.1 10.0.0.1</simpara>
<formalpara>
<title>Task: Verify that NHRP registration has been sent from spokes to the hub</title>
<para>
<screen>R1#sh ip nhrp

129.99.123.2/32 via 129.99.123.2
   Tunnel123 created 00:08:18, expire 01:54:55
   Type: dynamic, Flags: unique registered
   NBMA address: 10.0.0.2
129.99.123.3/32 via 129.99.123.3
   Tunnel123 created 00:09:22, expire 01:54:57
   Type: dynamic, Flags: unique registered
   NBMA address: 10.0.0.3</screen>
</para>
</formalpara>
</chapter>
<chapter xml:id="_ipsec">
<title>IPSEC</title>

</chapter>
</part>
<part xml:id="_infrastructure_security">
<title>Infrastructure Security</title>
<chapter xml:id="_device_security">
<title>Device security</title>
<section xml:id="_snmp">
<title>SNMP</title>
<section xml:id="_overview_12">
<title>Overview</title>
<itemizedlist>
<listitem>
<simpara>Application-layer protocol between SNMP managers and agents</simpara>
<itemizedlist>
<listitem>
<simpara>SNMP manager running NMS software:i UDP port 162 open for traps/informs messages</simpara>
</listitem>
<listitem>
<simpara>SNMP managed devices running SNMP agent: UDP 161 open for GET/SET messages</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<section xml:id="_version_5">
<title>Version</title>
<variablelist>
<varlistentry>
<term>v1</term>
<listitem>
<simpara>original specs, weak authentication with community string</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>v2c</term>
<listitem>
<simpara>64-bit counters, getBulkRequest, informsRequest</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>v3</term>
<listitem>
<simpara>authentication, encryption</simpara>
</listitem>
</varlistentry>
</variablelist>
</section>
<section xml:id="_mib">
<title>MIB</title>
<simpara>MIB: dictionaries of OID</simpara>
<simpara>OID: hierarchical identifiers in numerical format that represent MIB variables.
( e.g. 1.3.6.1.2.1 "Interfaces"
1.3.6.1.4.1.9 "Enterprises - Cisco"
)</simpara>
</section>
<section xml:id="_packet_format_2">
<title>Packet format</title>
<figure>
<title>SNMP header format</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/snmp-header.png"/>
</imageobject>
<textobject><phrase>SNMP header format</phrase></textobject>
</mediaobject>
</figure>
<section xml:id="_snmp_pdu_types">
<title>SNMP PDU Types</title>
<orderedlist numeration="arabic">
<listitem>
<simpara>SetRequest</simpara>
</listitem>
<listitem>
<simpara>GetRequest</simpara>
</listitem>
<listitem>
<simpara>GetNextRequest</simpara>
</listitem>
<listitem>
<simpara>GetBulkRequest</simpara>
</listitem>
<listitem>
<simpara>Trap</simpara>
</listitem>
<listitem>
<simpara>InformsRquest</simpara>
</listitem>
<listitem>
<simpara>Response</simpara>
</listitem>
</orderedlist>
</section>
</section>
</section>
<section xml:id="_configuration_9">
<title>Configuration</title>
<section xml:id="_configure_basic_system_information">
<title>Configure basic system information</title>
<formalpara>
<title>Task: Configure the location information</title>
<para>
<screen>(config)# snmp-server location &lt;homesweethome&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure the contact information</title>
<para>
<screen>(config)# snmp-server contact &lt;no-where-to-be-found&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure the system serial number</title>
<para>
<screen>(config)# snmp-server chassis-id &lt;system-serial-number&gt;</screen>
</para>
</formalpara>
</section>
<section xml:id="_configure_snmp_v1_2">
<title>Configure SNMP v1/2</title>
<formalpara>
<title>Task: Create a view</title>
<para>
<screen>(config)# snmp-server view &lt;name&gt; &lt;oid-tree&gt; {included | excluded}</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure a community string</title>
<para>
<screen>(config)# snmp-server community &lt;string&gt; [view &lt;name&gt;] [ro|rw] [&lt;acl]</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display community string</title>
<para>
<screen># sh snmp community</screen>
</para>
</formalpara>
</section>
</section>
<section xml:id="_traps">
<title>Traps</title>
<formalpara>
<title>Task: Send traps to NMS</title>
<para>
<screen>(config)# snmp-server host &lt;ip-address&gt; [traps | informs] [version {1| 2c | 3 [auth | noauth | priv]}] community-string [udp-port port-number] [notification-type]</screen>
</para>
</formalpara>
</section>
<section xml:id="_snmp_v3">
<title>SNMP v3</title>
<formalpara>
<title>Task: Configure SNMP v3 group</title>
<para>
<screen>(config)# snmp-server group [&lt;groupname&gt; {v1 | v2c | v3 [auth | noauth | priv]}]
            [read &lt;readview&gt;]
            [write &lt;writeview&gt;]
            [notify &lt;notifyview&gt;]
            [access &lt;acl]</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display SNMP v3 group settings</title>
<para>
<screen># sh snmp group</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure  SNMP v3 user</title>
<para>
<screen>(config)# snmp-server engineID {local &lt;engine-id&gt; | remote &lt;ip-address&gt; [udp-port &lt;number&gt; ] [vrf &lt;vrf-name&gt; ] &lt;engine-id-string&gt; }
(config)# snmp-server user &lt;username&gt; &lt;groupname&gt; [remote &lt;ip-address&gt; [udp-port &lt;number&gt; ]] {v1 | v2c | v3 [encrypted] [auth {md5 | sha} &lt;auth-password&gt; ]} [access &lt;acl&gt;]</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display SNMP user information</title>
<para>
<screen># sh snmp user &lt;user&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display SNMP engineID</title>
<para>
<screen># sh snmp engineID</screen>
</para>
</formalpara>
</section>
<section xml:id="_configure_a_device_as_snmp_manager">
<title>Configure a device as SNMP manager</title>
<formalpara>
<title>Task: Configure the SNMP manager process</title>
<para>
<screen>(config)# snmp-server manager</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure the SNMP manager session time-out</title>
<para>
<screen>(config)# snmp-server manager session-timeout &lt;seconds&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display the status of the SNMP sessions</title>
<para>
<screen># sh snmp sessions brief</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display the current set of pending SNMP requests</title>
<para>
<screen># sh snmp pending</screen>
</para>
</formalpara>
</section>
<section xml:id="_enable_the_snmp_shutdown_mechanism">
<title>Enable the SNMP shutdown mechanism</title>
<formalpara>
<title>Task: Enable the SNMP shutdown mechanism</title>
<para>
<screen>(config)# snmp-server system-shutdown</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Define the maximum SNMP agent packet size</title>
<para>
<screen>(config)# snmp-server packetsize &lt;bytes&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Specify the TFTP servers used for saving and loading configuration files</title>
<para>
<screen>(config)# snmp-server tftp-server-list &lt;acl&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Disable SNMP agent</title>
<para>
<screen>(config)# no snmp-server</screen>
</para>
</formalpara>
</section>
</section>
</chapter>
<chapter xml:id="_network_security">
<title>Network security</title>
<section xml:id="_switch_security">
<title>Switch security</title>

</section>
<section xml:id="_router_security">
<title>Router security</title>

</section>
</chapter>
</part>
<part xml:id="_infrastructure_services">
<title>Infrastructure Services</title>
<chapter xml:id="_system_management">
<title>System management</title>

</chapter>
<chapter xml:id="_qos">
<title>QoS</title>

</chapter>
<chapter xml:id="_network_services">
<title>Network services</title>
<section xml:id="_hsrp">
<title>HSRP</title>
<section xml:id="_understand">
<title>Understand</title>
<itemizedlist>
<listitem>
</listitem>
<listitem>
<simpara>set of routes work in concert to present the illusion of a single virtual router to the hosts on the LAN</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_protocol">
<title>Protocol</title>
<section xml:id="_hsrp_packet">
<title>HSRP packet</title>
<simpara>MAC header | IP header | UDP packet | HSRP Packet</simpara>
<figure>
<title>HSRP packet</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/hsrp-packet.png"/>
</imageobject>
<textobject><phrase>HSRP packet</phrase></textobject>
</mediaobject>
</figure>
<variablelist>
<varlistentry>
<term>Version</term>
<listitem>
<simpara>HSRP version</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Opcode</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>0: <emphasis role="strong">Hello</emphasis>: The router is running and is capable of becoming the active or standby router</simpara>
</listitem>
<listitem>
<simpara>1: <emphasis role="strong">Coup</emphasis>: The router wishes to become the active router</simpara>
</listitem>
<listitem>
<simpara>2: <emphasis role="strong">Resign</emphasis>: The router no longer wishes to be active router</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>State</term>
<listitem>
</listitem>
</varlistentry>
</variablelist>
<informaltable frame="all" rowsep="1" colsep="1">
<tgroup cols="3">
<colspec colname="col_1" colwidth="5*"/>
<colspec colname="col_2" colwidth="15*"/>
<colspec colname="col_3" colwidth="80*"/>
<thead>
<row>
<entry align="left" valign="top">Code</entry>
<entry align="left" valign="top">State</entry>
<entry align="left" valign="top">Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>0</simpara></entry>
<entry align="left" valign="top"><simpara>Initial</simpara></entry>
<entry align="left" valign="top"><simpara>This is the starting state and indicates that HSRP is not running. This state is entered via a configuration change or when an interface first comes up.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>1</simpara></entry>
<entry align="left" valign="top"><simpara>Learn</simpara></entry>
<entry align="left" valign="top"><simpara>The router has not determined the virtual IP address, and not yet seen an authenticated Hello message from the active router. In this state the router is still waiting to hear from the active router.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>2</simpara></entry>
<entry align="left" valign="top"><simpara>Listen</simpara></entry>
<entry align="left" valign="top"><simpara>The router knows the virtual IP address, but is neither the active router nor the standby router. It listens for Hello messages from those routers.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>4</simpara></entry>
<entry align="left" valign="top"><simpara>Speak</simpara></entry>
<entry align="left" valign="top"><simpara>The router sends periodic Hello messages and is actively participating in the election of the active and/or standby router. A router cannot enter Speak state unless it has the virtual IP address.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>8</simpara></entry>
<entry align="left" valign="top"><simpara>Standby</simpara></entry>
<entry align="left" valign="top"><simpara>The router is a candidate to become the next active router and sends periodic Hello messages. Excluding transient conditions, there MUST be at most one router in the group in Standby state.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>16</simpara></entry>
<entry align="left" valign="top"><simpara>Active</simpara></entry>
<entry align="left" valign="top"><simpara>The router is currently forwarding packets that are sent to the group&#8217;s virtual MAC address. The router sends periodic Hello messages. Excluding transient conditions, there MUST be at most one router in Active state in the group.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<variablelist>
<varlistentry>
<term>Hellotime</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>3 seconds by default</simpara>
</listitem>
<listitem>
<simpara>only meaningful in Hello messages</simpara>
</listitem>
<listitem>
<simpara>configured on the router or learned from authenticated Hello message from the active router</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Holdtime</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>10 seconds by default</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Priority</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>default value: 100</simpara>
</listitem>
<listitem>
<simpara>The higher (priority || IP address) wins</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Group</term>
<term>Authentication Data</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>contains clear text password or 0x63 0x69 0x73 0x63 0x6F 0x00 0x00 0x00.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Virtual IP address</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>configured or learned from active router</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
</section>
<section xml:id="_finite_state_machine">
<title>Finite state machine</title>
<section xml:id="_events">
<title>Events</title>
<informaltable frame="all" rowsep="1" colsep="1">
<tgroup cols="2">
<colspec colname="col_1" colwidth="5*"/>
<colspec colname="col_2" colwidth="95*"/>
<thead>
<row>
<entry align="left" valign="top">#</entry>
<entry align="left" valign="top">Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>a</simpara></entry>
<entry align="left" valign="top"><simpara>HSRP is configured on an enabled interface.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>b</simpara></entry>
<entry align="left" valign="top"><simpara>HSRP is disabled on an interface or the interface is disabled.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>c</simpara></entry>
<entry align="left" valign="top"><simpara>Active timer expiry. The Active timer was set to the Holdtime when the last Hello message was seen from the active router.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>d</simpara></entry>
<entry align="left" valign="top"><simpara>Standby timer expiry. The Standby timer was set to the Holdtime when the last Hello message was seen from the standby router.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>e</simpara></entry>
<entry align="left" valign="top"><simpara>Hello timer expiry. The periodic timer for sending Hello messages has expired.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>f</simpara></entry>
<entry align="left" valign="top"><simpara>Receipt of a Hello message of higher priority from a router in Speak state.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>g</simpara></entry>
<entry align="left" valign="top"><simpara>Receipt of a Hello message of higher priority from the active router.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>h</simpara></entry>
<entry align="left" valign="top"><simpara>Receipt of a Hello message of lower priority from the active router.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>i</simpara></entry>
<entry align="left" valign="top"><simpara>Receipt of a Resign message from the active router.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>j</simpara></entry>
<entry align="left" valign="top"><simpara>Receipt of a Coup message from a higher priority router.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>k</simpara></entry>
<entry align="left" valign="top"><simpara>Receipt of a Hello message of higher priority from the standby router.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>l</simpara></entry>
<entry align="left" valign="top"><simpara>Receipt of a Hello message of lower priority from the standby router.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
</section>
<section xml:id="_actions">
<title>Actions</title>
<informaltable frame="all" rowsep="1" colsep="1">
<tgroup cols="3">
<colspec colname="col_1" colwidth="5*"/>
<colspec colname="col_2" colwidth="15*"/>
<colspec colname="col_3" colwidth="80*"/>
<thead>
<row>
<entry align="left" valign="top">#</entry>
<entry align="left" valign="top">Action Name</entry>
<entry align="left" valign="top">Actions to be taken as part of the state machine</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>A</simpara></entry>
<entry align="left" valign="top"><simpara>Start Active Timer</simpara></entry>
<entry align="left" valign="top"><simpara>If this action occurred as the result of the receipt of a an authenticated Hello message from the active router, the Active timer is set to the Holdtime field in the Hello message. Otherwise the Active timer is set to the current Holdtime value in use by this router. The Active timer is then started.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>B</simpara></entry>
<entry align="left" valign="top"><simpara>Start Standby Timer</simpara></entry>
<entry align="left" valign="top"><simpara>If this action occurred as the result of the receipt of an authenticated Hello message from the standby router, the Standby timer is set to the Holdtime field in the Hello message. Otherwise the Standby timer is set to the current hold time value in use by this router. The Standby timer is then started.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>C</simpara></entry>
<entry align="left" valign="top"><simpara>Stop Active Timer</simpara></entry>
<entry align="left" valign="top"><simpara>The Active timer is stopped.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>D</simpara></entry>
<entry align="left" valign="top"><simpara>Stop Standby Timer</simpara></entry>
<entry align="left" valign="top"><simpara>The Standby timer is stopped.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>E</simpara></entry>
<entry align="left" valign="top"><simpara>Learn Parameters</simpara></entry>
<entry align="left" valign="top"><simpara>This action is taken when an authenticated message is received from the active router. If the virtual IP address for this group was not manually configured, the virtual IP address MAY be learned from the message. The router MAY learn Hellotime and Holdtime values from the message.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>F</simpara></entry>
<entry align="left" valign="top"><simpara>Send Hello Message</simpara></entry>
<entry align="left" valign="top"><simpara>The router sends a Hello message with its current State, Hellotime and Holdtime.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>G</simpara></entry>
<entry align="left" valign="top"><simpara>Send Coup Message</simpara></entry>
<entry align="left" valign="top"><simpara>The router sends a Coup message to inform the active router that there is a higher priority router available.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>H</simpara></entry>
<entry align="left" valign="top"><simpara>Send Resign Message</simpara></entry>
<entry align="left" valign="top"><simpara>The router sends a Resign message to allow another router to become the active router.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>I</simpara></entry>
<entry align="left" valign="top"><simpara>Send Gratuitous ARP Message</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
<section xml:id="_transitions">
<title>Transitions</title>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/hsrp-packet.png"/>
</imageobject>
<textobject><phrase>hsrp packet</phrase></textobject>
</mediaobject>
</informalfigure>
</section>
<section xml:id="_hsrp_operations">
<title>HSRP operations</title>
<itemizedlist>
<listitem>
<simpara>Set of routers sharing one virtual IP address and one virtual MAC address</simpara>
</listitem>
<listitem>
<simpara>elect one active router with the highest (priority, IP address)</simpara>
</listitem>
<listitem>
<simpara>standy router takes over if Active router fails-</simpara>
</listitem>
<listitem>
<simpara>elect new standby router if standby router fails or becomes the active router.</simpara>
</listitem>
<listitem>
<simpara>to minimize network traffic, only the active and standby router send periodic HSRP messages.</simpara>
</listitem>
<listitem>
<simpara>a router may participate in multiple groups with seperate state and timers for each group</simpara>
</listitem>
<listitem>
<simpara>unique group id per vlan</simpara>
</listitem>
<listitem>
<simpara>hsrp address = 0000.0c07.ACxx (where xx is the HSRP group id)</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_hsrp_features">
<title>HSRP features</title>
<itemizedlist>
<listitem>
<simpara>preemption: the router with the highest priority becomes immediately the active router by sending a <emphasis role="strong">coup</emphasis> message,
The previous active router changes to the <emphasis role="strong">speak</emphasis> state and sends a <emphasis role="strong">resign</emphasis> message.</simpara>
</listitem>
<listitem>
<simpara>Preempt delay:</simpara>
<itemizedlist>
<listitem>
<simpara>delay preemption for a configurate time period allowing the router to populate its routing table</simpara>
</listitem>
<listitem>
<simpara>delays starts when preemption starts in IOS &gt; 12.0(9) otherwise when the router is reloaded.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Interface tracking</simpara>
<itemizedlist>
<listitem>
<simpara>reduce HSRP priority if the monitored interface goes down, allowing another HSRP router to become active if it has preemption enabled.</simpara>
</listitem>
<listitem>
<simpara>cumulative reduction if multiple tracked interfaces are down</simpara>
</listitem>
<listitem>
<simpara>configurable decrement value (default = 10)</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>ICMP redirects supports</simpara>
<itemizedlist>
<listitem>
<simpara>disable ICMP redirects on HSRP interfaces in IOS &lt; 12.1(3)T</simpara>
</listitem>
<listitem>
<simpara>HSRP router redirects the endstation to the virtual IP address instead of a particular IP address</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</section>
</section>
<section xml:id="_configure">
<title>Configure</title>

</section>
<section xml:id="_verify_4">
<title>Verify</title>

</section>
<section xml:id="_debug">
<title>Debug</title>

</section>
<section xml:id="_references">
<title>References</title>
</section>
</section>
<section xml:id="_glbp">
<title>GLBP</title>
<section xml:id="_concepts_11">
<title>Concepts</title>
<simpara>AVG active virtual gateway
AVF active virtual forwarder</simpara>
<itemizedlist>
<listitem>
<simpara>AVG responds to all ARP requests with MAC from all particapating AVF</simpara>
<itemizedlist>
<listitem>
<simpara>Not with own MAC address like HSRP</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>load-balancing</simpara>
<itemizedlist>
<listitem>
<simpara>round-robin (default)</simpara>
</listitem>
<listitem>
<simpara>weigthed</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>UDP port 3222</simpara>
</listitem>
</itemizedlist>
<simpara>!! GLBP configuration
int f0/0.40
  glbp 1 ip 172.16.26.100
  glbp 1 authentication md5 key-string test</simpara>
<formalpara>
<title>Task: Description</title>
<para>
<screen># sh glbp

FastEthernet0/0.40 - Group 1
  State is Standby
    1 state change, last state change 00:02:02
  Virtual IP address is 172.16.26.100
  Hello time 3 sec, hold time 10 sec
    Next hello sent in 2.720 secs
  Redirect time 600 sec, forwarder time-out 14400 sec
  Preemption disabled
  Active is 172.16.26.6, priority 100 (expires in 11.360 sec)
  Standby is local
  Priority 100 (default)
  Weighting 100 (default 100), thresholds: lower 1, upper 100
  Load balancing: round-robin
  Group members:
    ca02.6150.0000 (172.16.26.2) local
    ca06.618c.0000 (172.16.26.6)
  There are 2 forwarders (1 active)
  Forwarder 1
    State is Listen
    MAC address is 0007.b400.0101 (learnt)
    Owner ID is ca06.618c.0000
    Time to live: 14399.840 sec (maximum 14400 sec)
    Preemption enabled, min delay 30 sec
    Active is 172.16.26.6 (primary), weighting 100 (expires in 10.944 sec)
  Forwarder 2
    State is Active
      1 state change, last state change 00:02:08
    MAC address is 0007.b400.0102 (default)
    Owner ID is ca02.6150.0000
    Preemption enabled, min delay 30 sec
    Active is local, weighting 100</screen>
</para>
</formalpara>
</section>
</section>
<section xml:id="_vrrp">
<title>VRRP</title>
<section xml:id="_concepts_12">
<title>Concepts</title>

</section>
<section xml:id="_configurations">
<title>Configurations</title>

</section>
</section>
<section xml:id="_idrp">
<title>IDRP</title>
<section xml:id="_overview_13">
<title>Overview</title>
<itemizedlist>
<listitem>
<simpara>ICMP Router Discovery Protocol allows hosts to locate routers
that can be used as gateway to reach IP-based devices on other networks.</simpara>
</listitem>
<listitem>
</listitem>
</itemizedlist>
</section>
<section xml:id="_message_format">
<title>Message format</title>
<section xml:id="_icmp_router_advertisement_message">
<title>ICMP Router Advertisement Message</title>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/icmp-router-advertisement.png"/>
</imageobject>
<textobject><phrase>icmp router advertisement</phrase></textobject>
</mediaobject>
</informalfigure>
<variablelist>
<varlistentry>
<term>Type</term>
<listitem>
<simpara>9</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Code</term>
<listitem>
<simpara>0</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Checksum</term>
<listitem>
<simpara>The 16-bit one&#8217;s complement of the one&#8217;s complement sum of the ICMP message,
starting with the ICMP Type.
For computing the checksum, the Checksum field is set to 0.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Num Addrs</term>
<listitem>
<simpara>Number of router addreses advertised in this message</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Addr Entry Size</term>
<listitem>
<simpara>Number of 32-bit words of information per router address (=2 for IPv4)</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Lifetime</term>
<listitem>
<simpara>Maximum number of seconds that the router adresses may be considered valid.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Router Address[i]</term>
<listitem>
<simpara>Sending router&#8217;s addresses on the interface from which this message is sent.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Preference Level[i]</term>
<listitem>
<simpara>Preferability of each Router Address[i] as a default router,
relative to other router addresses on the same subnet. Higher values more preferable.</simpara>
</listitem>
</varlistentry>
</variablelist>
</section>
<section xml:id="_icmp_router_solicitation_message">
<title>ICMP Router Solicitation Message</title>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/icmp-router-advertisement.png"/>
</imageobject>
<textobject><phrase>icmp router advertisement</phrase></textobject>
</mediaobject>
</informalfigure>
<variablelist>
<varlistentry>
<term>Type</term>
<listitem>
<simpara>10</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Code</term>
<listitem>
<simpara>0</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Checksum</term>
<listitem>
<simpara>The 16-bit one&#8217;s complement of the one&#8217;s complement sum of the ICMP message,
starting with the ICMP Type.
For computing the checksum, the Checksum field is set to 0.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>Reserved</term>
<listitem>
<simpara>Sent as 0; ignored on reception.</simpara>
</listitem>
</varlistentry>
</variablelist>
</section>
</section>
<section xml:id="_configuration_10">
<title>Configuration</title>
<formalpara>
<title>Task: Configure a gateway to discover routers that transmit IRDP router updates after disabling IP routing</title>
<para>
<screen>no ip routing
ip gdp irdp [multicast]</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Enable IRDP on an interface</title>
<para>
<screen>(config-if)# ip irdp</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Send IRDP Advertisement to the all-systems multicast addresses</title>
<para>
<screen>(config-if)# ip irdp multicast</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Set the IRDP period for which advertisements are valid.</title>
<para>
<screen>(config-if)# ip irdp holdtime &lt;seconds&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Sets the IRDP maximum interval between advertisements.</title>
<para>
<screen>ip irdp maxadvertinterval &lt;seconds&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Set the IRDP minimum interval between advertisements.</title>
<para>
<screen>ip irdp minadvertinterval &lt;seconds&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Set the IRDP preference level of the device</title>
<para>
<screen>(config-if)# ip irdp preference &lt;number&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Specify an IRDP address and preference to prozy-advertise</title>
<para>
<screen>(config-if)# ip irdp address &lt;a.b.c.d&gt; &lt;preference-level&gt;</screen>
</para>
</formalpara>
</section>
</section>
<section xml:id="_ntp">
<title>NTP</title>
<section xml:id="_overview_14">
<title>Overview</title>
<itemizedlist>
<listitem>
</listitem>
<listitem>
<simpara>UDP port 123</simpara>
</listitem>
<listitem>
<simpara>IOS does not support stratum 1 service, cannot be linked to stratum 0 atomic clock</simpara>
</listitem>
<listitem>
<simpara>Accuracy &lt; milliseconds with 1 NTP packet per minute</simpara>
</listitem>
<listitem>
<simpara>Stratum</simpara>
<itemizedlist>
<listitem>
<simpara>0 : atomic clock</simpara>
</listitem>
<listitem>
<simpara>8 : default value</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</section>
<section xml:id="_ntp_associations">
<title>NTP associations</title>
<itemizedlist>
<listitem>
<simpara>Polled-based: better accuracy and reliability</simpara>
<itemizedlist>
<listitem>
<simpara>Client mode: <emphasis role="strong">ntp server</emphasis></simpara>
</listitem>
<listitem>
<simpara>Symmetric active mode: <emphasis role="strong">ntp peer</emphasis></simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Broadcast-based: less manual configuration on LAN</simpara>
<itemizedlist>
<listitem>
<simpara>Server: <emphasis role="strong">ntp broadcast</emphasis></simpara>
</listitem>
<listitem>
<simpara>Client: <emphasis role="strong">ntp broadcast client</emphasis></simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Verify NTP status</title>
<para>
<screen># show ntp status</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Verify NTP associations</title>
<para>
<screen># show ntp associations</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Troubleshoot NTP associations</title>
<para>
<screen># debug ntp refclock</screen>
</para>
</formalpara>
<section xml:id="_polled_based_associations">
<title>Polled-based associations</title>
<screen>(config)# ntp server &lt;ip-address&gt; [normal-sync] [version &lt;number&gt;] [key &lt;id&gt;] [prefer]
(config)# ntp peer &lt;ip-address&gt; [normal-sync] [version &lt;number&gt;] [key &lt;id&gt;] [prefer]</screen>
</section>
<section xml:id="_broadcast_based_associations">
<title>Broadcast-based associations</title>
<screen>(config-if)# ntp broadcast version &lt;number&gt;
(config-if)# ntp broadcast client
(config-if)# ntp broadcastdelay &lt;microseconds&gt;</screen>
</section>
</section>
<section xml:id="_ntp_access_groups">
<title>NTP access groups</title>
<formalpara>
<title>Task: Grant/deny access privileges with ipv4 or ipv6 access-lists</title>
<para>
<screen>(config)# ntp access-group [ipv4 | ipv6] &lt;options&gt;  &lt;access-list-id&gt; [kod]</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara><emphasis>options</emphasis> per increasing order of restrictions are:</simpara>
<itemizedlist>
<listitem>
<simpara><emphasis role="strong">peer</emphasis>: synchronize itself to systems whose address passes access list criteria</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">serve</emphasis>: allows time requests and NTP control queries but no synchronization</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">serve-only</emphasis>: allows only time requests</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">query-only</emphasis>: allows only NTP control queries</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara><emphasis role="strong">kod</emphasis> sends the kiss-of-death packet to any host that tries to send a packet
that is not compliant with the access-group policy.</simpara>
</listitem>
</itemizedlist>
</note>
</section>
<section xml:id="_ntp_authentication">
<title>NTP authentication</title>
<itemizedlist>
<listitem>
<simpara>Use cryptographic checksum keys</simpara>
</listitem>
<listitem>
<simpara>Encryption/decryption are CPU-intensive and may degrade accuracy</simpara>
</listitem>
</itemizedlist>
<screen>(config)# ntp authenticate
(config)# ntp authentication-key &lt;number&gt; md5 &lt;key&gt;
(config)# ntp trusted-key &lt;key-number&gt; [-&lt;end-key-number]
(config)# ntp server &lt;ip-address&gt; key &lt;id&gt;</screen>
</section>
<section xml:id="_source_ip_address">
<title>Source IP address</title>
<itemizedlist>
<listitem>
<simpara>Default to NTP packet outgoing interface</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Change the source IP address for all destinations</title>
<para>
<screen>(config)# ntp source interface</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Change the source for a specific association</title>
<para>
<screen>(config)# ntp {server|peer} source</screen>
</para>
</formalpara>
</section>
<section xml:id="_authoritative_server">
<title>Authoritative server</title>
<formalpara>
<title>Task:</title>
<para>
<screen>(config)# ntp master</screen>
</para>
</formalpara>
</section>
<section xml:id="_panic_treshold">
<title>Panic treshold</title>
<formalpara>
<title>Task: Reject time updates greater than the panic threshold of 1000 seconds</title>
<para>
<screen>(config)# ntp panic update</screen>
</para>
</formalpara>
</section>
<section xml:id="_orphan_mode">
<title>Orphan mode</title>
<itemizedlist>
<listitem>
<simpara>When a subnet lost communications with clock servers</simpara>
</listitem>
<listitem>
<simpara>Orphan parent simulate a UTC source for orphan children</simpara>
</listitem>
</itemizedlist>
<screen>(config)# ntp server &lt;a.b.c.d&gt;
(config)# ntp peer &lt;e.f.g.h&gt;
(config)# ntp orphan &lt;stratum&gt;</screen>
</section>
<section xml:id="_external_reference_clock">
<title>external reference clock</title>
<screen># line aux &lt;number&gt;
# ntp refclock trimble pps none stratum &lt;number&gt;</screen>
</section>
<section xml:id="_software_clock">
<title>Software clock</title>
<screen>(config)# clock timezone &lt;zone&gt; &lt;hours-offset&gt; [&lt;minutes-offset&gt;]
(config)# summer-time &lt;zone&gt; recurring [&lt;week day month hh:mm&gt; [&lt;offset&gt;]]
(config)# summer-time &lt;zone&gt; date [&lt;date month year hh:mm&gt; [&lt;offset&gt;]]
# clock set &lt;hh:mm:ss date month year&gt;
# show clock</screen>
</section>
<section xml:id="_hardware_clock">
<title>Hardware-clock</title>
<itemizedlist>
<listitem>
<simpara>different from software-clock</simpara>
</listitem>
</itemizedlist>
<screen># calendar set &lt;hh:mm:ss date month year&gt;
(config)# clock calendar-valid
# clock read-calendar
# clock update-calendar
# show calendar
# show clock [detail]
# show ntp associations [details]
# show ntp status</screen>
</section>
<section xml:id="_time_ranges">
<title>Time Ranges</title>
<formalpara>
<title>Task: Configure time ranges</title>
<para>
<screen>(config)# time-range &lt;name&gt;
(config-time-range)# absolute [start &lt;hh:mm date month year&gt;] [end &lt;hh:mm date month year&gt;]
(config-time-range)# periodic &lt;day-of-week&gt; &lt;hh:mm&gt; to [&lt;day-of-the-week&gt;] &lt;hh:mm&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Verify time range</title>
<para>
<screen># show time-range</screen>
</para>
</formalpara>
</section>
<section xml:id="_vulnerability">
<title>Vulnerability</title>
<itemizedlist>
<listitem>
<simpara>DoS for version &#8656; 4.2.4p7</simpara>
</listitem>
<listitem>
<simpara>No workaround, disable NTP on the device</simpara>
</listitem>
<listitem>
<simpara>Symptoms:</simpara>
</listitem>
</itemizedlist>
</section>
</section>
<section xml:id="_dhcp">
<title>DHCP</title>
<itemizedlist>
<listitem>
</listitem>
</itemizedlist>
<section xml:id="_overview_15">
<title>Overview</title>
<itemizedlist>
<listitem>
<simpara>Https://tools.ietf.org/html/rfc2131[RFC 2131]</simpara>
<itemizedlist>
<listitem>
<simpara>Dynamic Host Configuration Protocol</simpara>
</listitem>
<listitem>
<simpara>Based on BOOTP</simpara>
</listitem>
<listitem>
<simpara>Client/agent relay/server model</simpara>
</listitem>
<listitem>
<simpara>UDP port 67</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<figure>
<title>DHCP request for an IP address from a DHCP Server</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/dhcp-request.png"/>
</imageobject>
<textobject><phrase>DHCP request for an IP address from a DHCP Server</phrase></textobject>
</mediaobject>
</figure>
</section>
<section xml:id="_protocol_operations">
<title>Protocol operations</title>
<figure>
<title>DHCP message</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/dhcp-message-format.png.png"/>
</imageobject>
<textobject><phrase>DHCP message</phrase></textobject>
</mediaobject>
</figure>
<informaltable frame="all" rowsep="1" colsep="1">
<tgroup cols="3">
<colspec colname="col_1" colwidth="9.0909*"/>
<colspec colname="col_2" colwidth="9.0909*"/>
<colspec colname="col_3" colwidth="81.8182*"/>
<thead>
<row>
<entry align="left" valign="top">FIELD</entry>
<entry align="center" valign="top">OCTETS</entry>
<entry align="left" valign="top">DESCRIPTION</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>op</simpara></entry>
<entry align="center" valign="top"><simpara>1</simpara></entry>
<entry align="left" valign="top"><simpara>Message op code / message type.   1 = BOOTREQUEST, 2 = BOOTREPLY</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>htype</simpara></entry>
<entry align="center" valign="top"><simpara>1</simpara></entry>
<entry align="left" valign="top"><simpara>Hardware address type</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>hlen</simpara></entry>
<entry align="center" valign="top"><simpara>1</simpara></entry>
<entry align="left" valign="top"><simpara>Hardware address length</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>hops</simpara></entry>
<entry align="center" valign="top"><simpara>1</simpara></entry>
<entry align="left" valign="top"><simpara>Client sets to zero, optionally used by relay agents when booting via a relay agent.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>xid</simpara></entry>
<entry align="center" valign="top"><simpara>4</simpara></entry>
<entry align="left" valign="top"><simpara>Transaction ID, a random number chosen by the client, used by the client and server to associate messages and responses between a client and a server.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>secs</simpara></entry>
<entry align="center" valign="top"><simpara>2</simpara></entry>
<entry align="left" valign="top"><simpara>Filled in by client, seconds elapsed since client began address acquisition or renewal process.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>flags</simpara></entry>
<entry align="center" valign="top"><simpara>2</simpara></entry>
<entry align="left" valign="top"><simpara>Flags</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>ciaddr</simpara></entry>
<entry align="center" valign="top"><simpara>4</simpara></entry>
<entry align="left" valign="top"><simpara>Client IP address; only filled in if client is in BOUND, RENEW or REBINDING state and can respond to ARP requests.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>yiaddr</simpara></entry>
<entry align="center" valign="top"><simpara>4</simpara></entry>
<entry align="left" valign="top"><simpara>'your' (client) IP address.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>siaddr</simpara></entry>
<entry align="center" valign="top"><simpara>4</simpara></entry>
<entry align="left" valign="top"><simpara>IP address of next server to use in bootstrap returned in DHCPOFFER, DHCPACK by server.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>giaddr</simpara></entry>
<entry align="center" valign="top"><simpara>4</simpara></entry>
<entry align="left" valign="top"><simpara>Relay agent IP address, used in booting via a relay agent.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>chaddr</simpara></entry>
<entry align="center" valign="top"><simpara>16</simpara></entry>
<entry align="left" valign="top"><simpara>Client hardware address.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>sname</simpara></entry>
<entry align="center" valign="top"><simpara>64</simpara></entry>
<entry align="left" valign="top"><simpara>Optional server host name, null terminated string.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>file</simpara></entry>
<entry align="center" valign="top"><simpara>128</simpara></entry>
<entry align="left" valign="top"><simpara>Boot file name, null terminated string; "generic" name or null in DHCPDISCOVER, fully qualified directory-path name in DHCPOFFER.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>options</simpara></entry>
<entry align="center" valign="top"><simpara>var</simpara></entry>
<entry align="left" valign="top"><simpara>Optional parameters field.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
<section xml:id="_dhcp_server">
<title>DHCP Server</title>
<itemizedlist>
<listitem>
<simpara>Accepts address assignment requests and renewals from clients</simpara>
</listitem>
<listitem>
<simpara>Assign address, name server, gateways, &#8230;&#8203;</simpara>
</listitem>
<listitem>
<simpara>Accepts broadcasts from local clients or relay agents</simpara>
</listitem>
<listitem>
<simpara>Database as a tree used for attribute inheritance</simpara>
<itemizedlist>
<listitem>
<simpara>Root: address pool for natural networks</simpara>
</listitem>
<listitem>
<simpara>Branches: subnetwork address pools</simpara>
</listitem>
<listitem>
<simpara>Leaves: manual bindings</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Clear DHCP server variables</title>
<para>
<screen>clear ip dhcp binding { &lt;address&gt; | * }
clear ip dhcp conflict { &lt;address&gt; | * }
clear ip dhcp server statistics</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Troubleshoot DHCP IP address assignments, lease expirations, and database chnages</title>
<para>
<screen># debug ip dhcp server events</screen>
</para>
</formalpara>
<section xml:id="_database_agent">
<title>Database agent</title>
<itemizedlist>
<listitem>
<simpara>Host (ftp, tftp, rcp) or storage that stores the DHCP bindings database.</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Save automatic bindings on a remote host</title>
<para>
<screen>ip dhcp database &lt;url&gt; [timeout &lt;seconds&gt;] [ write-dely &lt;seconds&gt;]</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara><emphasis role="strong">url</emphasis>: can be ftp,tftp, rcp, flash, disk</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">timeout</emphasis>: how long the DHCP server wait before aborting database transfer. default: 5 minutes</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">write-delay</emphasis>: how soon the DHCP server should send database updates. default:  5 minutes, minimum: 60 seconds</simpara>
</listitem>
</itemizedlist>
</note>
<formalpara>
<title>Task: Run DHCP server without database agent</title>
<para>
<screen>(config)# no ip dhcp conflict logging</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>Not recommended</simpara>
</listitem>
<listitem>
<simpara>TODO: add the reason</simpara>
</listitem>
</itemizedlist>
</note>
</section>
<section xml:id="_address_pool">
<title>Address Pool</title>
<itemizedlist>
<listitem>
<simpara>Specify which DHCP options to use for the client</simpara>
<itemizedlist>
<listitem>
<simpara>If the client is not directly connected to the DHCP server (the giaddr field of the DHCPDISCOVER broadcast message is nonzero), the server matches the DHCPDISCOVER with the DHCP pool that has the subnet that contains the IP address in the giaddr field.</simpara>
</listitem>
<listitem>
<simpara>If the client is directly connected to the DHCP server (the giaddr field is zero), the DHCP server matches the DHCPDISCOVER with DHCP pools that contain the subnets configured on the receiving interface. If the interface has secondary IP addresses, subnets associated with the secondary IP addresses are examined for possible allocation only after the subnet associated with the primary IP address (on the interface) is exhausted.</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Create a pool</title>
<para>
<screen>(config)# ip dhcp pool &lt;name&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Specify the subnet network number and mask of the address pool</title>
<para>
<screen>(dhcp-config)# network &lt;network-number&gt; [mask | prefix-length]</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Specify the secondary subnets</title>
<para>
<screen>(dhcp-config)# network &lt;network-number&gt; [mask | prefix-length] secondary</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Exclude IP address</title>
<para>
<screen>(config)# ip dhcp excluded-address &lt;low-address&gt; [&lt;high-address&gt;]</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Specify the domain name</title>
<para>
<screen>(dhcp-config)# domain-name &lt;example.com&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Specify the name server per order of preference</title>
<para>
<screen>(dhcp-config)# dns-server &lt;address&gt; [&lt;address2&gt; ... &lt;address8&gt;]</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Specify the default boot image for a client</title>
<para>
<screen>(dhcp-config)# bootfile &lt;filename&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Specify the netbios server</title>
<para>
<screen>(dhcp-config)# netbios-name-server &lt;address&gt; [&lt;address2&gt; ... &lt;address8&gt;]
(dhcp-config)# netbios-node-type &lt;type&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Specify the gateway</title>
<para>
<screen>(dhcp-config)# default-router  &lt;address&gt; [&lt;address2&gt; ... &lt;address8&gt;]</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Specify  a custom DHCP code</title>
<para>
<screen>(dhcp-config)# option &lt;code&gt; [instance &lt;number&gt;] {ascii &lt;string&gt; | hex &lt;string&gt; | &lt;ip-address&gt;}</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure the duration of the lease</title>
<para>
<screen>(dhcp-config)# lease &lt;days&gt; [&lt;hours&gt; [&lt;minutes&gt;] ]</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Specify the lease for ever</title>
<para>
<screen>(dhcp-config)# lease infinite</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure the utilization mark of the current address pool size</title>
<para>
<screen>(dhcp-config)# utilization mark high &lt;percentage-number&gt; [log]
(dhcp-config)# utilization mark low &lt;percentage-number&gt; [log]</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure a DHCP address pool with secondary subnets</title>
<para>
<screen>(dhcp-config)# override default-router ??
(dhcp-config)# override utilization high &lt;percentage&gt;
(dhcp-config)# override utilization low &lt;percentage&gt;</screen>
</para>
</formalpara>
<simpara>TODO: add explanation</simpara>
<formalpara>
<title>Task: Verify the DHCP address pool configuration</title>
<para>
<screen># show ip dhcp pool [name]
# show ip dhcp binding [address]
# show ip dhcp conflict [name]
# show ip dhcp database [url]
# show ip dhcp server statistics [type-number]</screen>
</para>
</formalpara>
</section>
<section xml:id="_address_bindings">
<title>Address bindings</title>
<itemizedlist>
<listitem>
<simpara>Mapping between the IP address and MAC address of a client</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Display the current mapping</title>
<para>
<screen># show ip dhcp binding</screen>
</para>
</formalpara>
<section xml:id="_automatic_bindings">
<title>automatic bindings</title>
<itemizedlist>
<listitem>
<simpara>Dynamically maps hardware address to an IP address from a pool.</simpara>
</listitem>
<listitem>
<simpara>Stored in volatile RAM and periodically copied to database agent</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_manual_binding">
<title>manual binding</title>
<itemizedlist>
<listitem>
<simpara>MAC address of hosts are found in the DHCP database</simpara>
</listitem>
<listitem>
<simpara>Stored in NVRAM</simpara>
</listitem>
<listitem>
<simpara>Can be configured</simpara>
<itemizedlist>
<listitem>
<simpara>Individually and stored in NVRAM</simpara>
</listitem>
<listitem>
<simpara>In batch from text files</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Specify the IP address and subnet mask of the client</title>
<para>
<screen>(dhcp-config)# host &lt;address&gt; [&lt;mask&gt;| &lt;/prefix-length]</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Specify the unique identifier for a DHCP client</title>
<para>
<screen>(dhcp-config)# client-identifier &lt;unique-identifier&gt;</screen>
</para>
</formalpara>
<itemizedlist>
<listitem>
<simpara>Send with DHCP option 61</simpara>
</listitem>
<listitem>
<simpara>Unique identifier</simpara>
<itemizedlist>
<listitem>
<simpara>7-byte: 1byte for the media , 6 byte for the MAC address</simpara>
</listitem>
<listitem>
<simpara>27-byte: vendor, MAC address, source interface of the client</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Determine the client identifier</title>
<para>
<screen># debug ip dhcp server packet

DHCPD:DHCPDISCOVER received from client 0b07.1134.a029 through relay 10.1.0.253.
DHCPD:assigned IP address 10.1.0.3 to client 0b07.1134.a029.</screen>
</para>
</formalpara>
<formalpara>
<title>Task:</title>
<para>
<screen>(dhcp-config)# hardware-address &lt;hw-address&gt; [&lt;protocol-type&gt; | &lt;hw-number&gt;]</screen>
</para>
</formalpara>
<itemizedlist>
<listitem>
<simpara>For client who can not send a client identifier in the packet</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task:</title>
<para>
<screen>(dhcp-config)# client-name &lt;name&gt;</screen>
</para>
</formalpara>
<itemizedlist>
<listitem>
<simpara>Do not include the domain name</simpara>
</listitem>
</itemizedlist>
</section>
</section>
<section xml:id="_static_mapping">
<title>Static mapping</title>
<itemizedlist>
<listitem>
<simpara>From customer-created text file that DHCP server reads at boot</simpara>
<itemizedlist>
<listitem>
<simpara>Short configuration: no need for several numerous host pools with manual bindings</simpara>
</listitem>
<listitem>
<simpara>Reduce space required in NVRAM to maintain address pools</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>The file format has the following elements:</simpara>
<itemizedlist>
<listitem>
<simpara>Database version number</simpara>
</listitem>
<listitem>
<simpara>End-of-file designator</simpara>
</listitem>
<listitem>
<simpara>Hardware type</simpara>
</listitem>
<listitem>
<simpara>Hardware address</simpara>
</listitem>
<listitem>
<simpara>IP address</simpara>
</listitem>
<listitem>
<simpara>Lease expiration</simpara>
</listitem>
<listitem>
<simpara>Time the file was created</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<formalpara>
<title>Example</title>
<para>
<screen>*time* Jan 21 2005 03:52 PM
*version* 2
!IP address    Type    Hardware address     Lease expiration
10.0.0.4 /24   1       0090.bff6.081e       Infinite
10.0.0.5 /28   id      00b7.0813.88f1.66    Infinite
10.0.0.2 /21   1       0090.bff6.081d       Infinite
*end*</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure the DHCP server to read a static mapping text file</title>
<para>
<screen>(dhcp-config)# origin file &lt;url&gt;</screen>
</para>
</formalpara>
</section>
<section xml:id="_pings">
<title>Pings</title>
<itemizedlist>
<listitem>
<simpara>DHCP server pings an IP address twice before assigning it to a client.</simpara>
</listitem>
<listitem>
<simpara>If the ping is unanswered after waiting for 2 seconds, the server assumes that the address is not in use.</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Specify the number of packets sent to a pool address before assigning it to a client</title>
<para>
<screen>(config)# ip dhcp ping packets &lt;number&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Specify how long a DHCP server waits for a ping reply from an address pool</title>
<para>
<screen>(config)# ip dhcp ping timeout &lt;milliseconds&gt;</screen>
</para>
</formalpara>
</section>
<section xml:id="_bootp_interoperability">
<title>BOOTP interoperability</title>
<formalpara>
<title>Task: Configure the DHCP server to not reply to any BOOTP requests.</title>
<para>
<screen>(config)# ip dhcp boot ignore</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Forward ignored BOOTP request packets to another DHCP server</title>
<para>
<screen>(config)# ip helper-address &lt;a.b.c.d&gt;</screen>
</para>
</formalpara>
</section>
<section xml:id="_central_dhcp_server">
<title>Central DHCP server</title>
<itemizedlist>
<listitem>
<simpara>Updates specific DHCP options for remote DHCP server</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Import DHCP option parameters from central DHCP server</title>
<para>
<screen>(dhcp-config)# import all
(config)# interface &lt;type&gt; &lt;number&gt;
(config-if)# ip address dhcp</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display the options that are imported from the central DHCP server</title>
<para>
<screen># sh ip dhcp import</screen>
</para>
</formalpara>
</section>
<section xml:id="_option_82">
<title>Option 82</title>
<itemizedlist>
<listitem>
<simpara>DHCP option contains information known by the relay agent</simpara>
</listitem>
<listitem>
<simpara>For dynamic IP addresses allocation</simpara>
</listitem>
<listitem>
<simpara>TOBECOMPLETED</simpara>
</listitem>
<listitem>
<simpara>By default, OS DHCP server uses info provided by option 82</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Enable DHCP address allocation with option 82</title>
<para>
<screen>(config)# ip dhcp use class</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Define a DHCP class and relay agent information patterns</title>
<para>
<screen>(config)# ip dhcp class &lt;name&gt;
(dhcp-class)# relay agent information
(dhcp-class-info)# relay-information hex &lt;pattern&gt; [*] [bitmask &lt;mask&gt;]</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display DHCP class matching results</title>
<para>
<screen># debug ip dhcp server class</screen>
</para>
</formalpara>
<section xml:id="_static_route_with_the_next_hop_dynamically_obtained_through_dhcp">
<title>Static route with the next-hop dynamically obtained through DHCP</title>
<simpara>TODO: explanation/context</simpara>
<formalpara>
<title>Task: Assign a static route for the default next-hop device when the DHCP server is accessed for an IP address</title>
<para>
<screen># ip route &lt;prefix&gt; &lt;mask&gt; {&lt;ip-address&gt; | &lt;interface-number&gt; [&lt;ip-number&gt;]} dhcp [&lt;distance&gt;]</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>Ensure that the DHCP client and server are defined to supply a DHCP device option 3 of the DHCP packet.</simpara>
</listitem>
<listitem>
<simpara>If the DHCP client is not able to obtain an IP address or the default device IP address, the static route is not installed in the routing table.</simpara>
</listitem>
<listitem>
<simpara>If the lease has expired and the DHCP client cannot renew the address, the DHCP IP address assigned to the client is released and any associated static routes are removed from the routing table.</simpara>
</listitem>
</itemizedlist>
</note>
</section>
</section>
<section xml:id="_statistics">
<title>Statistics</title>
<formalpara>
<title>Task: Display server statistics</title>
<para>
<screen># show ip dhcp server statistics</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Reset all DHCP server counters to 0</title>
<para>
<screen># clear ip dhcp server statistics</screen>
</para>
</formalpara>
</section>
</section>
<section xml:id="_dhcp_relay_agent">
<title>DHCP Relay Agent</title>
<itemizedlist>
<listitem>
<simpara>Forwards requests and replies between clients and servers not on the same physical subnet</simpara>
</listitem>
<listitem>
<simpara>Sets the <emphasis role="strong">giaddr</emphasis> field and adds option 82</simpara>
</listitem>
<listitem>
<simpara>DHCP server and relay agent are enabled by default</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Specify the packet forwarding address</title>
<para>
<screen>(config-if)# ip helper-address &lt;a.b.c.d&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Reduce the frequency with which DHCP clients change their addresses and forwards client requests to the server that handle the previous request.</title>
<para>
<screen>(config-if)# ip dhcp relay prefer known-good-server</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>The relay agent deletes the ARP entries for addresses offered to the client
on unnumbered interfaces.</simpara>
</listitem>
</itemizedlist>
</note>
<formalpara>
<title>Task: Disable the DHCP relay agent service</title>
<para>
<screen># no service dhcp</screen>
</para>
</formalpara>
<section xml:id="_option_82_2">
<title>Option 82</title>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="../images/dhcp-relay-agent-option-82.png"/>
</imageobject>
<textobject><phrase>dhcp relay agent option 82</phrase></textobject>
</mediaobject>
</informalfigure>
<formalpara>
<title>Task: Insert the DHCP relay agent information option in BOOTREQUEST messages forwarded to a DHCP server</title>
<para>
<screen># ip dhcp relay information option</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>This function is disabled by default</simpara>
</listitem>
</itemizedlist>
</note>
<formalpara>
<title>Task: Check whethers the relay agent information option forwarded BOOTREPLY message is valid</title>
<para>
<screen># ip dhcp relay information check</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure the reforwarding policy</title>
<para>
<screen># ip dhcp relay information policy {drop | keep | replace }</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure all interfaces as trusted sources of the DHCP relay information option.</title>
<para>
<screen># ip dhcp relay information trust-all</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure an interface as trusted sources of the DHCP relay information option.</title>
<para>
<screen>(config-if)# ip dhcp relay information trusted</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display all interfaces that are configure to be a trusted source for the DHCP relay information option.</title>
<para>
<screen># show ip dhcp relay information trusted-sources</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure per-interface support for the relay agent information option</title>
<para>
<screen>(config-if)# ip dhcp relay information option-insert [none]
(config-if)# ip dhcp relay information check-reply [none]
(config-if)# ip dhcp relay information policy-action {drop | keep | replace}</screen>
</para>
</formalpara>
<simpara>See more optional tasks
</section>
</section>
<section xml:id="_dhcp_client">
<title>DHCP Client</title>
<formalpara>
<title>Task: Acquire an IP address on an interface from DHCP</title>
<para>
<screen>(config-if)# ip address dhcp</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Display the DHCP packets sent and received during troubleshooting on the client side</title>
<para>
<screen># debug dhcp detail</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Force a release of a DHCP lease</title>
<para>
<screen># release dhcp</screen>
</para>
</formalpara>
<note>
<simpara>The <emphasis role="strong">release dhcp</emphasis> command</simpara>
<itemizedlist>
<listitem>
<simpara>Starts the process to immediately release a DHCP lease for the specified interface.</simpara>
</listitem>
<listitem>
<simpara>Does not deconfigure the <emphasis role="strong">ip address dhcp</emphasis> command specified in the configuration file for the interface.</simpara>
</listitem>
</itemizedlist>
</note>
<formalpara>
<title>Task: Force a renewal of a DHCP lease</title>
<para>
<screen># renew dhcp</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>The <emphasis role="strong">renew dhcp</emphasis> command advances the DHCP lease timer to the next stage,
at which point one of the following occurs:</simpara>
<itemizedlist>
<listitem>
<simpara>If the lease is currently in a BOUND state, the lease is advanced to the RENEW state and a DHCP RENEW request is sent.</simpara>
</listitem>
<listitem>
<simpara>If the lease is currently in a RENEW state, the timer is advanced to the REBIND state and a DHCP REBIND request is sent.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>If there is no response to the RENEW request,
the interface remains in the RENEW state.
In this case, the lease timer will advance to the REBIND state and subsequently send a REBIND request.</simpara>
</listitem>
<listitem>
<simpara>If a NAK response is sent in response to the RENEW request, the interface is deconfigured.</simpara>
</listitem>
</itemizedlist>
</note>
<section xml:id="_configurable_dhcp_client_feature">
<title>Configurable DHCP client feature</title>
<itemizedlist>
<listitem>
<simpara>Allows a client to use a user-specified client identifier, class identifier or suggested lease time when requesting an address from a DHCP server.</simpara>
</listitem>
<listitem>
<simpara>Options available:</simpara>
<itemizedlist>
<listitem>
<simpara>Option 33: configure a list of static routes in the client.</simpara>
</listitem>
<listitem>
<simpara>Option 51: request a lease time for the IP address.</simpara>
</listitem>
<listitem>
<simpara>Option 55: request certain options from the DHCP server</simpara>
</listitem>
<listitem>
<simpara>Option 60: configure the vendor class identifier string to use in the DHCP interaction.</simpara>
</listitem>
<listitem>
<simpara>Option 61: specify their unique identifier</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</section>
<section xml:id="_forcerenew_message_handling">
<title>FORCERENEW Message Handling</title>
<simpara>TODO: Explain the feature</simpara>
<formalpara>
<title>Task: Configure FORCERENEW message handling</title>
<para>
<screen>! Specify the key chain to be used in authenticating a request
(config)# key chain &lt;name&gt;
(config-keychain)# key &lt;id&gt;
(config-keychain-key)# key-string &lt;text&gt;
!
! Specify the type of authentication
(config)# interface &lt;type number&gt;
(config-if)# ip dhcp client authentication key-chain &lt;name&gt;
(config-if)# ip dhcp client authentication mode &lt;type&gt;
!
# ip dhcp-client forcerenew</screen>
</para>
</formalpara>
</section>
</section>
<section xml:id="_accounting_and_security">
<title>Accounting and Security</title>
<itemizedlist>
<listitem>
<simpara>Address vulnerability in PWLAN</simpara>
</listitem>
</itemizedlist>
<section xml:id="_dhcp_accounting">
<title>DHCP Accounting</title>
<itemizedlist>
<listitem>
<simpara>add AAA and RADIUS support to DHCP configuration</simpara>
</listitem>
<listitem>
<simpara>sends secure START/STOP accounting messages upon lease assignment/termination</simpara>
</listitem>
<listitem>
<simpara>Restrictions:</simpara>
<itemizedlist>
<listitem>
<simpara>AAA and RADIUS must be enabled</simpara>
</listitem>
<listitem>
<simpara>only for network pools with automatic bindings</simpara>
</listitem>
<listitem>
<simpara><emphasis role="strong">clear ip dhcp binding</emphasis> or <emphasis role="strong">no service dhcp</emphasis> triggers accounting STOP messages</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Enable DHCP accounting if a specifier server group is configured to run RADIUS accounting</title>
<para>
<screen>(dhcp-config)# accounting &lt;method-list-name&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Troubleshoot DHCP accounting</title>
<para>
<screen>debug radius accounting
debug ip dhcp server events
debug aaa accounting
debug aaa id</screen>
</para>
</formalpara>
</section>
<section xml:id="_dhc_secured_ip_address_assignment">
<title>DHC secured IP address assignment</title>
<itemizedlist>
<listitem>
<simpara>Secures and synchronizes the MAC address of the client to the DHCP binding,
preventing hackers form spoofing the DHCP server and taking over a DHCP lease of an authorized client</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Secure ARP table entries to DHCP leases in the DHCP database</title>
<para>
<screen>(dhcp-config)# update arp</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>Existing active DHCP leases will not be secured until they are renewed.</simpara>
</listitem>
</itemizedlist>
</note>
<formalpara>
<title>Task: Configure the renewal policy for unknown clients</title>
<para>
<screen>(dhcp-config)# renew deny unknown</screen>
</para>
</formalpara>
<note>
<itemizedlist>
<listitem>
<simpara>In some usage scenarios, such as a wireless hotspot,
where both DHCP and secure ARP are configured, a
connected client device might go to sleep or suspend for
a period of time. If the suspended time period is
greater than the secure ARP timeout (default of 91
seconds), but less than the DHCP lease time, the client
can awake with a valid lease, but the secure ARP timeout
has caused the lease binding to be removed because the
client has been inactive. When the client awakes, the
client still has a lease on the client side but is
blocked from sending traffic. The client will try to
renew its IP address but the DHCP server will ignore the
request because the DHCP server has no lease for the
client. The client must wait for the lease to expire
before being able to recover and send traffic again.</simpara>
</listitem>
<listitem>
<simpara>To remedy this situation, use the <emphasis role="strong">renew deny unknown</emphasis>
command in DHCP pool configuration mode. This command
forces the DHCP server to reject renewal requests from
clients if the requested address is present at the
server but is not leased. The DHCP server sends a
DHCPNAK denial message to the client, which forces the
client back to its initial state. The client can then
negotiate for a new lease immediately, instead of
waiting for its old lease to expire.</simpara>
</listitem>
</itemizedlist>
</note>
</section>
<section xml:id="_dhcp_per_interface_lease_limit_and_statistics">
<title>DHCP per interface lease limit and statistics</title>
<itemizedlist>
<listitem>
<simpara>Allows an ISP to limit the number of DHCP leases allowed on an interface.</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Configure a DHCP lease limit to control the number of subscribers on an interface</title>
<para>
<screen>(config)#  ip dhcp limit lease log
(config-if)# ip dhcp limit lease &lt;max-users&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Verify the DHCP lease limit configuration</title>
<para>
<screen># show ip dhcp limit lease</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Clear the stored lease violation entries</title>
<para>
<screen># clear ip dhcp limit lease</screen>
</para>
</formalpara>
</section>
<section xml:id="_dhcp_authorized_arp">
<title>DHCP authorized ARP</title>
<formalpara>
<title>Task: Disable dynamic ARP learning on an interface</title>
<para>
<screen>(config-if)# arp authorized</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Configure how long an entry remains in the ARP cache</title>
<para>
<screen>(config-if)# arp timeoute &lt;seconds&gt;</screen>
</para>
</formalpara>
<formalpara>
<title>Task:</title>
<para>
<screen># show arp</screen>
</para>
</formalpara>
</section>
<section xml:id="_arp_auto_logoff">
<title>ARP auto-logoff</title>
<itemizedlist>
<listitem>
<simpara>enhances DHCP authorized ARP by providing finer control and probing authorized clients to detect a logoff.</simpara>
</listitem>
</itemizedlist>
<formalpara>
<title>Task: Configure an interval and number of probe retries for ARP</title>
<para>
<screen>(config-if)# arp probe interval &lt;seconds&gt; count &lt;number&gt;</screen>
</para>
</formalpara>
</section>
<section xml:id="_dhcp_snooping">
<title>DHCP snooping</title>
<formalpara>
<title>TODO</title>
<para>add information about option 82</para>
</formalpara>
</section>
</section>
</section>
<section xml:id="_nat">
<title>NAT</title>
<section xml:id="_purpose">
<title>Purpose</title>
<itemizedlist>
<listitem>
<simpara>NAT allows the IP network of an organization to appear from
the outside to use a different IP address space than what it is actually using.</simpara>
</listitem>
<listitem>
<simpara>Thus, NAT allows an organization with nonglobally routable addresses to connect
to the Internet by translating those addresses into a globally routable address
space.</simpara>
</listitem>
<listitem>
<simpara>NAT also allows a graceful renumbering strategy for organizations that are changing service providers or voluntarily renumbering into classless
interdomain routing (CIDR) blocks.</simpara>
</listitem>
<listitem>
<simpara>RFC 1631.</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="_inside_and_outside_address">
<title>Inside and outside address</title>
<informaltable tabstyle="horizontal" frame="none" colsep="0" rowsep="0">
<tgroup cols="2">
<colspec colwidth="15*"/>
<colspec colwidth="85*"/>
<tbody valign="top">
<row>
<entry>
<simpara>Inside local address</simpara>
</entry>
<entry>
<simpara>The (private) IP address that is assigned to a host on the inside network.</simpara>
</entry>
</row>
<row>
<entry>
<simpara>Inside global address</simpara>
</entry>
<entry>
<simpara>A (public) IP address that represents one or more inside local IP addresses to the outside world.</simpara>
</entry>
</row>
<row>
<entry>
<simpara>Outside local address</simpara>
</entry>
<entry>
<simpara>The (private) IP address of an outside host as it appears to the inside network.</simpara>
</entry>
</row>
<row>
<entry>
<simpara>Outside global address</simpara>
</entry>
<entry>
<simpara>The (public) IP address assigned to a host on the outside network by the owner of the host.</simpara>
</entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
<section xml:id="_types_of_nat">
<title>Types of NAT</title>
<variablelist>
<varlistentry>
<term>Static NAT</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Statically correlates the same local host to the same public IP address.</simpara>
</listitem>
<listitem>
<simpara>Does not conserve IP addresses.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Dynamic NAT</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>One local host uses an available public IP address in a pool.</simpara>
</listitem>
<listitem>
<simpara>Does not conserve IP addresses.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>PAT</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Like dynamic NAT but multiple local hosts share a single public address by multiplexing TCP/UDP ports.</simpara>
</listitem>
<listitem>
<simpara>Conserves IP addresses.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>NAT for overlapping address</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Can be done with any of the first three types.</simpara>
</listitem>
<listitem>
<simpara>Translates both source and destination addresses, instead of just the source (for packets going from
enterprise to the Internet).</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
</section>
<section xml:id="_tcp_load_distribution_for_nat">
<title>TCP load distribution for NAT</title>
<itemizedlist>
<listitem>
<simpara>Round-robin allocation of a virtual host that coordinates load sharing among real hosts.</simpara>
</listitem>
</itemizedlist>
<figure>
<title>NAT TCP load distribution</title>
<mediaobject>
<imageobject>
<imagedata fileref="../images/nat-tcp-load-distribution.png"/>
</imageobject>
<textobject><phrase>nat tcp load distribution</phrase></textobject>
</mediaobject>
</figure>
</section>
<section xml:id="_nat_order_of_operations">
<title>NAT order of operations</title>
<section xml:id="_inside_to_outside">
<title>Inside-to-Outside</title>
<simpara>Inside-to-Outside 	Outside-to-Inside</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>If IPSec then check input access list</simpara>
</listitem>
<listitem>
<simpara>decryption - for CET (Cisco Encryption Technology) or IPSec</simpara>
</listitem>
<listitem>
<simpara>check input access list</simpara>
</listitem>
<listitem>
<simpara>check input rate limits</simpara>
</listitem>
<listitem>
<simpara>input accounting</simpara>
</listitem>
<listitem>
<simpara>redirect to web cache</simpara>
</listitem>
<listitem>
<simpara>policy routing</simpara>
</listitem>
<listitem>
<simpara>routing</simpara>
</listitem>
<listitem>
<simpara>NAT inside to outside (local to global translation)</simpara>
</listitem>
<listitem>
<simpara>crypto (check map and mark for encryption)</simpara>
</listitem>
<listitem>
<simpara>check output access list</simpara>
</listitem>
<listitem>
<simpara>inspect (Context-based Access Control (CBAC))</simpara>
</listitem>
<listitem>
<simpara>TCP intercept</simpara>
</listitem>
<listitem>
<simpara>encryption</simpara>
</listitem>
<listitem>
<simpara>Queueing</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_outside_to_inside">
<title>Outside-to-Inside</title>
<orderedlist numeration="arabic">
<listitem>
<simpara>If IPSec then check input access list</simpara>
</listitem>
<listitem>
<simpara>decryption - for CET or IPSec</simpara>
</listitem>
<listitem>
<simpara>check input access list</simpara>
</listitem>
<listitem>
<simpara>check input rate limits</simpara>
</listitem>
<listitem>
<simpara>input accounting</simpara>
</listitem>
<listitem>
<simpara>redirect to web cache</simpara>
</listitem>
<listitem>
<simpara>NAT outside to inside (global to local translation)</simpara>
</listitem>
<listitem>
<simpara>policy routing</simpara>
</listitem>
<listitem>
<simpara>routing</simpara>
</listitem>
<listitem>
<simpara>crypto (check map and mark for encryption)</simpara>
</listitem>
<listitem>
<simpara>check output access list</simpara>
</listitem>
<listitem>
<simpara>inspect CBAC</simpara>
</listitem>
<listitem>
<simpara>TCP intercept</simpara>
</listitem>
<listitem>
<simpara>encryption</simpara>
</listitem>
<listitem>
<simpara>Queueing</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_configure_static_translation_of_inside_source_address">
<title>Configure static translation of inside source address</title>
<screen>ip nat inside source static local-ip global-ip

interface type number
  ip address ip-address mask [secondary]
  ip nat inside

interface type number
  ip address ip-address mask
  ip nat outside</screen>
</section>
<section xml:id="_configure_dynamic_translation_of_inside_source_address">
<title>Configure dynamic translation of inside source address</title>
<screen>ip nat pool name start-ip end-ip {netmask netmask | prefix-length prefix-length}
access-list access-list-number permit source [source-wildcard]
ip nat inside source list access-list -number pool name

interface type number
  ip address ip-address mask
  ip nat inside

interface type number
  ip address ip-address mask
  ip nat outside</screen>
</section>
</section>
<section xml:id="_allow_internal_users_access_to_the_internet">
<title>Allow internal users access to the internet</title>
<screen>ip nat pool name start-ip end-ip {netmask netmask | prefix-length prefix-length}
access-list number permit a.b.c.d [e.f.g.h]
ip nat inside source list number pool name overload

interface type number
  ip address ip-address mask
  ip nat inside

interface type number
  ip address ip-address mask
  ip nat outside
end</screen>
</section>
<section xml:id="_change_timeouts_value">
<title>Change timeouts value</title>
<screen>ip nat translation seconds
ip nat translation udp-timeout seconds
ip nat translation dns-timeout seconds
ip nat translation tcp-timeout seconds
ip nat translation finrst-timeout seconds
ip nat translation icmp-timeout seconds
ip nat translation syn-timeout seconds</screen>
</section>
<section xml:id="_configure_dynamic_translation_of_overlapping_networks">
<title>Configure dynamic translation of overlapping networks</title>
<simpara>Configure dynamic translation of overlapping networks if your IP addresses in the stub network are
legitimate IP addresses belonging to another network and you want to communicate with those hosts or
routers using dynamic translation.</simpara>
<screen>ip nat pool name start-ip end-ip {netmask netmask | prefix-length prefix-length}
access-list access-list-number permit source [source-wildcard]
ip nat outside source list access-list-number pool name

interface type number
  ip address ip-address mask
  ip nat inside

interface type number
  ip address ip-address mask
  ip nat outside</screen>
</section>
<section xml:id="_server_tcp_load_balancing">
<title>Server TCP load balancing</title>
<screen>ip nat pool name start-ip end-ip {netmask netmask | prefix-length prefix-length} type rotary
access-list access-list-number permit source [source-wildcard]
ip nat inside destination-list access-list-number pool name

interface type number
  ip address ip-address mask
  ip nat inside

interface type number
  ip address ip-address mask
  ip nat outside</screen>
<formalpara>
<title>Task: Display NAT translation information</title>
<para>
<screen>show ip nat translations [verbose]
show ip nat statistics</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Clear NAT entries before the timeout</title>
<para>
<screen>clear ip nat translation inside global-ip local-ip outside local-ip global-ip
clear ip nat translation outside global-ip local-i p
clear ip nat translation protocol inside global-ip global-port local-ip local-port outside local-ip local-port-global-ip global-port
clear ip nat translation {* | [forced] | [inside global-ip local-ip] [outside local-ip global-ip]}</screen>
</para>
</formalpara>
<formalpara>
<title>Task: Enable Syslog for logging NAT translations</title>
<para>
<screen>ip nat log translations syslog
no logging console</screen>
</para>
</formalpara>
</section>
</section>
</chapter>
<chapter xml:id="_network_optimization">
<title>Network optimization</title>

</chapter>
</part>
</book>
