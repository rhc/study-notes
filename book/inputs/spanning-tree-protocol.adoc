= STP

http://www.CISCO.com/c/en/us/td/docs/switches/lan/catalyst3750x_3560x/software/release/15-0_2_se/configuration/guide/3750x_cg/swstp.html


- Creates loop-free layer 2 topology
- Prevents broadcast storms

- STP variations:
  * 802.1d : Common Spanning Tree
  * PVST/PVST+: CISCO per-VLAN Spanning Tree
  * 802.1w: Rapid Spanning Tree Protocol
  * 802.1s: Multiple STP


== 802.1d

- Uses BPDU
- Elect one root switch and one designated switch for each segment
- One root port per non-root switch, one designated port for each segment
- Other ports on blocking state

- Steps
  * Elect the root switch with the lowest bridge id ( 2-byte priority + 6-byte MAC)
  * Determine each switch's root port: with the least cost path to the root
  * Determine the designated port for each segment:
    the switch that forwards the least cost Hello on the segment
  * If there is a tie, select the lowest port ID

- Original IEEE 802.1d bridge Id

  * 2-byte priority
  * 6-byte MAC adress

- Revised IEEE 802.1d brigde id Priority for MAC address reduction

  * 4 bits : priority multiple of 4096
  * 12 bits : system id extension (vlan id ) to support pvst+ and IEEE 802.1s

image::stp-bridge-id.png[Bridge ID]

=== BPDU

//TODO
image::bpdu.png[BPDU format]

  For STP, the Protocol Identifier value is set to 0x0000 and the Protocol
  Version is also set to 0x00. The BPDU Type field identifies two kinds of STP
  BPDUs: Configuration BPDUs (type 0x00) and Topology Change Notification BPDUs
  (type 0x80). The Flags field uses 2 bits out of 8 to handle topology change
  events: the Topology Change Acknowledgment flag and the Topology Change flag.
  Following the Flags, there is a series of fields identify- ing the root bridge,
  distance of the BPDU’s sender from the root bridge, the sender bridge’s own
  identifier, and the identifier of the port on the sender bridge that forwarded
  this BPDU. The MessageAge field is an estimation of the BPDU’s age since it was
  originated by the root bridge. At the root bridge, it is set to 0. Any other
  switch will increment this value, usually by 1, before forwarding the BPDU
  further. The remaining lifetime of a BPDU after being received by a switch is
  MaxAge-MessageAge. Finally, the remaining fields carry the values of STP
  timers: MaxAge, HelloTime, ForwardDelay. These timer values always reflect the
  timer settings on the root switch. Timers configured on a nonroot switch are
  not used and would become effective only if the switch itself became the root switch.


- To determine which  BPDU out of a pair of configuration BPDUs is superior,
they are compared in the following sequence of values,
looking for the first occurrence of a lower value:
 Root Bridge ID,
 Root Path Cost,
 Sender Bridge ID,
 Sender Port ID,
 Receiver Port ID (not included in BPDU; evaluated locally)

- Each port in STP stores/remembers the superior BPDU it has either sent (DP port) or received (RP and Blocking Ports).
  Essentially, each port stores the DP’s BPDU—whether it is the port itself that is Designated or it is a neighbor’s port.
  Should a port store a received BPDU, it must be received again within a time interval of MaxAge-MessageAge seconds;
  otherwise it will expire after this period.
  This expiry is always driven by the timers in the BPDU, that is, according to timers of the root switch.

=== Root Bridge

- Election with hello BPDU

 Each switch begins its STP logic by creating and sending an Hello BPDU message,
 claiming itself to be the root switch.
 If a switch hears a superior Hello to its own Hello bridge ID,
 it stops claiming to be root by ceasing to originate and send Hellos.
 Instead, the switch starts forwarding the superior Hellos received from the superior candidate.
 Eventually, all switches except the switch with the lowest bridge ID cease to originate Hellos;
 that one switch wins the election and becomes the root switch.


.Task: Force Election Of a Root Bridge
----
# spanning-tree vlan <id> root
----

=== Root Port

- RP is upstream facing towards Root bridge
- Lowest root path cost ( cumulative cost of all links to get to the root)
  * cost = advertised cost in the BPDU hello + cost on the receiving post
- Cost based on inverse bandwith

.Default Port Costs
[format="csv"]
|====
Speed    , original , revised , 802.1D-2004

10 Mbps  , 100      , 100     , 2000000
100 Mbps , 10       , 19      , 200000
1 Gbps   , 1        , 4       , 20000
10 Gbps  , 1        , 2       , 2000
|====

.Task: Choose Default STP Path Cost (Original or Revised)
----
(config)# spanning-tree pathcost method {short | long}
----

Tie breaker when a switch receives multiple Hellos with equal cost

. Lowest Bridge Id
. Lowest Port Priority
. Lowest Port Number


=== Designated Port

- Designated switch: send the Hello with the lowest advertised cost for the segment
- DP: port that forward frames onto that segment
- DP are downstream facing away from root bridge
- Elected based on lowest root path cost, BID, port ID

=== Blocking Ports

- Receive BPDUs
- Discard all other traffic
- Cannot send traffic
- Do not send Hellos

=== Convergence

- Steady operations: one Root bridge, one RP on each non-root bridge, one DP on each segment, blocking state

. Root Switch Generates a Hello Every 2 Seconds
. Each RP on Non-Root Switch Receives a Copy Of the Root'S Hello
. Each DP Updates and Forwards the Hello Out
. Each Blocking Port Receives a Copy Of the Hello from the DP Without Forwarding It

===  Topology Change Notification

more at
http://www.CISCO.com/c/en/us/support/docs/lan-switching/spanning-tree-protocol/24062-146.html#topchng[understand new topology changes]

// split this section for 802.1d and 802.1w

. a Switch Experiencing the STP Port State Change Sends a TCN BPDU Out Its Root Port;
it repeats this message every Hello time until it is acknowledged.

. the Next Switch Receiving That TCN BPDU Sends Back an Acknowledgment Via Its Next
forwarded Hello BPDU by marking the Topology Change Acknowledgment (TCA) bit in the Hello.

. the Switch That Was the DP on the Segment In the First Two Steps Repeats the First Two Steps,
sending a TCN BPDU out its Root Port, and awaiting acknowledgment from the DP on that
segment.

By each successive switch repeating Steps 1 and 2, eventually the root receives a TCN BPDU.
Once received, the root sets the TC flag on the next several Hellos, which are forwarded to all
switches in the network, notifying them that a change has occurred. A switch receiving a Hello
BPDU with the TC flag set uses the short (Forward Delay time) timer to time out entries in the CAM.

.Transitioning from Blocking to Forwarding
[format="csv"]
|====
State      , Forward data frames , Learn source MAC , Stable?
Blocking   , No                  , No               , Yes
Listening  , No                  , No               , No
Learning   , No                  , Yes              , No
Forwarding , Yes                 , Yes              , Yes
Disabled   , No                  , No               , Yes
|====


=== Timers

Hello timer::
  - 2 seconds
  - Interval at which the root sends Hellos
- Forward delay::
  - 15 seconds
  - Time that switch leaves a port in listening state and learning state
  - also used for the short CAM timeout timer
- Maxage::
  - 20 seconds
  - Time without hearing a Hello before believing that the root has failed

=== PVST+

- Per-VLAN STP : for better load balancing
  * One instance of legacy STP per VLAN
  * CISCO ISL support

- PVST+
  * One instance of legacy STP per VLAN
  * CISCO ISL and 802.1q support
  * Interoperability between CST and PVST
  - default mode on most Catalyst platforms
  - allows root bridge/port placement per VLAN

- Non-CISCO + 802.1q => one Common Spanning Tree over vlan  1

- When mixing CISCO and non CISCO switches with 802.1q trunking,
  * Send bpdu to multicast destination MAC of 0100.0CCC.CCCD

//todo: add picture here pp. 78

.Task: Display Spanning-Tree Information
----
# sh spanning-tree root
# sh spanning-tree vlan 1 root detail
----

=== Optimizing, Improving Spanning Tree

==== PortFast

- Used on access ports connected to end users devices not other switches
- Puts the port into forwarding state immediately
- Prevent them to generate TCNs
- Can generate loops if another switch is connected. so must be used with bpdu guard and root guard features

.Task: Enable Portfast
----
(config-if)# spanning-tree portfast
(config)# spanning-tree portfast default
----

==== UplinkFast

- Used on access layer switches that have multiple uplinks to distribution/core switches
- Immediately replaces a lost RP with an alternate RP
- Increases the root and all port priority so the switch does not become root or transit switch
- Time-out the correct entries in their CAMs but doesnt use the TCN process. Instead, finds all the MAC
addresses of local devices and sends one multicast frame with each local addresses as the source MAC
causing all the other switches to update their CAMs. The access switch also clears out the rest of the
entries in its own CAM.

.Task: Enable Uplink Fast
----
(config)#  spanning-tree uplinkfast [max-update-rate rate]
----

==== BackboneFast

- Used in core switches to detect indirect link failures to the Root
- Do not wait for Maxage to expire when another switch's direct link fails
- Send a Root Link Query out the port in which the missing Hello should arrive.
The RLQ asks the neighboring switch if that neighboring switch is still receiving Hellos from the root.
IF that neighbor had a direct link failure, it can tell the original switch via another RLQ that this path to the root is lost. Once known,
the switch experiencing the indirect link failure can go ahead and converge without waiting for Axage to expire
- All switches must have backbone fast configured

----
(config)#  spanning-tree backbonefast
----

=== Bpdu Filter

- Filter BPDUs in and out


=== Bpdu Guard

- Puts a portfast enabled port into the errdisable state when a BPDU is received and shuts down the port
- The port must be manually re-enabled or it can be recovered automatically through the errdiable timeout function.
- A port configured with bpdu guard will not be put into the root-inconsistent state.

=== Loop Guard

- Prevents non-designated ports from inadvertently forming layer 2 switching loops
if the flow of bpdus is interrupted.
- Puts the port into the loop-inconsistent state when the steady flow of BPDUs is interrupted
- Only used on point-to-point links
- Can be used with *UDLD aggressive mode* to get extra protection.

=== Root Guard

//todo: check command show spanning-tree inconsistentports

- Prevent a port from becoming a root port when receiving a superior bpdu (e.g. inferior priority + mac)
- It is enabled on ports other than the root  port and on switches other than the root.
- Puts the port in *root-inconsistent* state (no data flow) until it stops receiving superior BPDUs.
  No traffic is forwarded.

- Enforce the root bridge placement by ensuring the the port on which root guard is enabled is the designated port.

http://www.cisco.com/c/en/us/support/docs/lan-switching/spanning-tree-protocol/10588-74.html

- Enforce the root bridge placement
- Ensures that the port on which root guard is enabled is the designated port.

Loop Guard:::
When normal BPDUs are no longer received,
the port does not go through normal STP convergence, but rather falls into an STP loop-inconsistent state.

In all cases, the formerly blocking port that would now cause a loop is prevented from migrating
to a forwarding state. With both types of UDLD, the switch can be configured to automatically
transition out of err-disabled state. With Loop Guard, the switch automatically puts the port back
into its former STP state when the original Hellos are received again.

== 802.1w Rapid STP

- Improves convergence by

** Waiting for only 3 missed Hellos on an RP before flushing the CAM instead of 10 with 802.1d
** Bypass listening state
** Includes natively CISCO PortFast, UplinkFast, BackboneFast
** Add backup DP when multiple ports connected to the same segment

- Backward compatible with 802.1d

- All bridges generate BPDUs every Hello interval

- Use a single BPDU
** No TCN BPDU
** Protocol version = 0x02
** The Flags field has been updated. In 802.1D STP BPDUs, only 2 bits out of 8 are used: TC (Topology Change) and TCA (Topology Change Acknowledgment). RSTP uses the
6 remaining bits as well to encode additional information: Proposal bit, Port Role bits, Learning bit, Forwarding bit, and Agreement bit. The TCA bit is not used by RSTP. This change allows implementing the Proposal/Agreement mechanism and also allows a BPDU to carry information about the originating port’s role and state, forming the basis of RSTP’s Dispute mechanism, protecting against issues caused by unidirectional links.


=== RSTP Link Types

- *Point-to-point*: Switch to Switch (default if full-duplex port )
- *Shared* : Switch to hub (default if half-duplex port)
- *Edge*: Switch to single end-user device

.Task: Set the RSTP Link-Type
----
spanning-tree link-type { point-to-point | shared }
----

=== RSTP Port Types

- *Edge* :
- *Non-Edge*: default

=== RSTP Port States

- Default to discarding at start

[format="csv", options="header"]
|===
Administrative state , 802.1d     , 802.1w
Disabled             , Disabled   , Discarding
Enabled              , Blocking   , Discarding
Enabled              , Listening  , Discarding
Enabled              , Learning   , Learning
Enabled              , Forwarding , Forwarding
|===

=== RSTP Port Roles

[horizontal]

Root Port::
- Same role as 802.1d RP

Designated Port::
- Same role as 802.1d DP
- Default role at boot

Alternate Port::
- An alternate root port
- Same concept as CISCO UplinkFast feature
- Protects against the loss of a switch's RP by keeping track of the AP with a path to the root

Backup Port::
- No equivalent CISCO feature
- Protects against losing the DP attached to a shared liknk
  when the switch has another physical port attached to the same shared segment

NOTE: root bridge ports are all designated port
unless 2 or more ports of the root bridge are connected together.

NOTE: a port needs to receive BPDUs to stay blocked.

.Task: Configure Rapid PVST
----
(config)#  spanning-tree mode rapid-pvst
----
[NOTE]
====
- Rapid PVST+ immediately deletes dynamically learned MAC address entries
  when it receives a topology change instead of a timer used by PVST+ or MST
====

=== Proposal/Agreement

TODO See 5th Edition

=== Topology Change Handling

TODO See 5th Edition





== 802.1s Multiple Spanning Trees

- Multiple VLANs mapped to the same STP instance.
- Enable load balancing
- Improves fault tolerance of the network
  because a failure in one instance or forwarding path does not affect other instances.
- Uses 802.1w for rapid convergence
- Highly scalable
  * Switches with same instance, configuration revision number and name form a *region*
  * Different regions see each other as virtual bridges
- Each switch have three attributes:
  * Alphanumeric configuration name (32 bytes)
  * Configuration number (2 bytes)
  * 4096-element table that associates each of the potential 4096 VLANs to a map ???

=== MST Region

=== MST Revision Number

=== MST Instance

== Protecting Against Unidirectional Link Issues


=== UDLD

// Read more in the udld file

- Unidirectional links:
  * One of the 2 transmission path has failed but not both
  * Due to miscabling, cutting on fiber cable, unplugging one fiber, GBIC problems, ...
  * Can cause a loop as the previously blocking port will move to a forwarding state

image::stp-unidirectional-links.png[height=150]

- Solutions:

UDLD **u**ni**d**irectional **l**ink **d**etection:::
Uses Layer 2 messaging to decide when a switch can no longer receive frames from a neighbor.
The switch whose transmit interface did not fail is placed into an err-disabled state.

UDLD aggressive mode:::
Attempts to reconnect with the other switch (eight times) after realizing no messages have been received.
If the other switch does not reply to the repeated additional messages,
both sides become err-disabled.


=== Bridge Assurance

  The Bridge Assurance, applicable only with RPVST+ and MST and only on
  point-to-point links, is a further extension of the idea used by Loop Guard.
  Bridge Assurance modi- fies the rules for sending BPDUs. With Bridge Assurance
  activated on a port, this port always sends BPDUs each Hello interval, whether
  it is Root, Designated, Alternate, or Backup. BPDUs thus essentially become a
  Hello mechanism between pairs of intercon- nected switches. A Bridge
  Assurance–protected port is absolutely required to receive BPDUs. If no BPDUs
  are received, the port will be but into a BA-inconsistent block- ing state
  until it starts receiving BPDUs again. Apart from unidirectional links, Bridge
  Assurance also protects against loops caused by malfunctioning switches that
  completely stop participating in RPVST+/MST (entirely ceasing to process and
  send BPDUs) while opening all their ports. At the time of this writing, Bridge
  Assurance was supported on selected Catalyst 6500 and Nexus 7000 platforms.
  Configuring it on Catalyst 6500 Series requires activating it both globally
  using spanning-tree bridge assurance and on ports on STP point-to-point link
  types toward other switches using the spanning-tree portfast network interface
  command. The neighboring device must also be configured for Bridge Assurance.

=== Dispute Mechanism

  The Dispute mechanism is yet another and standardized means to detect a
  unidirectional link. Its functionality is based on the information encoded in
  the Flags field of RST and MST BPDUs, namely, the role and state of the port
  forwarding the BPDU. The principle of operation is very simple: If a port
  receives an inferior BPDU from a port that claims to be Designated Learning or
  Forwarding, it will itself move to the Discarding state. Cisco has also
  implemented the Dispute mechanism into its RPVST+. The Dispute mechanism is not
  available with legacy STP/PVST+, as these STP versions do not encode the port
  role and state into BPDUs. The Dispute mechanism is an integral part of
  RSTP/MST and requires no configuration.

=== Storm Control

=== Unicast Flooding

== Troubleshooting

=== Flapping Port That Is Generating BPDUs with the TCN Bit Set








